const sounds={disabled:false,initializing:false,initialized:false,soundsLoaded:false,LOCATION:"/assets/sounds",sounds:{cursorUp:{path:"cursor-up.mp3",require:["master"]},cursorDown:{path:"cursor-down.mp3",require:["master"]},checkOff:{path:"check-off.mp3",require:["btnClick"]},checkOn:{path:"check-on.mp3",require:["btnClick"]},confirm:{path:"generic-confirm.mp3",require:["others"]},confirm2:{path:"generic-confirm-2.mp3",require:["others"]},confirm3:{path:"generic-confirm-3.mp3",require:["others"]},hover:{path:"generic-hover.mp3",require:["mouseOver"],volume:0.4},hoverSoft:{path:"generic-hover-soft.mp3",require:["mouseOver"]},notification:{path:"notification.mp3",require:["notification"]},overlayPopIn:{path:"overlay-pop-in.mp3",require:["panelToggle"]},overlayPopOut:{path:"overlay-pop-out.mp3",require:["panelToggle"]},select:{path:"generic-select.mp3",require:["btnClick"]},selectSoft:{path:"generic-select-soft.mp3",require:["btnClick"]},valueChange:{path:"generic-value-change.mp3",require:["others"]},sliderHigh:{path:"slider-high.mp3",require:["others"]},sliderLow:{path:"slider-low.mp3",require:["others"]},sliderSlide:{path:"slider-slide.mp3",require:["others"]},warning:{path:"generic-warning.mp3",require:["others"]},},enable:{master:false,mouseOver:true,btnClick:true,panelToggle:true,others:true,notification:true,},volume:0.6,async init(set=({p,m,d,c})=>{},{clog=window.clog}={}){if(this.initializing){clog("DEBG","Sounds is initializing!");return;}
this.initializing=true;if(/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream){clog("WARN","Sounds does not support on iPhone devices, disabling...");localStorage.setItem(`sounds.master`,false);this.disabled=true;this.initializing=false;return false;}
set({p:0,m:"sounds",d:`Getting Default Sound Settings`});for(let key of Object.keys(this.enable)){let value=localStorage.getItem(`sounds.${key}`);if(value===null){value=this.enable[key];localStorage.setItem(`sounds.${key}`,value);}else
value=(value=="true")
this.enable[key]=value;}
if(!this.enable.master){set({p:100,m:"sounds",d:"Stopped Loading Sounds"});clog("INFO","Master Disabled! Stopped Loading Sounds");clog("DEBG","To enable sounds please set sounds.enable.master to true and call sounds.init() again");this.initializing=false;return false;}
set({p:10,m:"sounds",d:"Loading Sounds"});await this.loadSound((p,t,c)=>{set({p:10+p*0.85,m:"sounds",d:`Loading: ${t}`,c});},{clog});set({p:90,m:"sounds",d:"Scanning"});this.scan();set({p:95,m:"sounds",d:"Attaching Default Events"});window.addEventListener("mousedown",()=>this.soundToggle(this.sounds.cursorDown));window.addEventListener("mouseup",()=>this.soundToggle(this.sounds.cursorUp));set({p:100,m:"sounds",d:"Done"});this.initialized=true;this.initializing=false;clog("OKAY","Initialised:",{color:flatc("red"),text:"sounds"});},async loadSound(set=(p,t,c)=>{},{clog=window.clog}={}){if(this.disabled)
throw{code:-1,description:"Sounds Module Disabled"}
let totalSize=0;let keys=Object.keys(this.sounds);for(let i=0;i<keys.length;i++){let key=keys[i]
let item=this.sounds[key]
set((i/(keys.length-1))*100,key,`Đang tải ${i + 1}/${keys.length} (${convertSize(totalSize)})`);this.sounds[key].sound=await this.__loadSoundAsync(`${this.LOCATION}/${item.path}`,item.volume||0.6,{clog});if(this.sounds[key].sound.webkitAudioDecodedByteCount)
totalSize+=this.sounds[key].sound.webkitAudioDecodedByteCount*8;set(((i+1)/(keys.length-1))*100,key,`Đã tải ${i + 1}/${keys.length} (${convertSize(totalSize)})`);}
this.soundsLoaded=true;},async __loadSoundAsync(url,volume=0.6,{clog=window.clog}={}){if(this.disabled)
throw{code:-1,description:"Sounds Module Disabled"}
let sound=new Audio();sound.src=(typeof chrome!=="undefined"&&chrome.extension)?chrome.extension.getURL(url):url;clog("DEBG",`Loading sound: ${url}`);return new Promise((resolve,reject)=>{sound.addEventListener("canplaythrough",handler=()=>{sound.removeEventListener("canplaythrough",handler);sound.volume=volume;clog("DEBG",`Sound loaded: ${url}`);resolve(sound);});sound.addEventListener("error",e=>{clog("ERRR",`Error loading sound: ${url}`,e);reject({code:-1,description:`Error loading sound: ${url}`,data:e});})})},soundToggle(sound){sound=(typeof sound==="string"&&this.sounds[sound]&&this.sounds[sound].sound)?this.sounds[sound]:sound;if(!this.enable.master||!sound||!sound.sound||sound.sound.readyState<3||!this.initialized)
return false;for(let key of sound.require)
if(!this.enable[key])
return false;if(!sound.sound.paused)
sound.sound.pause();sound.sound.volume=this.volume;sound.sound.currentTime=0;sound.sound.play().catch(e=>clog("ERRR","An error occurred while trying to play sounds",e));},select(variation=0){if(this.disabled||!this.initialized)
return;let sound=[this.sounds.select,this.sounds.selectSoft][variation]
this.soundToggle(sound);},confirm(variation=0){if(this.disabled||!this.initialized)
return;let sound=[this.sounds.confirm,this.sounds.confirm2,this.sounds.confirm3][variation]
this.soundToggle(sound);},toggle(variation=0){if(this.disabled||!this.initialized)
return;let sound=[this.sounds.overlayPopIn,this.sounds.overlayPopOut][variation]
if(this.enable.others)
this.soundToggle(sound);},notification(){if(this.disabled||!this.initialized)
return;if(this.enable.notification)
this.soundToggle(this.sounds.notification);},slider(variation=0){if(this.disabled||!this.initialized)
return;let sound=[this.sounds.sliderSlide,this.sounds.sliderHigh,this.sounds.sliderLow][variation]
if(this.enable.others)
this.soundToggle(sound);},warning(){if(this.disabled||!this.initialized)
return;if(this.enable.others)
this.soundToggle(this.sounds.warning);},scan(){if(this.disabled)
throw{code:-1,description:"Sounds Module Disabled"}
const list=document.getElementsByClassName("sound");for(var item of list){if(typeof item.dataset==="undefined"){clog("DEBG",`sounds.scan(): Unknown element: ${e}`);continue;}
this.applySound(item);}
return true;},applySound(item,flags){if(!item.nodeType||item.nodeType<=0||item.dataset.soundApplied||this.disabled)
return false;if(flags&&typeof flags==="object"&&flags.length)
for(let flag of flags)
item.dataset[flag]=true;if(typeof item.dataset.soundhover!=="undefined")
item.addEventListener("mouseenter",(e)=>e.isTrusted?this.soundToggle(this.sounds.hover):0);if(typeof item.dataset.soundhoversoft!=="undefined")
item.addEventListener("mouseenter",(e)=>e.isTrusted?this.soundToggle(this.sounds.hoverSoft):0);if(typeof item.dataset.soundselect!=="undefined")
item.addEventListener("mouseup",(e)=>e.isTrusted?this.soundToggle(this.sounds.select):0);if(typeof item.dataset.soundselectsoft!=="undefined")
item.addEventListener("mouseup",(e)=>e.isTrusted?this.soundToggle(this.sounds.selectSoft):0);if(typeof item.dataset.soundchange!=="undefined")
item.addEventListener("change",(e)=>e.isTrusted?this.soundToggle(this.sounds.sliderSlide):0);if(typeof item.dataset.soundcheck!=="undefined")
item.addEventListener("change",(e)=>{if(!e.isTrusted)
return;if(e.target.checked===true)
this.soundToggle(this.sounds.checkOn);else
this.soundToggle(this.sounds.checkOff);})
if(typeof item.dataset.soundtoggle==="string")
new ClassWatcher(item,item.dataset.soundtoggle,()=>this.soundToggle(this.sounds.overlayPopIn),()=>this.soundToggle(this.sounds.overlayPopOut));item.dataset.soundApplied=true;}}
const tooltip={initialized:false,container:HTMLDivElement.prototype,content:HTMLDivElement.prototype,prevData:null,hideTimeout:null,fixedWidth:false,showing:false,showTime:100,scanDelay:500,nodeToShow:null,hooks:[],__currentHook:null,__sizeObserving:false,__wait:false,__scanTimeout:undefined,processor:{dataset:{process(target,key){if(typeof target.dataset[key]==="string")
return target.dataset[key];return null;},attach(hook,target){let targets=(target||document).querySelectorAll(`[data-${hook.key}]:not([data-tooltip-checked])`);for(let target of targets)
tooltip.attachEvent(target,hook);}},attribute:{process(target,key){return target.getAttribute(key);},attach(hook,target){let targets=(target||document).querySelectorAll(`[${hook.key}]:not([data-tooltip-checked])`);for(let target of targets)
tooltip.attachEvent(target,hook);}}},init(container){if(checkAgentMobile()){clog("WARN","tooltip: this module will be disabled on mobile device due to performance reason. Initialize aborted.");return false;}
this.container=document.createElement("div");this.container.classList.add("tooltip","hide");this.content=document.createElement("div");this.content.classList.add("content");this.content.setAttribute("style","");this.container.append(this.content);document.body.insertBefore(this.container,document.body.childNodes[0]);new MutationObserver((records)=>{clearTimeout(this.__scanTimeout);this.__scanTimeout=setTimeout(()=>this.scan(),this.scanDelay);}).observe(container||document.body,{childList:true,subtree:true,attributes:false});if(typeof ResizeObserver==="function"){new ResizeObserver(()=>{this.container.style.width=this.content.clientWidth+"px";this.container.style.height=this.content.clientHeight+"px";}).observe(this.content);this.__sizeObserving=true;}
this.addHook({on:"dataset",key:"tip"});this.addHook({on:"attribute",key:"tooltip"});this.addHook({on:"attribute",key:"title",handler:({target,value})=>{let actualValue=target.getAttribute("tooltip");if(!actualValue){target.setAttribute("tooltip",value);target.removeAttribute("title");actualValue=value;}
return actualValue;}});this.initialized=true;},addHook({on=null,key=null,handler=({target,value,update})=>value,destroy=()=>{},priority=1,noPadding=false}={}){if(typeof on!=="string"||typeof this.processor[on]!=="object")
throw{code:-1,description:`tooltip.addHook(): \"on\": unexpected '${on}', expecting 'dataset'/'attribute'`}
if(typeof key!=="string")
throw{code:-1,description:`tooltip.addHook(): \"key\" is not a valid string`}
if(typeof handler!=="function")
throw{code:-1,description:`tooltip.addHook(): \"handler\" is not a valid function`}
if(typeof destroy!=="function")
throw{code:-1,description:`tooltip.addHook(): \"destroy\" is not a valid function`}
if(typeof priority!=="number")
throw{code:-1,description:`tooltip.addHook(): \"priority\" is not a valid number`}
if(typeof noPadding!=="boolean")
throw{code:-1,description:`tooltip.addHook(): \"noPadding\" is not a valid boolean`}
let hook={on,key,handler,destroy,priority,noPadding};this.hooks.push(hook);this.hooks.sort((a,b)=>(a.priority<b.priority)?1:(a.priority>b.priority)?-1:0);this.processor[on].attach(hook);},scan(target){for(let hook of this.hooks)
this.processor[hook.on].attach(hook,target);},getValue(target,hook){if(!target.style||!target.tagName)
return null;if(typeof this.processor[hook.on]!=="object")
return null;return this.processor[hook.on].process(target,hook.key);},attachEvent(target,hook){let hooks=(typeof hook==="object")?[hook]:this.hooks;for(let hook of hooks){if(this.getValue(target,hook)===null)
continue;if(target.dataset.tooltipListening){clog("DEBG",`tooltip.attachEvent(${hook.on} ${hook.key}): target already listening`,target);break;}
target.addEventListener("mouseenter",()=>{let value=this.getValue(target,hook);let showValue=hook.handler({target,value,update:(data)=>this.update(data)});if(showValue)
this.show(showValue,target,hook.noPadding,hook);});target.dataset.tooltipListening=true;break;}
target.dataset.tooltipChecked=true;},mouseMove(event,forceUpdate=false){if(!forceUpdate&&this.container.classList.contains("hide"))
return;let maxX=window.innerWidth-this.content.clientWidth-15;let xPos=Math.min(event.clientX+10,maxX);let yPos=event.clientY+15;this.container.style.transform=`translate(${xPos}px, ${yPos}px)`;},__mouseMove:(e)=>{if(!tooltip.__wait){tooltip.__wait=true;tooltip.mouseMove(e);setTimeout(()=>tooltip.__wait=false,50);}},__mouseLeave:()=>tooltip.hide(),async show(data,showOnNode,noPadding=false,hook=null){if(!this.initialized)
return false;if(this.nodeToShow)
this.nodeToShow.removeEventListener("mouseleave",this.__mouseLeave);if(showOnNode&&showOnNode.tagName){this.nodeToShow=showOnNode;this.nodeToShow.addEventListener("mouseleave",this.__mouseLeave);}
clearTimeout(this.hideTimeout);this.hideTimeout=null;if(!this.showing){window.addEventListener("mousemove",this.__mouseMove,{passive:true});this.mouseMove({clientX:mouseCursor.x,clientY:mouseCursor.y},true);await nextFrameAsync();}
this.container.classList.remove("hide");this.showing=true;this.fixedWidth=false;await nextFrameAsync();this.container.classList.add("show");this.content.dataset.noPadding=noPadding;this.__currentHook=hook;this.update(data);return true;},update(data){switch(typeof data){case"object":if(data.classList&&data.dataset){emptyNode(this.content);this.content.append(data);break;}
this.content.innerText=JSON.stringify(data,null,4);break;default:this.content.innerHTML=data;break;}
this.container.style.animation="none";requestAnimationFrame(()=>{this.container.style.animation=null;if(!this.__sizeObserving){this.container.style.width=this.content.clientWidth+"px";this.container.style.height=this.content.clientHeight+"px";}});},async hide(){if(tooltip.__currentHook){tooltip.__currentHook.destroy();tooltip.__currentHook=null;}
if(!this.hideTimeout)
this.hideTimeout=setTimeout(()=>{if(this.nodeToShow)
this.nodeToShow.removeEventListener("mouseleave",this.__mouseLeave);this.nodeToShow=null;this.prevData=null;this.container.classList.remove("show");this.hideTimeout=setTimeout(()=>{this.container.classList.add("hide");this.fixedWidth=false;this.content.style.width=null;window.removeEventListener("mousemove",this.__mouseMove);this.showing=false;},300);},this.showTime);}}
class Scrollable{constructor(container,{content,distance=1,velocity=2,clamp=20,maxClamp=400,horizontal=false,smooth=true,overrideScroll=true,scrollbar=true,scrollout=false,barSize=10}={}){if(typeof container!=="object"||(!container.classList&&!container.container))
throw{code:-1,description:`Scrollable(): container is not a valid node`}
if(content){this.container=container;this.content;switch(typeof content){case"object":this.content=content;break;default:this.content=document.createElement("div");this.content.innerHTML=content;break;}
if(!this.container.contains(this.content))
this.container.appendChild(this.content);}else{this.container=document.createElement("div");this.container.id=container.id;container.parentElement.replaceChild(this.container,container);this.content=container;this.content.removeAttribute("id");this.container.appendChild(this.content);}
this.container.classList.add("scrollable");this.content.classList.add("content");this.content.clampValue=0;this.vBar=buildElementTree("div",["scrollbar","vertical"],[{type:"div",class:"thumb",name:"thumb"}]).obj;this.hBar=buildElementTree("div",["scrollbar","horizontal"],[{type:"div",class:"thumb",name:"thumb"}]).obj;this.container.insertBefore(this.hBar,this.container.firstChild);this.container.insertBefore(this.vBar,this.container.firstChild);this.distance=distance;this.velocity=velocity;this.clamp=clamp;this.maxClamp=maxClamp;this.currentVelocity=0;this.currentClampV=0;this.currentClampH=0;this.vHideTimeout=null;this.hHideTimeout=null;this.smooth=smooth;this.overrideScroll=overrideScroll;this.scrollbar=scrollbar;this.barSize=barSize;this.horizontal=horizontal;this.dragInit=false;this.animator=null;this.disabled=false;this.ticking=false;this.clamping=false;this.scrollout=scrollout;this.content.addEventListener("scroll",(e)=>this.updateScrollbar(e));this.content.addEventListener("wheel",(event)=>{if(event.ctrlKey||!this.overrideScroll)
return;if(Math.abs(event.deltaY)<100&&this.smooth)
return;let contentScrollable=true;if(!this.scrollout&&!this.smooth){let delta=(this.horizontal)?event.deltaX:event.deltaY;let from=(this.horizontal)?this.content.scrollLeft:this.content.scrollTop;let maxScroll=(this.horizontal)?this.content.scrollWidth-this.content.offsetWidth:this.content.scrollHeight-this.content.offsetHeight;contentScrollable=maxScroll>0&&(this.smooth||delta>0&&from<maxScroll)||(delta<0&&from>0);}
if(contentScrollable){event.stopPropagation();event.preventDefault();if(!this.ticking){requestAnimationFrame(()=>{if(this.smooth)
this.animationUpdate({event});else
this.update({event});this.ticking=false;});this.ticking=true;}}},{passive:false});new ResizeObserver(()=>{this.updateScrollbarPos();this.updateScrollbar();}).observe(this.content);new MutationObserver(()=>this.updateObserveList()).observe(this.content,{childList:true});this.updateObserveList();}
initDrag(){if(this.dragInit)
return;this.cRel={x:0,y:0}
this.sTicking=false;this.vThumbDragging=false;this.hThumbDragging=false;this.__dragStartV=(e)=>this.dragStart(e,false);this.__dragStartH=(e)=>this.dragStart(e,true);this.__dragUpdate=(e)=>this.dragUpdate(e);this.__dragEnd=()=>this.dragEnd();this.vBar.thumb.addEventListener("mousedown",this.__dragStartV);this.hBar.thumb.addEventListener("mousedown",this.__dragStartH);window.addEventListener("mouseup",this.__dragEnd);this.dragInit=true;}
cleanDrag(){if(!this.dragInit)
return;this.vBar.thumb.removeEventListener("mousedown",this.__dragStartV);this.hBar.thumb.removeEventListener("mousedown",this.__dragStartH);window.removeEventListener("mouseup",this.__dragEnd);this.dragInit=false;}
dragStart(e,horizontal=false){e.preventDefault();this.vThumbDragging=!horizontal;this.hThumbDragging=horizontal;window.addEventListener("mousemove",this.__dragUpdate);let r=e.target.getBoundingClientRect();this.cRel.x=e.clientX-r.left;this.cRel.y=e.clientY-r.top;}
dragUpdate(e){if(!this.vThumbDragging&&!this.hThumbDragging)
return;e.preventDefault();if(!this.sTicking){requestAnimationFrame(()=>{let horizontal;let value;if(this.vThumbDragging){let r=this.vBar.getBoundingClientRect();let t=this.vBar.thumb.getBoundingClientRect();let top=r.top+this.cRel.y;let bottom=(r.top+r.height)-(t.height-this.cRel.y);let cVal=clamp((e.clientY-top)/(bottom-top),0,1);value=(this.content.scrollHeight-this.content.offsetHeight)*cVal;horizontal=false;}
if(this.hThumbDragging){let r=this.hBar.getBoundingClientRect();let t=this.hBar.thumb.getBoundingClientRect();let left=r.left+this.cRel.x;let right=(r.left+r.width)-(t.width-this.cRel.x);let cVal=clamp((e.clientX-left)/(right-left),0,1);value=(this.content.scrollWidth-this.content.offsetWidth)*cVal;horizontal=true;}
if(typeof horizontal==="boolean")
this.update({value,horizontal});this.sTicking=false;});this.sTicking=true;}}
dragEnd(){this.vThumbDragging=false;this.hThumbDragging=false;window.removeEventListener("mousemove",this.__dragUpdate);}
updateObserveList(){for(let e of this.content.children){if(e.getAttribute("observing"))
continue;e.setAttribute("observing","true");new ResizeObserver(async()=>{await nextFrameAsync();this.updateScrollbar();}).observe(e);}}
set scrollbar(enable){if(typeof enable!=="boolean")
throw{code:-1,description:`Scrollable.scrollbar: not a valid boolean`}
this.__scrollbar=enable;if(enable){this.container.classList.add("scrollbar");this.initDrag();}else{this.container.classList.remove("scrollbar");this.cleanDrag();}}
get scrollbar(){return this.__scrollbar;}
set barSize(size){this.__barSize=size;this.container.style.setProperty("--scrollbar-size",`${size}px`);}
get barSize(){return this.__barSize;}
updateScrollbar(){if(!this.scrollbar)
return;let t=this.content;let r={width:t.offsetWidth,height:t.offsetHeight,sWidth:t.scrollWidth+Math.abs(this.currentClampH),sHeight:t.scrollHeight+Math.abs(this.currentClampV)}
let s={width:this.hBar.getBoundingClientRect().width,height:this.vBar.getBoundingClientRect().height}
let top=t.scrollTop;let left=t.scrollLeft;let width=r.sWidth-r.width-Math.abs(this.currentClampH);let height=r.sHeight-r.height-Math.abs(this.currentClampV);let tWidth=(r.width/r.sWidth)*s.width;let tHeight=(r.height/r.sHeight)*s.height;if(r.height<r.sHeight){clearTimeout(this.vHideTimeout);this.vBar.classList.remove("hide","none");this.vBar.thumb.style.height=`${tHeight}px`;this.vBar.thumb.style.top=`${(top / height) * (s.height - tHeight)}px`;}else if(!this.clamping){this.vBar.classList.add("hide");this.vHideTimeout=setTimeout(()=>this.vBar.classList.add("none"),1000);}
if(r.width<r.sWidth){clearTimeout(this.hHideTimeout);this.hBar.classList.remove("hide","none");this.hBar.thumb.style.width=`${tWidth}px`;this.hBar.thumb.style.left=`${(left / width) * (s.width - tWidth)}px`;}else if(!this.clamping){this.hBar.classList.add("hide");this.hHideTimeout=setTimeout(()=>this.hBar.classList.add("none"),1000);}}
toBottom(){let maxScroll=this.content.scrollHeight-this.content.offsetHeight;if(this.smooth)
this.animationUpdate({value:maxScroll,horizontal:false});else
this.update({value:maxScroll,horizontal:false});}
updateScrollbarPos(){this.vBar.style.top=`${this.content.offsetTop}px`;this.vBar.style.bottom=`${this.container.offsetHeight - this.content.offsetTop - this.content.offsetHeight}px`;this.hBar.style.left=`${this.content.offsetLeft}px`;this.hBar.style.right=`${this.container.offsetWidth - this.content.offsetLeft - this.content.offsetWidth + this.barSize}px`;}
update({event,value,horizontal=this.horizontal}={}){let from=(horizontal)?this.content.scrollLeft:this.content.scrollTop;let delta;if(event)
delta=event.deltaY;else
delta=value-from;if(delta===0||this.disabled)
return;let maxScroll=(horizontal)?this.content.scrollWidth-this.content.offsetWidth:this.content.scrollHeight-this.content.offsetHeight;this.content[horizontal?"scrollLeft":"scrollTop"]=Math.min(maxScroll,from+delta);}
animationUpdate({event,value,horizontal=this.horizontal,clamping=true}={}){let from=(horizontal)?this.content.scrollLeft:this.content.scrollTop;let delta;if(event)
delta=event.deltaY;else
delta=value-from;if(delta===0||this.disabled)
return;let maxScroll=(horizontal)?this.content.scrollWidth-this.content.offsetWidth:this.content.scrollHeight-this.content.offsetHeight;this.currentVelocity+=(delta>0)?this.velocity:-this.velocity;let startVelocity=this.currentVelocity;let to=from+((this.distance*Math.abs(delta))*this.currentVelocity);let clampPoint;let clampFrom;let clampTo;if(this.animator){this.animator.cancel();this.animator=null;}
this.animator=new Animator(.6,Easing.OutQuart,(t)=>{let current=from+(to-from)*t;this.currentVelocity=startVelocity*(1-t);if((current>maxScroll||current<0)){if(!clamping)
return false;if(!clampPoint){clampPoint=t;clampFrom=this.content.clampValue;clampTo=clampFrom+(this.clamp*-(this.currentVelocity*((1-(clampFrom/this.maxClamp))/2)));if(current>maxScroll){this.content[horizontal?"scrollLeft":"scrollTop"]=maxScroll;clampTo=Math.max(clampTo,-this.maxClamp);}else if(current<0){this.content[horizontal?"scrollLeft":"scrollTop"]=0;clampTo=Math.min(clampTo,this.maxClamp);}}
let c=(t-clampPoint)/(1-clampPoint);t=((c<0.5)?2*c:(-2*c+2));if(c>=0.5&&clampFrom!==0)
clampFrom=0;let clampValue=clampFrom+(clampTo-clampFrom)*t;this.content.style.transform=(horizontal)?`translateX(${clampValue}px)`:`translateY(${clampValue}px)`;if(this.horizontal)
this.currentClampH=clampValue;else
this.currentClampV=clampValue;this.updateScrollbar();this.content.clampValue=clampValue;this.clamping=true;}else{this.content.style.transform=null;this.content.clampValue=0;this.content[horizontal?"scrollLeft":"scrollTop"]=current;this.clamping=false;}});this.animator.onComplete(()=>this.animator=null);}
scrollTo(top=0,{duration=0.6,timing=Easing.OutQuart}={}){return new Promise((resolve)=>{let begin=this.content.scrollTop;new Animator(duration,timing,(t)=>{let c=begin+(top-begin)*t;this.content.scrollTop=c;}).onComplete(()=>resolve());});}
get scrollTop(){return this.content.scrollTop;}}
const wavec={container:undefined,layer:undefined,active:[],init(container){if(typeof container!=="object"||!container.classList||!container.parentElement)
throw{code:-1,description:`wavec.init(): container is not a valid node`}
this.container=container;this.container.classList.add("waveContainer","hide");this.layer=document.createElement("div");this.layer.classList.add("layer");this.layer.addEventListener("click",()=>(this.active.length>0)?this.active[this.active.length-1].hide():"");this.container.appendChild(this.layer);}}
class WaveContainer{constructor(content,{color="default",icon,title,full=false}={}){this.toggleHandlers=[]
this.reloadHandlers=[]
this.scrollable=[]
this.container=makeTree("div",["container","hide"],{wave:{tag:"div",class:"wave",html:`<span></span>`.repeat(4)},contentBox:{tag:"div",class:"contentBox",child:{loading:new LoadingOverlay(),header:{tag:"div",class:"header",child:{icon:{tag:"icon"},titleNode:{tag:"t",class:"title",text:title||"sample container"},buttons:{tag:"span",class:"buttons",child:{close:{tag:"icon",class:"close"},reload:{tag:"icon",class:"reload"}}}}},content:{tag:"div",class:"content"}}}});if(full)
this.container.classList.add("full");this.container.dataset.color=color;if(icon||title){this.container.contentBox.header.icon.dataset.icon=icon||"circle";this.container.contentBox.header.buttons.close.dataset.icon="close";this.container.contentBox.header.buttons.reload.dataset.icon="reload";this.container.contentBox.header.buttons.reload.style.display="none";if(typeof sounds==="object"){sounds.applySound(this.container.contentBox.header.buttons.close,["soundhoversoft","soundselectsoft"]);sounds.applySound(this.container.contentBox.header.buttons.reload,["soundhoversoft","soundselectsoft"]);}}else{this.container.contentBox.header.style.display="none";}
if(typeof Scrollable==="function"){this.scrollable=new Scrollable(this.container.contentBox,{content:this.container.contentBox.content});}
this.content=content;this.showing=false;this.stackPos=null;this.hideTimeout=null;this.container.contentBox.header.buttons.reload.addEventListener("click",()=>{for(let f of this.reloadHandlers){try{f();}catch(e){clog("WARN",`WaveContainer(): an error occured while handing reload listeners`,e);continue;}}});this.container.contentBox.header.buttons.close.addEventListener("click",()=>this.hide());}
set({color=undefined,icon=undefined,title=undefined}={}){if(color)
this.container.dataset.color=color;if(icon){this.container.contentBox.header.icon.dataset.icon=icon;this.container.contentBox.header.style.display=null;}
if(title){this.container.contentBox.header.titleNode.innerText=title;this.container.contentBox.header.style.display=null;}}
onToggle(f){if(typeof f!=="function")
throw{code:-1,description:`WaveContainer().onToggle(): not a valid function`}
return this.toggleHandlers.push(f);}
onReload(f){if(typeof f!=="function")
throw{code:-1,description:`WaveContainer().onReload(): not a valid function`}
this.container.contentBox.header.buttons.reload.style.display=null;return this.reloadHandlers.push(f);}
onScroll(f){if(typeof f!=="function")
throw{code:-1,description:`WaveContainer().onScroll(): not a valid function`}
this.container.contentBox.content.addEventListener("scroll",(e)=>f(e))}
show(){if(this.showing)
return;clearTimeout(this.hideTimeout);this.showing=true;wavec.container.classList.remove("hide");this.container.classList.remove("hide");wavec.container.appendChild(this.container);this.stackPos=wavec.active.push(this)-1;this.container.style.zIndex=this.stackPos;if(typeof sounds==="object")
sounds.toggle();for(let f of this.toggleHandlers){try{f(true);}catch(e){clog("WARN",`WaveContainer().show(): an error occured while handing toggle listeners`,e);continue;}}
requestAnimationFrame(()=>{this.container.classList.add("show");wavec.layer.classList.add("show");});}
async hide(){if(!this.showing)
return;clearTimeout(this.hideTimeout);this.showing=false;if(typeof sounds==="object")
sounds.toggle(1);await nextFrameAsync();this.container.classList.remove("show");wavec.active.splice(this.stackPos,1);if(wavec.active.length===0)
wavec.layer.classList.remove("show");for(let f of this.toggleHandlers){try{f(false);}catch(e){clog("WARN",`WaveContainer().show(): an error occured while handing toggle listeners`,e);continue;}}
this.hideTimeout=setTimeout(()=>{this.container.classList.add("hide");wavec.container.removeChild(this.container);if(wavec.active.length===0)
wavec.container.classList.add("hide");},1050);}
toggle(){if(this.showing)
this.hide();else
this.show();}
setToggler(button){if(button&&button.click instanceof navbar.Clickable){button.click.onClick((v)=>v?this.show():this.hide());this.onToggle((v)=>button.click.setActive(v));return;}
if(!button.container||typeof button.onClick!=="function")
throw{code:-1,description:`WaveContainer.setToggler(): not a valid Button`}
button.onClick((a)=>a?this.show():this.hide());}
set content(content){emptyNode(this.container.contentBox.content);if(typeof content==="object"&&content.classList)
this.container.contentBox.content.appendChild(content);else
this.container.contentBox.content.innerHTML=content;}
set loading(loading){this.container.contentBox.loading.loading=loading;}
get content(){return this.container.contentBox.content;}}
const navbar={container:undefined,block:{left:undefined,middle:undefined,right:undefined},tooltip:{container:undefined,title:undefined,description:undefined},underlay:undefined,instances:[],subWindowLists:[],init(container){if(typeof container!=="object"||!container.classList)
throw{code:-1,description:`navbar.init(): container is not a valid node`}
this.container=container;this.container.classList.add("navigationBar");emptyNode(this.container);for(let key of Object.keys(this.block)){this.block[key]=document.createElement("span");this.block[key].classList.add("group",key);this.container.appendChild(this.block[key]);}
if(!this.tooltip.container){this.tooltip.container=document.createElement("div");this.tooltip.container.classList.add("navTip");this.tooltip.title=document.createElement("t");this.tooltip.title.classList.add("title");this.tooltip.description=document.createElement("t");this.tooltip.description.classList.add("description");this.tooltip.container.append(this.tooltip.title,this.tooltip.description);}
if(!this.underlay){this.underlay=document.createElement("div");this.underlay.classList.add("underlay");this.underlay.addEventListener("click",()=>{for(let item of this.subWindowLists)
item.hide(false);this.setUnderlay(false);});window.addEventListener("resize",()=>{for(let item of this.subWindowLists)
if(item.showing)
item.update();});}
this.container.append(this.tooltip.container,this.underlay);},insert(component,location,order){if(this.instances.includes(component))
return;if(typeof component!=="object"||!component.container)
throw{code:-1,description:`navbar.insert(): not a valid component`}
if(!this.block[location])
throw{code:-1,description:`navbar.insert(): not a valid location`}
this.block[location].appendChild(component.container);this.instances.push(component);if(typeof order==="number")
component.container.style.order=order;},remove(component,location){if(typeof component!=="object"||!component.container)
throw{code:-1,description:`navbar.insert(): not a valid component`}
if(!this.block[location])
throw{code:-1,description:`navbar.insert(): not a valid location`}
this.block[location].removeChild(component.container);},setUnderlay(visible=false){this.underlay.classList[visible?"add":"remove"]("show");},Tooltip:class{constructor(node,{title=null,description=null}={}){this.node=node;this.locked=false;this.disabled=false;this.tooltip=navbar.tooltip;this.title=title;this.description=description;this.showing=false;node.addEventListener("mouseenter",()=>{if(this.locked||this.disabled||!this.title||!this.description||node.classList.contains("active"))
return;this.show();});node.addEventListener("click",()=>{this.hide();this.locked=true;});node.addEventListener("mouseleave",()=>{this.hide();this.locked=false;});}
show(){let contPos=navbar.container.getBoundingClientRect();let leftPos=this.node.getBoundingClientRect().left-contPos.left;let rightPos=leftPos+this.node.offsetWidth;if((rightPos/navbar.container.clientWidth)>0.8){this.tooltip.container.classList.add("flip");this.tooltip.container.style.left=null;this.tooltip.container.style.right=`${navbar.container.clientWidth - rightPos}px`;}else{this.tooltip.container.classList.remove("flip");this.tooltip.container.style.left=`${leftPos}px`;this.tooltip.container.style.right=null;}
this.tooltip.title.innerText=this.title;this.tooltip.description.innerText=this.description;this.tooltip.container.classList.add("show");this.showing=true;}
hide(){this.tooltip.container.classList.remove("show");this.showing=false;}
set({title=null,description=null}){if(title)
this.title=title;if(description)
this.description=description;}},SubWindow:class{constructor(container,content="BLANK",color="gray"){this.id=randString(6);this.showing=false;this.hideTimeout=null;this.toggleHandlers=[];this.container=container;this.windowNode=document.createElement("div");this.windowNode.classList.add("subWindow","hide");this.windowNode.dataset.id=this.id;this.color=color;this.overlay=new LoadingOverlay();this.contentNode=document.createElement("div");this.contentNode.classList.add("content");this.content=content;new ResizeObserver(()=>this.update()).observe(this.contentNode);this.windowNode.append(this.overlay.container,this.contentNode);this.container.appendChild(this.windowNode);navbar.subWindowLists.push(this);}
update(){let height=(this.showing)?this.contentNode.offsetHeight:0;this.windowNode.style.height=`${height}px`;if(this.showing){let containerRect=this.container.getBoundingClientRect();let width=this.contentNode.offsetWidth;let leftPos=containerRect.left;if((leftPos+(containerRect.width/2)+(width/2))<=window.innerWidth&&(leftPos+(containerRect.width/2)>(width/2)))
this.windowNode.dataset.align="center";else if((width-(leftPos+containerRect.width))<0)
this.windowNode.dataset.align="right";else if((leftPos+width)<=window.innerWidth)
this.windowNode.dataset.align="left";else{this.windowNode.dataset.align="full";this.windowNode.style.width=null;return;}
this.windowNode.style.width=`${width}px`;}}
show(){clearTimeout(this.hideTimeout);for(let item of navbar.subWindowLists)
if(item.id!==this.id)
item.hide(false);if(typeof sounds==="object")
sounds.toggle()
navbar.setUnderlay(true);this.windowNode.classList.remove("hide");this.windowNode.classList.add("show");this.container.classList.add("active");this.showing=true;this.update();}
hide(trusted=true){clearTimeout(this.hideTimeout);if(trusted){if(typeof sounds==="object")
sounds.toggle(1)
navbar.setUnderlay(false);}
this.windowNode.classList.remove("show");this.container.classList.remove("active");this.showing=false;this.update();this.hideTimeout=setTimeout(()=>this.windowNode.classList.add("hide"),300);}
toggle(){(this.showing)?this.hide():this.show();this.toggleHandlers.forEach((f)=>f(this.showing));}
onToggle(f){if(typeof f!=="function")
throw{code:-1,description:`navbar.SubWindow().onToggle(): not a valid function`}
return this.toggleHandlers.push(f);}
set color(color){this.windowNode.dataset.color=color;}
set loading(loading){this.overlay.loading=loading;}
set content(content){if(typeof content==="object"&&content.classList){emptyNode(this.contentNode);this.contentNode.appendChild(content);}else
this.contentNode.innerHTML=content;}},Clickable:class{constructor(container,{onlyActive=false}={}){if(typeof container!=="object"||!container.appendChild)
throw{code:-1,description:`navbar.Clickable(): container is not a valid node`}
this.container=container;this.container.classList.add("clickable");this.clickHandlers=[]
this.handlers=[]
this.clickBox=document.createElement("div");this.clickBox.classList.add("clickBox");this.clickBox.addEventListener("click",()=>{if(onlyActive){for(let f of this.clickHandlers)
f(true);this.active=true;}else{let isActive=this.container.classList.contains("active");for(let f of this.clickHandlers)
f(!isActive);this.toggle(isActive);}});if(typeof sounds==="object")
sounds.applySound(this.clickBox,["soundhover","soundselect"]);this.container.appendChild(this.clickBox);}
onClick(f){if(typeof f!=="function")
throw{code:-1,description:`navbar.Clickable.onClick(): not a valid function`}
return this.clickHandlers.push(f);}
setHandler(f){if(typeof f!=="function")
throw{code:-1,description:`navbar.Clickable.setHandler(): not a valid function`}
return this.handlers.push(f);}
removeHandler(index){if(this.handlers[index])
this.handlers[index]=undefined;}
set active(active){this.setActive(active);requestAnimationFrame(()=>{for(let item of this.handlers){if(typeof item==="function")
item(active);}});}
get active(){return this.container.classList.contains("active");}
show(){this.active=true;}
hide(){this.active=false;}
setActive(active){this.container.classList[active?"add":"remove"]("active")}
toggle(isActive=this.active){this.active=!isActive;}},title({icon="/api/images/icon",title="App Name"}={}){let container=document.createElement("span");container.classList.add("component","title");let iconNode=new lazyload({source:icon,classes:"icon"});let titleNode=document.createElement("t");titleNode.classList.add("title");titleNode.innerHTML=title;container.append(iconNode.container,titleNode);let navtip=new this.Tooltip(container,(arguments&&arguments[0]&&arguments[0].tooltip)?arguments[0].tooltip:{});let click=new this.Clickable(container);return{container,tooltip:navtip,click,set({icon,title,}){if(icon)
iconNode.src=icon;if(title)
titleNode.innerText=title;}}},iconButton({icon="circle",color=document.body.classList.contains("dark")?"dark":"whitesmoke"}={}){let container=document.createElement("span");container.classList.add("component","iconBtn");let iconNode=document.createElement("icon");iconNode.dataset.icon=icon;container.appendChild(iconNode);let background=triBg(container,{color,scale:1,triangleCount:8,speed:6});let navtip=new this.Tooltip(container,(arguments&&arguments[0]&&arguments[0].tooltip)?arguments[0].tooltip:{});let click=new this.Clickable(container);return{container,navtip,click,set({icon,color}={}){if(icon)
iconNode.dataset.icon=icon;if(color)
background.color=color;}}},menuButton({}={}){let container=document.createElement("span");container.classList.add("component","menuBtn");let iconNode=document.createElement("span");iconNode.classList.add("hamburger");iconNode.innerHTML=`<span></span><span></span><span></span>`
container.appendChild(iconNode);let navtip=new this.Tooltip(container,(arguments&&arguments[0]&&arguments[0].tooltip)?arguments[0].tooltip:{});let click=new this.Clickable(container);return{container,tooltip:navtip,click}},switch({color=document.body.classList.contains("dark")?"dark":"whitesmoke"}={}){let container=document.createElement("span");container.classList.add("component","switch");let indicator=document.createElement("div");indicator.classList.add("indicator");container.appendChild(indicator);let background=triBg(container,{color,scale:2,triangleCount:8,speed:6});let currentActive=null;return{container,button({icon="circle"}={}){let button=document.createElement("icon");button.dataset.icon=icon;button.dataset.id=randString(4);let navtip=new navbar.Tooltip(button,(arguments&&arguments[0]&&arguments[0].tooltip)?arguments[0].tooltip:{});let click=new navbar.Clickable(button,{onlyActive:true});const update=()=>{if(currentActive&&currentActive.id!==button.dataset.id){currentActive.click.active=false;currentActive=null;}
indicator.style.left=button.offsetLeft+"px";currentActive={id:button.dataset.id,click}}
click.setHandler((a)=>{if(a)
update();});container.appendChild(button);return{button,navtip,click,update}},set({color=null}={}){if(color)
background.color=color;}}}}
const smenu={container:undefined,initialized:false,groupLists:[],hiding:true,collapsing:true,containerHideTimeout:null,mainHideTimeout:null,activePanel:null,align:"right",showHandlers:[],hideHandlers:[],init(container,{title="settings",description="Change how this application behaves"}={}){if(typeof container!=="object"||!container.classList||!container.parentElement)
throw{code:-1,description:`smenu.init(): container is not a valid node`}
let view=makeTree("div",["smenuContainer","hide"],{main:{tag:"div",class:"main",child:{wrapper:{tag:"div",class:"wrapper",child:{smenu:{tag:"div",class:"smenu",child:{menuTitle:{tag:"t",class:"title",text:title},menuDescription:{tag:"t",class:"description",text:description},search:{tag:"div",class:"searchBox",child:{input:{tag:"input",class:"flatInput"}}}}}}},navigator:{tag:"div",class:"navigator"}}},panels:{tag:"div",class:"panels",child:{underlay:{tag:"div",class:"underlay"}}}});view.id=container.id;container.parentElement.replaceChild(view,container);this.container=view;let searchTimeout;let navExpandTimeout;this.container.main.wrapper.smenu.search.input.placeholder="nhập để tìm kiếm";this.container.main.wrapper.smenu.search.input.addEventListener("input",(e)=>{clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>this.filter(e.target.value),200);});if(typeof Scrollable==="function"){this.scroll=new Scrollable(this.container.main.wrapper,{content:this.container.main.wrapper.smenu,scrollbar:false});}
this.container.main.navigator.addEventListener("mouseenter",()=>navExpandTimeout=setTimeout(()=>{this.container.main.navigator.classList.add("expand");},800));this.container.main.navigator.addEventListener("mouseleave",()=>{clearTimeout(navExpandTimeout);this.container.main.navigator.classList.remove("expand");});let ticking=false;this.container.main.wrapper.smenu.addEventListener("scroll",()=>{if(!ticking){requestAnimationFrame(()=>{let haveActive=false;for(let group of this.groupLists){if(haveActive)
group.toggler.classList.remove("active");else if(group.updatePos())
haveActive=true;}
ticking=false;})
ticking=true;}});this.container.panels.underlay.addEventListener("click",()=>{if(this.activePanel)
this.activePanel.hide();else
this.hide();});this.initialized=true;},setAlignment(align){this.align=align;this.container.dataset.align=align;},onShow(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.onShow(): not a valid function"}
this.showHandlers.push(f);},onHide(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.onHide(): not a valid function"}
this.hideHandlers.push(f);},show(isBack=true){if(!this.initialized)
throw{code:-1,description:"smenu.show(): smenu is not initialized!"}
if(!this.hiding&&!this.collapsing)
return;clearInterval(this.containerHideTimeout);this.container.classList.remove("hide");this.container.main.classList.remove("hide");this.container.main.classList.remove("collapse");if(isBack&&typeof sounds==="object")
sounds.toggle();requestAnimationFrame(()=>{this.container.classList.add("show");this.hiding=false;this.collapsing=false;this.showHandlers.forEach(f=>f());});},hide(){if(!this.initialized)
throw{code:-1,description:"smenu.hide(): smenu is not initialized!"}
if(this.hiding)
return;clearInterval(this.containerHideTimeout);this.container.classList.remove("show");if(typeof sounds==="object")
sounds.toggle(1);if(this.activePanel)
this.activePanel.hide(false);this.containerHideTimeout=setTimeout(()=>this.container.classList.add("hide"),600);this.hiding=true;this.hideHandlers.forEach(f=>f());},collapse(){if(!this.initialized)
throw{code:-1,description:"smenu.collapse(): smenu is not initialized!"}
if(this.collapsing)
return;clearInterval(this.mainHideTimeout);this.container.main.classList.add("collapse");this.mainHideTimeout=setTimeout(()=>this.container.main.classList.add("hide"),600);this.collapsing=true;},setToggler(button){button.addEventListener("mouseup",()=>{if(this.hiding)
this.show();else
this.hide();});this.onShow(()=>button.classList.add("active"));this.onHide(()=>button.classList.remove("active"));},filter(keyword){this.container.main.wrapper.smenu.search.input.value=keyword;let tags=keyword.toLocaleLowerCase().split(" ");for(let group of this.groupLists){if(group.skipFilter)
continue;let list=group.container.getElementsByClassName("component");let hidden=0;for(let item of list){let text=item.innerText.toLocaleLowerCase();for(let tag of tags)
if(!text.includes(tag)){item.style.display="none";hidden++;text=null;break;}
if(text)
item.style.display=null;}
if(hidden>=list.length)
group.hide();else
group.show();}},Group:class{constructor({icon="circle",label="Group",after=null}={}){this.id=randString(8);this.animator=null;this.container=document.createElement("div");this.container.classList.add("group");this.container.dataset.id=this.id;this.title=document.createElement("t");this.title.classList.add("title");this.title.innerText=label;this.container.appendChild(this.title);this.toggler=document.createElement("icon");this.toggler.classList.add("button");this.toggler.dataset.icon=icon;this.toggler.innerText=label;if(typeof sounds==="object")
sounds.applySound(this.toggler,["soundhoversoft","soundselectsoft"]);this.toggler.addEventListener("click",()=>this.scrollTo());if(after){insertAfter(this.container,after.container);insertAfter(this.toggler,after.toggler);let index=smenu.groupLists.indexOf(after)+1;if(index<smenu.groupLists.length)
smenu.groupLists.splice(index,0,this);else
smenu.groupLists.push(this);}else{smenu.container.main.wrapper.smenu.appendChild(this.container);smenu.container.main.navigator.appendChild(this.toggler);smenu.groupLists.push(this);}
requestAnimationFrame(()=>smenu.container.main.wrapper.smenu.dispatchEvent(new Event("scroll")));}
hide(){this.container.style.display="none";}
show(){this.container.style.display=null;}
insert(child,order){if(typeof child!=="object"||(!child.classList&&!child.container))
throw{code:-1,description:`smenu.insert(): child is not a valid node/smenu.Child`}
if(child.container)
child=child.container;child.style.order=order;this.container.appendChild(child);}
updatePos(){let yPos=this.container.getBoundingClientRect().y;let mHeight=smenu.container.offsetHeight+smenu.container.offsetTop;let cHeight=this.container.offsetHeight;if((yPos<0&&(yPos+cHeight+100)>mHeight)||(yPos>=0&&yPos<=(mHeight+100))){this.toggler.classList.add("active");return true;}else{this.toggler.classList.remove("active");return false;}}
async scrollTo(){let _c=smenu.container.main.wrapper.smenu;let maxScroll=_c.scrollHeight-_c.offsetHeight;if(maxScroll===0)
return;let current=_c.scrollTop;let target=this.container.offsetTop-80;if(current===target)
return;if(target>maxScroll)
target=maxScroll;smenu.scroll.disabled=true;for(let anm of smenu.groupLists)
if(anm.id!==this.id&&anm.animator&&anm.animator.cancel)
anm.animator.cancel();this.animator=new Animator(0.6,Easing.OutExpo,(t)=>_c.scrollTop=current+(target-current)*t);await this.animator.complete();this.animator=null;smenu.scroll.disabled=false;}},Child:class{constructor({label="Child"}={},group){this.container=document.createElement("div");this.container.classList.add("child");this.title=document.createElement("t");this.title.classList.add("title");this.title.innerText=label;this.container.appendChild(this.title);if(group){if(!group.container||typeof group.insert!=="function")
throw{code:-1,description:`smenu.Child(): group is not a valid Group`}
group.insert(this);}}
insert(child,order){if(typeof child!=="object"||(!child.classList&&!child.container))
throw{code:-1,description:`smenu.insert(): child is not a valid node/Component`}
if(child.container)
child=child.container;child.style.order=order;this.container.appendChild(child);}},components:{Text:class{constructor({content="Sample Text"}={},child){this.container=document.createElement("t");this.container.classList.add("component","text");this.content=content;if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Text(): child is not a valid Child`}
child.insert(this);}}
onClick(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.components.Text().onClick(): not a valid function"}
this.container.addEventListener("click",e=>f(e));}
set content(content){if(typeof content==="object"&&content.classList){emptyNode(this.container);this.container.appendChild(content);}else
this.container.innerHTML=content;}},Note:class{constructor({level="info",message="Sample Note",style="round"}={},child){this.note=createNote({level,message,style});this.note.group.classList.add("component","note");this.container=this.note.group;if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Note(): child is not a valid Child`}
child.insert(this);}}
set({level,message,style}={}){this.note.set({level,message,style});}},Space:class{constructor(child){this.container=document.createElement("div");this.container.classList.add("component","space");if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Space(): child is not a valid Child`}
child.insert(this);}}},Textbox:class{constructor({label="Sample Textbox",type="text",value=null,save=null,defaultValue="sample value",onInput=null}={},child){this.container=document.createElement("div");this.container.classList.add("component","textbox");this.id=`smenu.components.Textbox.${randString(16)}`;this.labelNode=document.createElement("label");this.labelNode.innerHTML=label;this.labelNode.htmlFor=this.id;this.input=document.createElement("input");this.input.classList.add("flatInput");this.input.id=this.id;this.input.type=type;this.input.placeholder=defaultValue;this.defaultValue=defaultValue;this.save=save;this.inputHandlers=[]
this.input.addEventListener("input",()=>{let value=this.input.type==="number"?parseInt(this.input.value):this.input.value;this.inputHandlers.forEach(f=>f(value));});this.inputHandlers.push((value)=>{if(this.save)
localStorage.setItem(this.save,value);if(value!==this.defaultValue)
this.container.classList.add("changed");else
this.container.classList.remove("changed");});if(typeof onInput==="function")
this.inputHandlers.push(onInput);this.container.append(this.labelNode,this.input);if(this.save){let savedValue=localStorage.getItem(this.save);if(savedValue===null)
this.set({value:(["number","string"].includes(typeof value))?value:defaultValue||""});else
this.set({value:savedValue});}
if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Textbox(): child is not a valid Child`}
child.insert(this);}}
set({label,disabled,value}={}){if(typeof label==="string")
this.labelNode.innerHTML=label;if(typeof disabled==="boolean")
this.input.disabled=disabled;if(typeof value!=="undefined"){this.input.value=value;this.input.dispatchEvent(new Event("input"));}}
onInput(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.components.Textbox().onInput(): not a valid function"}
this.inputHandlers.push(f);f(this.input.type==="number"?parseInt(this.input.value):this.input.value);}},Checkbox:class{constructor({label="Sample Button",color="blue",disabled=false,value=null,save=null,defaultValue=false,onChange=null,toast=false}={},child){this.container=document.createElement("div");this.container.classList.add("component","checkbox");this.checkbox=createCheckbox({label,color});this.checkbox.input.disabled=disabled;this.container.appendChild(this.checkbox.group);this.defaultValue=defaultValue;this.save=save;this.toast=null;this.init=false;if(toast){this.toast=new ToastInstance(label,false,{hint:save||"không lưu"});}
this.changeHandlers=[]
this.checkbox.input.addEventListener("change",async(e)=>{this.checkbox.input.disabled=true;for(let f of this.changeHandlers)
await f(this.checkbox.input.checked);this.checkbox.input.disabled=false;});this.changeHandlers.push((value)=>{if(this.save)
localStorage.setItem(this.save,value);if(this.toast&&this.init){this.toast.value=value;this.toast.show();}
if(value!==this.defaultValue)
this.container.classList.add("changed");else
this.container.classList.remove("changed");});if(typeof onChange==="function")
this.changeHandlers.push(onChange);if(this.save){let savedValue=localStorage.getItem(this.save);if(savedValue===null)
this.set({value:(typeof value==="boolean")?value:defaultValue||false});else
this.set({value:(savedValue==="true")});}
if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Checkbox(): child is not a valid Child`}
child.insert(this);}
this.init=true;}
set({label,color,disabled,value}={}){if(typeof label==="string")
this.checkbox.title.innerText=label;if(typeof color==="string")
this.checkbox.label.dataset.color=color;if(typeof value==="boolean"){this.checkbox.input.checked=value;this.checkbox.input.dispatchEvent(new Event("change"));}
if(typeof disabled==="boolean")
this.checkbox.input.disabled=disabled;}
onChange(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.components.Checkbox().onChange(): not a valid function"}
this.changeHandlers.push(f);f(this.checkbox.input.checked);}},Choice:class{constructor({label="Sample Choice Box",color="blue",choice,value,save,defaultValue,onChange,toast=false}={},child){this.container=document.createElement("div");this.container.classList.add("component","choice");this.labelNode=document.createElement("t");this.labelNode.classList.add("label");this.choice=createChoiceInput();this.container.append(this.labelNode,this.choice.container);this.save=save;this.defaultValue=defaultValue;this.toast=null;this.init=false;if(toast){this.toast=new ToastInstance(label,false,{hint:save||"không lưu"});}
this.onChange((value)=>{if(this.save)
localStorage.setItem(this.save,value);if(this.toast&&this.init){this.toast.value=this.choice.names[value]||value;this.toast.show();}
if(value!==this.defaultValue)
this.container.classList.add("changed");else
this.container.classList.remove("changed");});if(this.save){let savedValue=localStorage.getItem(this.save);if(savedValue===null)
value=(typeof value==="string")?value:defaultValue;else
value=savedValue;}
if(typeof onChange==="function")
this.onChange(onChange);this.set({label,color,choice,value});if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Choice(): child is not a valid Child`}
child.insert(this);}
this.init=true;}
onChange(f){if(typeof f!=="function")
throw{code:-1,description:`smenu.components.Choice().onChange(): not a valid function`}
this.choice.onChange(f);}
set({label,color,choice,value}={}){if(typeof label==="string")
this.labelNode.innerHTML=label;this.choice.set({color,choices:choice,value});}},Select:class{constructor({label="Sample Choice Box",color="blue",icon,options,value,save,defaultValue,onChange}={},child){this.container=document.createElement("div");this.container.classList.add("component","select");this.labelNode=document.createElement("t");this.labelNode.classList.add("label");this.labelNode.innerHTML=label;this.selectInput=createSelectInput({icon,color,options,value});this.selectInput.group.classList.add("right");this.container.append(this.labelNode,this.selectInput.group);this.defaultValue=defaultValue;this.save=save;this.changeHandlers=[]
this.selectInput.onChange(async(value)=>{for(let f of this.changeHandlers)
await f(value);});this.changeHandlers.push((value)=>{if(this.save)
localStorage.setItem(this.save,value);if(value!==this.defaultValue)
this.container.classList.add("changed");else
this.container.classList.remove("changed");});if(typeof onChange==="function")
this.changeHandlers.push(onChange);if(this.save){let savedValue=localStorage.getItem(this.save);if(savedValue===null)
this.set({value:(typeof value==="string")?value:defaultValue||false});else
this.set({value:savedValue});}
if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Checkbox(): child is not a valid Child`}
child.insert(this);}}
onChange(f){if(typeof f!=="function")
throw{code:-1,description:`smenu.components.Select().onChange(): not a valid function`}
this.changeHandlers.push(f);if(this.selectInput.value)
f(this.selectInput.value);}
set({label,icon,color,options,value}={}){if(typeof label==="string")
this.labelNode.innerHTML=label;this.selectInput.set({icon,color,options,value});}},Slider:class{constructor({label="Sample Slider",color="pink",min=0,max=10,step=1,value=null,save=null,unit=null,valueStep=null,defaultValue=1,disabled=false,onChange=null,onInput=null,toast=false}={},child){this.container=document.createElement("div");this.container.classList.add("component","slider");let header=document.createElement("div");header.classList.add("header");this.labelNode=document.createElement("t");this.labelNode.classList.add("label");this.labelNode.innerHTML=label;this.previewNode=document.createElement("t");this.previewNode.classList.add("preview");this.previewNode.innerText="Unknown";this.defaultValue=defaultValue;this.valueStep=valueStep;this.unit=unit;this.save=save;this.toast=null;this.init=false;if(toast){this.toast=new ToastInstance(label,false,{hint:save||"không lưu"});}
if(this.save){let savedValue=localStorage.getItem(this.save);if(savedValue===null)
value=(typeof value==="number")?value:defaultValue;else
value=parseFloat(savedValue);}
this.slider=createSlider({color,value,min,max,step});this.slider.input.disabled=disabled;this.onInput=this.slider.onInput;this.onChange=this.slider.onChange;header.append(this.labelNode,this.previewNode);this.container.append(header,this.slider.group);this.onInput((value,e)=>this.update(value,!!(e&&e.isTrusted)));this.update(value,false);if(typeof onInput==="function")
this.onInput(onInput);if(typeof onChange==="function")
this.onChange(onChange);if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Slider(): child is not a valid Child`}
child.insert(this);}
this.init=true;}
update(value,showTooltip=true){if(this.save)
localStorage.setItem(this.save,value);let rVal=(this.valueStep&&(typeof this.valueStep[value]!=="undefined"))?this.valueStep[value]:value;let sVal=(typeof rVal==="boolean")?((rVal)?"BẬT":"TẮT"):rVal+((this.unit)?` ${this.unit}`:"");this.previewNode.innerHTML=sVal;if(this.toast&&this.init){this.toast.value=sVal;this.toast.show();}
if(value!=this.defaultValue)
this.container.classList.add("changed");else
this.container.classList.remove("changed");if(showTooltip&&typeof tooltip==="object"&&tooltip.initialized===true)
tooltip.show(sVal,this.slider.input);}
set({label,color,value,min,max,step,valueStep,unit,defaultValue,disabled}={}){if(typeof label==="string")
this.labelNode.innerHTML=label;if(typeof color==="string")
this.slider.group.dataset.color=color;for(let key of["value","min","max","step"])
if(typeof arguments[0][key]==="number"){this.slider.input[key]=arguments[0][key];this.slider.input.dispatchEvent(new Event("input"));}
for(let key of["valueStep","unit","defaultValue"])
if(arguments[0][key]){this[key]=arguments[0][key];this.update(this.slider.input.value,false);}
if(typeof disabled==="boolean")
this.slider.input.disabled=disabled;}},Button:class{constructor({label="Sample Button",color="blue",icon,complex=false,disabled=false,triangleCount=8,onClick}={},child){this.container=document.createElement("div");this.container.classList.add("component","button");this.button=createButton(label,{color,icon,complex,triangleCount,disabled});this.container.appendChild(this.button);this.clickHandlers=[]
this.button.addEventListener("click",async(e)=>{this.button.loading(true);for(let f of this.clickHandlers){try{await f(e);}catch(error){clog("ERRR","smenu.components.Button().handleClick(): An error occured when handling click handlers",error);continue;}}
this.button.loading(false);});if(typeof onClick==="function")
this.clickHandlers.push(onClick);if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Button(): child is not a valid Child`}
child.insert(this);}}
set({label,color,icon,disabled}={}){if(typeof label==="string")
this.button.changeText(label);if(typeof color==="string")
if(this.button.background)
this.button.background.color=color;if(typeof icon==="string")
this.button.dataset.icon=icon;if(typeof disabled==="boolean")
this.button.disabled=disabled;}
onClick(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.components.Button().onClick(): not a valid function"}
this.clickHandlers.push(f);}},Footer:class{constructor({icon="",appName="Example App",version="0.0.1"}={},child){this.container=buildElementTree("div",["component","footer"],[{type:"img",class:"icon",name:"icon"},{type:"t",class:"name",name:"name"},{type:"t",class:"version",name:"version"}]).obj;this.container.icon.src=icon;this.container.name.innerText=appName;this.container.version.innerText=version;this.skipFilter=true;if(child){if(!child.container||typeof child.insert!=="function")
throw{code:-1,description:`smenu.components.Footer(): child is not a valid Child`}
child.insert(this);}}}},Panel:class{constructor(content,{size="normal"}={}){this.container=makeTree("div",["panel","hide"],{overlay:{tag:"div",class:"overlay",child:{spinner:{tag:"div",class:"spinner"}}},buttons:{tag:"span",class:"buttons",child:{reload:{tag:"span",class:"reload"},close:{tag:"span",class:"close"},custom:{tag:"span"}}},main:{tag:"span",class:"main"}});smenu.container.panels.appendChild(this.container);this.container.dataset.size=size;this.iframe=undefined;this.hideTimeout=null;this.container.buttons.close.addEventListener("click",()=>this.hide());if(content)
this.content(content);this.reload.onClick(()=>(this.iframe)?this.iframe.contentWindow.location.reload():0);}
set content(content){this.content(content);}
set loading(loading){this.container.overlay.classList[loading?"add":"remove"]("show");}
content(content){return new Promise((resolve)=>{if(this.iframe){this.container.main.removeChild(this.iframe);delete this.iframe;}
emptyNode(this.container.main);let re=null;if(typeof content==="object"&&content.classList){this.container.main.appendChild(content);resolve();}else if((re=/iframe:(.+)/gm.exec(content))!==null){this.loading=true;this.iframe=document.createElement("iframe");if(re[1][0]==="/")
this.iframe.src=`${window.location.protocol}//${window.location.host}${re[1]}`;else
this.iframe.src=re[1];this.container.main.appendChild(this.iframe);this.iframe.addEventListener("load",()=>{this.loading=false;resolve()});return;}else{this.container.main.innerHTML=content;resolve();}
return;});}
get reload(){let button=this.container.buttons.reload;return{button,onClick(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.Panel().reload.onClick(): not a valid function"}
button.addEventListener("click",f);},}}
get custom(){let button=this.container.buttons.custom;return{button,type(type){button.className=`custom ${type}`;},onClick(f){if(!f||typeof f!=="function")
throw{code:-1,description:"smenu.Panel().custom.onClick(): not a valid function"}
button.addEventListener("click",f);},}}
setToggler(button){if(!button.container||typeof button.onClick!=="function")
throw{code:-1,description:`smenu.Panel.setToggler(): not a valid Button`}
button.onClick(()=>this.show());}
show(){clearTimeout(this.hideTimeout);if(smenu.activePanel)
smenu.activePanel.hide();this.container.classList.remove("hide");smenu.activePanel=this;this.showing=true;if(typeof sounds==="object")
sounds.toggle();requestAnimationFrame(()=>{smenu.collapse();this.container.classList.add("show");});}
async hide(callShowMenu=true){clearTimeout(this.hideTimeout);this.container.classList.remove("show");smenu.activePanel=null;if(typeof sounds==="object")
sounds.toggle(1);if(callShowMenu)
smenu.show(false);this.hideTimeout=setTimeout(()=>{this.container.classList.add("hide")
this.showing=false;},600);await delayAsync(600);}}}
const toast={instances:[],active:undefined,view:undefined,showing:false,init(container=document.body){if(!this.view){this.view=makeTree("div",["toast","hide"],{value:{tag:"div",class:"value",text:"value"},top:{tag:"div",class:"top",child:{titleNode:{tag:"div",class:"title",text:"sample"},space:{tag:"div",class:"space"}}},bottom:{tag:"div",class:"bottom",child:{space:{tag:"div",class:"space"},light:{tag:"div",class:"light"},hint:{tag:"div",class:"hint",text:"no hint yet"}}}});}
container.insertBefore(this.view,container.childNodes[0]);},async show(title,value,options={}){let instance=new ToastInstance(title,value,options);instance.show();return instance;},set title(title){this.view.top.titleNode.innerText=title;},set value(value){if(typeof value==="boolean"){this.light=value;value=value?"bật":"tắt";}
this.view.value.classList[value.length>6?"add":"remove"]("small");this.view.value.innerText=value;},set light(light){if(typeof light==="boolean"){this.view.bottom.light.classList.add("show");this.view.bottom.light.classList[light?"add":"remove"]("active");}else{this.view.bottom.light.classList.remove("show");}},set hint(hint){this.view.bottom.hint.innerText=hint;},}
class ToastInstance{constructor(title,value,{hint="no hint",light=null,duration=3000}={}){this.title=title;this.hint=hint;this.value=value;this.light=light;this.duration=duration;this.showing=false;this.timeout=null;this.showListeners=[]
this.hideListeners=[]
clog("DEBG",`ToastInstance("${this.title}"): created new toast instance!`);}
onShow(f){if(typeof f!=="function")
throw{code:-1,description:`ToastInstance("${this.title}").onShow(): not a valid function!`}
return this.showListeners.push(f)-1;}
onHide(f){if(typeof f!=="function")
throw{code:-1,description:`ToastInstance("${this.title}").onHide(): not a valid function!`}
return this.hideListeners.push(f)-1;}
queue(){if(toast.instances.includes(this))
return;toast.instances.push(this);clog("DEBG",`ToastInstance("${this.title}").queue(): added to queue!`);}
async show(){if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}
if(toast.showing&&toast.active!==this){this.queue();return;}
toast.title=this.title;toast.value=this.currentValue;toast.light=this.currentLight;toast.hint=this.hint;toast.active=this;if(this.duration>0){this.timeout=setTimeout(()=>this.hide(),this.duration);}
if(this.showing)
return;this.showing=true;clog("DEBG",`ToastInstance("${this.title}").show(): showing!`);if(toast.instances.includes(this))
toast.instances.splice(toast.instances.indexOf(this),1);if(!toast.showing){toast.showing=true;toast.view.classList.remove("hide");await nextFrameAsync();toast.view.classList.add("show");await delayAsync(500);}
for(let f of this.showListeners){try{await f(this);}catch(e){clog("WARN",`ToastInstance("${this.title}").show(): listener generated an error!`,e);continue;}}}
set value(value){if(typeof value==="boolean"){this.currentLight=value;this.currentValue=value?"bật":"tắt";}else{this.currentValue=value;this.currentLight=null;}
if(toast.active!==this)
return;toast.value=value;toast.light=this.currentLight;}
set light(light){this.currentLight=light;if(toast.active!==this)
return;toast.light=light;}
async hide(){if(!this.showing)
return;if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}
clog("DEBG",`ToastInstance("${this.title}").hide(): hiding!`);if(toast.showing){toast.view.classList.remove("show");await delayAsync(1500);toast.view.classList.add("hide");toast.active=undefined;toast.showing=false;}
this.showing=false;for(let f of this.hideListeners){try{await f(this);}catch(e){clog("WARN",`ToastInstance("${this.title}").hide(): listener generated an error!`,e);continue;}}
if(toast.instances.length>0){toast.instances[0].show();}}
attach(){if(!this.showing)
return;return new Promise((resolve)=>this.onHide(()=>resolve()));}};(function($){'use strict'
function safeAdd(x,y){var lsw=(x&0xffff)+(y&0xffff)
var msw=(x>>16)+(y>>16)+(lsw>>16)
return(msw<<16)|(lsw&0xffff)}
function bitRotateLeft(num,cnt){return(num<<cnt)|(num>>>(32-cnt))}
function md5cmn(q,a,b,x,s,t){return safeAdd(bitRotateLeft(safeAdd(safeAdd(a,q),safeAdd(x,t)),s),b)}
function md5ff(a,b,c,d,x,s,t){return md5cmn((b&c)|(~b&d),a,b,x,s,t)}
function md5gg(a,b,c,d,x,s,t){return md5cmn((b&d)|(c&~d),a,b,x,s,t)}
function md5hh(a,b,c,d,x,s,t){return md5cmn(b^c^d,a,b,x,s,t)}
function md5ii(a,b,c,d,x,s,t){return md5cmn(c^(b|~d),a,b,x,s,t)}
function binlMD5(x,len){x[len>>5]|=0x80<<len%32
x[(((len+64)>>>9)<<4)+14]=len
var i
var olda
var oldb
var oldc
var oldd
var a=1732584193
var b=-271733879
var c=-1732584194
var d=271733878
for(i=0;i<x.length;i+=16){olda=a
oldb=b
oldc=c
oldd=d
a=md5ff(a,b,c,d,x[i],7,-680876936)
d=md5ff(d,a,b,c,x[i+1],12,-389564586)
c=md5ff(c,d,a,b,x[i+2],17,606105819)
b=md5ff(b,c,d,a,x[i+3],22,-1044525330)
a=md5ff(a,b,c,d,x[i+4],7,-176418897)
d=md5ff(d,a,b,c,x[i+5],12,1200080426)
c=md5ff(c,d,a,b,x[i+6],17,-1473231341)
b=md5ff(b,c,d,a,x[i+7],22,-45705983)
a=md5ff(a,b,c,d,x[i+8],7,1770035416)
d=md5ff(d,a,b,c,x[i+9],12,-1958414417)
c=md5ff(c,d,a,b,x[i+10],17,-42063)
b=md5ff(b,c,d,a,x[i+11],22,-1990404162)
a=md5ff(a,b,c,d,x[i+12],7,1804603682)
d=md5ff(d,a,b,c,x[i+13],12,-40341101)
c=md5ff(c,d,a,b,x[i+14],17,-1502002290)
b=md5ff(b,c,d,a,x[i+15],22,1236535329)
a=md5gg(a,b,c,d,x[i+1],5,-165796510)
d=md5gg(d,a,b,c,x[i+6],9,-1069501632)
c=md5gg(c,d,a,b,x[i+11],14,643717713)
b=md5gg(b,c,d,a,x[i],20,-373897302)
a=md5gg(a,b,c,d,x[i+5],5,-701558691)
d=md5gg(d,a,b,c,x[i+10],9,38016083)
c=md5gg(c,d,a,b,x[i+15],14,-660478335)
b=md5gg(b,c,d,a,x[i+4],20,-405537848)
a=md5gg(a,b,c,d,x[i+9],5,568446438)
d=md5gg(d,a,b,c,x[i+14],9,-1019803690)
c=md5gg(c,d,a,b,x[i+3],14,-187363961)
b=md5gg(b,c,d,a,x[i+8],20,1163531501)
a=md5gg(a,b,c,d,x[i+13],5,-1444681467)
d=md5gg(d,a,b,c,x[i+2],9,-51403784)
c=md5gg(c,d,a,b,x[i+7],14,1735328473)
b=md5gg(b,c,d,a,x[i+12],20,-1926607734)
a=md5hh(a,b,c,d,x[i+5],4,-378558)
d=md5hh(d,a,b,c,x[i+8],11,-2022574463)
c=md5hh(c,d,a,b,x[i+11],16,1839030562)
b=md5hh(b,c,d,a,x[i+14],23,-35309556)
a=md5hh(a,b,c,d,x[i+1],4,-1530992060)
d=md5hh(d,a,b,c,x[i+4],11,1272893353)
c=md5hh(c,d,a,b,x[i+7],16,-155497632)
b=md5hh(b,c,d,a,x[i+10],23,-1094730640)
a=md5hh(a,b,c,d,x[i+13],4,681279174)
d=md5hh(d,a,b,c,x[i],11,-358537222)
c=md5hh(c,d,a,b,x[i+3],16,-722521979)
b=md5hh(b,c,d,a,x[i+6],23,76029189)
a=md5hh(a,b,c,d,x[i+9],4,-640364487)
d=md5hh(d,a,b,c,x[i+12],11,-421815835)
c=md5hh(c,d,a,b,x[i+15],16,530742520)
b=md5hh(b,c,d,a,x[i+2],23,-995338651)
a=md5ii(a,b,c,d,x[i],6,-198630844)
d=md5ii(d,a,b,c,x[i+7],10,1126891415)
c=md5ii(c,d,a,b,x[i+14],15,-1416354905)
b=md5ii(b,c,d,a,x[i+5],21,-57434055)
a=md5ii(a,b,c,d,x[i+12],6,1700485571)
d=md5ii(d,a,b,c,x[i+3],10,-1894986606)
c=md5ii(c,d,a,b,x[i+10],15,-1051523)
b=md5ii(b,c,d,a,x[i+1],21,-2054922799)
a=md5ii(a,b,c,d,x[i+8],6,1873313359)
d=md5ii(d,a,b,c,x[i+15],10,-30611744)
c=md5ii(c,d,a,b,x[i+6],15,-1560198380)
b=md5ii(b,c,d,a,x[i+13],21,1309151649)
a=md5ii(a,b,c,d,x[i+4],6,-145523070)
d=md5ii(d,a,b,c,x[i+11],10,-1120210379)
c=md5ii(c,d,a,b,x[i+2],15,718787259)
b=md5ii(b,c,d,a,x[i+9],21,-343485551)
a=safeAdd(a,olda)
b=safeAdd(b,oldb)
c=safeAdd(c,oldc)
d=safeAdd(d,oldd)}
return[a,b,c,d]}
function binl2rstr(input){var i
var output=''
var length32=input.length*32
for(i=0;i<length32;i+=8){output+=String.fromCharCode((input[i>>5]>>>i%32)&0xff)}
return output}
function rstr2binl(input){var i
var output=[]
output[(input.length>>2)-1]=undefined
for(i=0;i<output.length;i+=1){output[i]=0}
var length8=input.length*8
for(i=0;i<length8;i+=8){output[i>>5]|=(input.charCodeAt(i/8)&0xff)<<i%32}
return output}
function rstrMD5(s){return binl2rstr(binlMD5(rstr2binl(s),s.length*8))}
function rstrHMACMD5(key,data){var i
var bkey=rstr2binl(key)
var ipad=[]
var opad=[]
var hash
ipad[15]=opad[15]=undefined
if(bkey.length>16){bkey=binlMD5(bkey,key.length*8)}
for(i=0;i<16;i+=1){ipad[i]=bkey[i]^0x36363636
opad[i]=bkey[i]^0x5c5c5c5c}
hash=binlMD5(ipad.concat(rstr2binl(data)),512+data.length*8)
return binl2rstr(binlMD5(opad.concat(hash),512+128))}
function rstr2hex(input){var hexTab='0123456789abcdef'
var output=''
var x
var i
for(i=0;i<input.length;i+=1){x=input.charCodeAt(i)
output+=hexTab.charAt((x>>>4)&0x0f)+hexTab.charAt(x&0x0f)}
return output}
function str2rstrUTF8(input){return unescape(encodeURIComponent(input))}
function rawMD5(s){return rstrMD5(str2rstrUTF8(s))}
function hexMD5(s){return rstr2hex(rawMD5(s))}
function rawHMACMD5(k,d){return rstrHMACMD5(str2rstrUTF8(k),str2rstrUTF8(d))}
function hexHMACMD5(k,d){return rstr2hex(rawHMACMD5(k,d))}
function md5(string,key,raw){if(!key){if(!raw){return hexMD5(string)}
return rawMD5(string)}
if(!raw){return hexHMACMD5(key,string)}
return rawHMACMD5(key,string)}
if(typeof define==='function'&&define.amd){define(function(){return md5})}else if(typeof module==='object'&&module.exports){module.exports=md5}else{$.md5=md5}})(this)
const api={requester:undefined,HOST:`http://ctms.fithou.net.vn`,HOST_NAME:"fithou",MIDDLEWARE:`http://localhost`,__PATH:undefined,__VIEWSTATE:undefined,__VIEWSTATEGENERATOR:undefined,__EVENTVALIDATION:undefined,responseHandlers:{},resultIgnoreList:["sinh hoạt","giáo dục","kiến tập"],onResponse(type,f,{lock=false}={}){if(typeof f!=="function")
throw{code:-1,description:`api.onResponse(${type}): not a valid function`}
if(this.responseHandlers[type]===null||typeof this.responseHandlers[type]!=="object")
this.responseHandlers[type]=[]
this.responseHandlers[type].push({handler:f,lock});},async __handleResponse(type,data){if(this.responseHandlers[type]===null||typeof this.responseHandlers[type]!=="object"||this.responseHandlers[type].length===0){clog("WARN",`api.__handleResponse(${type}): no handler found`);return;}
for(let item of this.responseHandlers[type]){if(item.lock)
await item.handler(data);else
item.handler(data);}},async request({path="",method="GET",query,form,json,header={},target="",argument="",renewSession=false,ignoreAnnouncement=false}={}){clog("INFO",`api.request(${path}): begin ${method} request`);if(method==="POST"){form.__EVENTTARGET=target;form.__EVENTARGUMENT=argument;if(this.__VIEWSTATE&&!form.__VIEWSTATE){form.__VIEWSTATE=this.__VIEWSTATE;form.__VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;form.__EVENTVALIDATION=this.__EVENTVALIDATION;}}
this.__PATH=path;let start=new StopClock();let response;try{if(typeof this.requester==="function"){response=await this.requester(arguments[0]);}else{let url=`${this.HOST}${path}`;let urlParsed=new URL(url);response=await myajax({url:`${this.MIDDLEWARE}/api/middleware`,method,header:{"Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","Session-Cookie-Key":"ASP.NET_SessionId","Session-Cookie-Value":localStorage.getItem("session")||"","Set-Host":urlParsed.hostname,"Set-Origin":urlParsed.origin,"Set-Referer":`${this.HOST}${path}`,"Upgrade-Insecure-Requests":1,...header},query:{url,...query},form,json,withCredentials:true,formEncodeURL:true});}}catch(error){if(error.data){error.c2m=start.tick()-error.data.runtime;await this.__handleResponse("error",error);if(error.data.status===503){throw{code:-1,description:`CTMS hiện đang dừng hoạt động để bảo trì! CTMS_HTTP_503`,data:{code:503,description:error.data.description}}}
throw error;}else{error.c2m=start.tick();await this.__handleResponse("error",error);throw{code:-1,description:`api.request(${path}): invalid middleware response (middleware: ${this.MIDDLEWARE})`,data:error}}}
if(response.data.session){clog("DEBG",`api.request(${path}): session`,{text:response.data.session,color:oscColor("blue")});localStorage.setItem("session",response.data.session);}
let dom=document.createElement("template");dom.innerHTML=response.data.response;if(dom.content.querySelector(".NoPermission")){if(!renewSession)
throw{code:-1,description:`Phiên làm việc hết hạn hoặc bạn không có quyền truy cập chức năng này!`}
clog("WARN",`api.request(${path}): session expired! requesting new session`);localStorage.removeItem("session");localStorage.removeItem("session.username");return await this.request(arguments[0]);}
let __vs=dom.content.getElementById("__VIEWSTATE");let __vsg=dom.content.getElementById("__VIEWSTATEGENERATOR");let __ev=dom.content.getElementById("__EVENTVALIDATION");if(__vs&&__vs.value!==""){clog("DEBG",`api.request(${path}): update __VIEWSTATE`,{text:truncateString(__vs.value,60),color:oscColor("pink")});this.__VIEWSTATE=__vs.value;}
if(__vsg&&__vsg.value!==""){clog("DEBG",`api.request(${path}): update __VIEWSTATEGENERATOR`,{text:__vsg.value,color:oscColor("pink")});this.__VIEWSTATEGENERATOR=__vsg.value;}
if(__ev&&__ev.value!==""){clog("DEBG",`api.request(${path}): update __EVENTVALIDATION`,{text:__ev.value,color:oscColor("pink")});this.__EVENTVALIDATION=__ev.value;}
if(path===""||path==="/"){this.__LOGOUT_VIEWSTATE=this.__VIEWSTATE;this.__LOGOUT_VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;}
if(dom.content.getElementById("LeftCol_UsersChangePassword1_lblUser")){try{this.logout();}catch(e){}
throw{code:-1,description:`api.request(${path}): CTMS yêu cầu bạn thay đổi mật khẩu, vui lòng thực hiện hành động này trên trang chủ của CTMS`}}
if(!ignoreAnnouncement){let ann=dom.content.getElementById("thongbao");if(ann){await popup.show({windowTitle:"Thông Báo",title:"Thông Báo",icon:"horn",bgColor:"blue",message:`api.request`,description:`${method} ${path}`,customNode:ann,buttonList:{close:{text:"ĐÓNG",color:"blue"}}});}}
if(response.data.response.includes("sát ý kiến sinh viên")){let msg=`Bạn cần hoàn thành <b>Khảo Sát Ý Kiến Sinh Viên</b> về hoạt động giảng dạy của giảng viên để có thể tiếp tục sử dụng CTMS`;await popup.show({windowTitle:"Thông Báo",title:"Thông Báo",icon:"horn",bgColor:"blue",message:`Khảo Sát`,description:msg,buttonList:{survey:{text:"KHẢO SÁT",color:"green",onClick:()=>window.open("http://dbcl.hou.edu.vn/cntt","_blank"),resolve:false},close:{text:"ĐÓNG",color:"blue"}}});throw{code:101,description:msg}}
let data={path,dom:dom.content,c2m:start.tick()-response.runtime,...response.data}
await this.__handleResponse("global",data);return data;},async login({username,password}={}){if(typeof username!=="string"||typeof password!=="string")
throw{code:-1,description:`api.login(): invalid username or password`}
let response=await this.request({path:"/login.aspx",method:"POST",form:{ctl00$LeftCol$UserLogin1$txtUsername:username,ctl00$LeftCol$UserLogin1$txtPassword:md5(password),ctl00$LeftCol$UserLogin1$btnLogin:"Đăng nhập"}});localStorage.setItem("session.username",username);await this.__handleResponse("login",response);return response;},__LOGOUT_VIEWSTATE:undefined,__LOGOUT_VIEWSTATEGENERATOR:undefined,async logout(){if(!this.__LOGOUT_VIEWSTATE||!this.__LOGOUT_VIEWSTATEGENERATOR)
throw{code:-1,description:`api.logout(): cannot perform a logout without viewstate data`}
let response=await this.request({method:"POST",form:{...this.__LOGOUT_FORM,__VIEWSTATE:this.__LOGOUT_VIEWSTATE,__VIEWSTATEGENERATOR:this.__LOGOUT_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__LOGOUT_EVENTVALIDATION,"__CALLBACKID":"ctl00$QuanlyMenu1","__CALLBACKPARAM":"logout"}});this.reset();await this.__handleResponse("logout",response);return response;},resultBadge(point,average=undefined){let letter="?";let color="dark";switch(point){case 4.0:{letter=(average&&average>=9.5)?"A+":"A";color="green";break;}
case 3.5:{letter="B+";color="blue";break;}
case 3.0:{letter="B";color="blue";break;}
case 2.5:{letter="C+";color="yellow";break;}
case 2.0:{letter="C";color="yellow";break;}
case 1.5:{letter="D+";color="orange";break;}
case 1.0:{letter="D";color="orange";break;}
case 0:{letter="F";color="red";break;}}
return{letter,color}},resultGrading(average){let point=0;let passed=true;if(average>=8.5){point=4.0;}else if(average>=8.0){point=3.5;}else if(average>=7.0){point=3.0;}else if(average>=6.5){point=2.5;}else if(average>=5.5){point=2.0;}else if(average>=5.0){point=1.5;}else if(average>=4.0){point=1.0;}else{point=0;passed=false;}
return{point,passed,...this.resultBadge(point,average)}},processResults(results){let grade;let count=0;let totalCPA=0;let totalPoint=0;let credits=0;for(let result of results){if(result.grade&&result.grade.passed&&!result.ignored&&!result.relearned){totalCPA+=result.grade.point*result.credits;credits+=result.credits;if(typeof result.average==="number"){totalPoint+=result.average;count++;}}}
let average=totalPoint/count;let cpa=totalCPA/credits;if(cpa>=3.6)
grade="Xuất Sắc";else if(cpa>=3.2)
grade="Giỏi";else if(cpa>=2.5)
grade="Khá";else if(cpa>=2)
grade="Trung Bình";else
grade="Yếu";return{average,credits,cpa,grade}},async results(){let response=await this.request({path:"/KetquaHoctap.aspx",method:"GET"});response.info={name:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(1) > td:nth-child(2)`).innerText.replace(":\n","").trim().replace("  "," "),birthday:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(1) > td:nth-child(4)`).innerText.replace(":\n","").trim().replace("  "," "),tForm:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(2) > td:nth-child(2)`).innerText.replace(":\n","").trim().replace("  "," "),studentID:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(2) > td:nth-child(4)`).innerText.replace(":\n","").trim().replace("  "," "),faculty:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(3) > td:nth-child(2)`).innerText.replace(":\n","").trim().replace("  "," "),department:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(3) > td:nth-child(4)`).innerText.replace(":\n","").trim().replace("  "," "),course:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(4) > td:nth-child(2)`).innerText.replace(":\n","").trim().replace("  "," "),classroom:response.dom.querySelector(`#leftcontent > table.ThongtinSV > tbody > tr:nth-child(4) > td:nth-child(4)`).innerText.replace(":\n","").trim().replace("  "," "),mode:response.dom.getElementById("leftcontent").childNodes.item(2).wholeText.trim().replace("\n"," "),results:[],average:0,cpa:0,credits:0,grade:"Yếu"}
let resultTableRows=[...response.dom.querySelectorAll(`#leftcontent > table.RowEffect.CenterElement > tbody > tr`)]
let __procPoint=(node)=>{if(!node||!node.tagName)
return undefined;let v=node.innerText.trim();if(v==="")
return undefined;return(v==="?")?"?":parseFloat(v);}
let encountered={}
if(this.HOST_NAME==="kinhte"){let groupingData=[]
for(let row of resultTableRows){let data={subject:row.children[3].innerText.trim(),credits:parseInt(row.children[4].innerText.trim()),classID:row.children[5].innerText.trim(),teacher:row.children[6].innerText.trim(),diemCC:__procPoint(row.children[8]),diemDK:__procPoint(row.children[9]),diemHK:undefined,rawAverage:undefined,average:undefined,grade:undefined,ignored:false,relearned:false}
if(row.children.length===13){if(data.diemCC!=="?"&&data.diemDK!=="?"){let point=parseFloat(row.children[11].innerText.trim())||0;data.ignored=true;data.grade={point,passed:(point>=1),...this.resultBadge(point)}}}else{data.diemHK=__procPoint(row.children[10]);let aCell=row.children[11].innerText.trim();data.average=(aCell.length>0&&aCell!=="?")?parseFloat(aCell):null;}
if(typeof data.diemCC==="number"&&typeof data.diemDK==="number"&&typeof data.diemHK==="number"){if(!data.average){data.rawAverage=data.diemCC*0.1+data.diemDK*0.2+data.diemHK*0.7;data.average=round(round(data.rawAverage,2),1);}else{data.rawAverage=data.average;}
if(!data.grade)
data.grade=this.resultGrading(data.average);}
let year=row.children[1].innerText.trim();let semester=row.children[2].innerText.trim();if(year.length>0&&semester.length>0){semester=parseInt({"I":1,"II":2,"III":3}[semester]||semester);year=parseInt(year.split("-")[semester===1?0:1]);let index;for(let i=0;i<groupingData.length;i++){if(groupingData[i].year===year&&groupingData[i].semester===semester){index=i;break;}}
if(typeof index!=="number"){index=groupingData.push({year,semester,classID:[]})-1;}
if(!groupingData[index].classID.includes(data.classID))
groupingData[index].classID.push(data.classID);}
let index=response.info.results.push(data)-1;let iden=data.subject.toLowerCase();if(data.average){if(!encountered[iden]){encountered[iden]={index,average:data.average}}else{if(encountered[iden].average>data.average){data.relearned=true;}else{response.info.results[encountered[iden].index].relearned=true;encountered[iden]={index,average:data.average}}}}}
localStorage.setItem("results.grouping",JSON.stringify(groupingData));}else{for(let row of resultTableRows){let data={subject:row.children[0].innerText.trim(),credits:parseInt(row.children[1].innerText.trim()),classID:row.children[2].innerText.trim(),teacher:row.children[3].innerText.trim(),diemCC:__procPoint(row.children[4]),diemDK:__procPoint(row.children[5]),diemHK:__procPoint(row.children[6]),rawAverage:undefined,average:undefined,grade:undefined,ignored:false,relearned:false}
if(typeof data.diemCC==="number"&&typeof data.diemDK==="number"&&typeof data.diemHK==="number"){data.rawAverage=data.diemCC*0.1+data.diemDK*0.2+data.diemHK*0.7;data.average=round(round(data.rawAverage,2),1);data.grade=this.resultGrading(data.average);}
let index=response.info.results.push(data)-1;let iden=data.subject.toLowerCase();if(data.average){if(!encountered[iden]){encountered[iden]={index,average:data.average}}else{if(encountered[iden].average>data.average){data.relearned=true;}else{response.info.results[encountered[iden].index].relearned=true;encountered[iden]={index,average:data.average}}}}}}
for(let item of response.info.results){for(let ignore of this.resultIgnoreList){if(item.subject.toLowerCase().indexOf(ignore)!==-1){item.ignored=true;break;}}}
response.info=Object.assign(response.info,this.processResults(response.info.results));await this.__handleResponse("results",response);return response;},async services(){let response=await this.request({path:"/services/BuyServices.aspx",method:"GET"});let dvList=[...response.dom.querySelectorAll("div.dichvu")].map(e=>{let s=e.children[2]
if(s&&s.title!==""){let t=s.title.substring(1,s.title.length-1).split("-").map(i=>{let t=/(\d+)\/(\d+)\/(\d+) (\d+)\:(\d+)/gm.exec(i);return new Date(t[3],parseInt(t[2])-1,t[1],t[4],t[5]);});return{from:t[0],to:t[1]}}else
return null;});response.info={email:response.dom.querySelector(`#LeftCol_MuaDichVu1_pnWrapperModule > table > tbody > tr:nth-child(1) > td:nth-child(2)`).innerText.trim(),occ:response.dom.querySelector(`#LeftCol_MuaDichVu1_pnWrapperModule > table > tbody > tr:nth-child(2) > td:nth-child(2)`).innerText.trim(),services:{basicAccess:dvList[0],unverifiedScore:dvList[1],payAsk:dvList[2],coupleCheckIn:dvList[3],shortAccess:dvList[4]}}
await this.__handleResponse("services",response);return response;},__HOME_VIEWSTATE:undefined,__HOME_VIEWSTATEGENERATOR:undefined,__HOME_EVENTVALIDATION:undefined,__HOME_DATE:undefined,async home(date){let response;if(typeof date!=="undefined"){this.__HOME_DATE=`${date.getFullYear()}-${pleft(date.getMonth() + 1, 2)}-${date.getDate()}`;response=await this.request({path:"/index.aspx",method:"POST",form:{__VIEWSTATE:this.__HOME_VIEWSTATE,__VIEWSTATEGENERATOR:this.__HOME_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__HOME_EVENTVALIDATION,"ctl00$LeftCol$ThoikhoabieuWeekView1$ddlCosoDaotao":0,"ctl00$LeftCol$ThoikhoabieuWeekView1$cboKhunggio":0,"ctl00$LeftCol$ThoikhoabieuWeekView1$txtNgaydautuan":this.__HOME_DATE,"ctl00$LeftCol$ThoikhoabieuWeekView1$btnOK":"Xem thời khóa biểu","ctl00$LeftCol$ThoikhoabieuWeekView1$ddlKhunggio2":1,"ctl00$LeftCol$ThoikhoabieuWeekView1$txtNgay2":"","ctl00$LeftCol$ThoikhoabieuWeekView1$txtTongsoBuoihoc":"","ctl00$LeftCol$ThoikhoabieuWeekView1$txtKhoangcach":7,"ctl00$LeftCol$ThoikhoabieuWeekView1$txtNgay4Edit":""}});}else{response=await this.request({path:"/index.aspx",method:"GET"});}
this.__HOME_VIEWSTATE=this.__VIEWSTATE;this.__HOME_VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;this.__HOME_EVENTVALIDATION=this.__EVENTVALIDATION;response.date=null;let dateInput=response.dom.getElementById(`LeftCol_ThoikhoabieuWeekView1_txtNgaydautuan`);if(dateInput){dateInput=dateInput.value.split("-");response.date=new Date(dateInput[0],dateInput[1]-1,dateInput[2],0,0,0);}
let table=response.dom.getElementById("LeftCol_ThoikhoabieuWeekView1_grvThoikhoabieu");response.info=Array();let header=[...table.querySelectorAll(`:scope > tbody > tr:first-child > th`)];header.shift();for(let column of header){let tokens=/([^0-9]+)(\d+\/\d+\/\d+)/gm.exec(column.innerText.trim());if(!tokens)
continue;let timeToken=tokens[2].split("/");let date=new Date(timeToken[2],timeToken[1]-1,timeToken[0]);response.info.push({dateString:tokens[2],weekDay:tokens[1],date,time:`${tokens[2]} ${tokens[1]}`,rows:Array()});}
let classroomRows=table.querySelectorAll(`:scope > tbody > tr:not(:first-child)`);for(let classroomRow of classroomRows){let classroom=classroomRow.children[0].innerText.trim();for(let i=1;i<classroomRow.children.length;i++){if(typeof response.info[i-1]==="undefined")
continue;let timeToken=response.info[i-1].dateString.split("/");let cell=classroomRow.children[i];let subjects=cell.querySelectorAll(`:scope > table`);for(let subject of subjects){let tokens=subject.querySelectorAll(`:scope > tbody > tr > td`);let rowTime=tokens[0].innerText.trim().replace(" ->"," -> ").split(" -> ");let timeStartToken=rowTime[0].split(":");let timeEndToken=rowTime[1].split(":");let startDate=new Date(timeToken[2],timeToken[1]-1,timeToken[0],timeStartToken[0],timeStartToken[1]);let endDate=new Date(timeToken[2],timeToken[1]-1,timeToken[0],timeEndToken[0],timeEndToken[1]);let subjectName=(tokens[1].children.length!==0)?`${tokens[1].children[0].title} (${tokens[1].innerText.trim()})`:null;response.info[i-1].rows.push({time:rowTime,date:[startDate,endDate],classroom,subject:subjectName,teacher:tokens[2].innerText.trim(),classID:tokens[3].innerHTML.trim().replace(/\[|\]/g,"").split("<br>"),status:tokens[4].innerText.trim(),listID:null,noteID:null});}
response.info[i-1].rows.sort((a,b)=>a.date[0]-b.date[0]);}}
await this.__handleResponse("home",response);return response;},__SCHEDULE_VIEWSTATE:undefined,__SCHEDULE_VIEWSTATEGENERATOR:undefined,__SCHEDULE_EVENTVALIDATION:undefined,__SCHEDULE_DATE:undefined,async schedule(date,{triggerEvents=true}={}){let response;if(typeof date!=="undefined"){this.__SCHEDULE_DATE=`${date.getFullYear()}-${pleft(date.getMonth() + 1, 2)}-${date.getDate()}`;response=await this.request({path:"/Lichhoc.aspx",method:"POST",form:{__VIEWSTATE:this.__SCHEDULE_VIEWSTATE,__VIEWSTATEGENERATOR:this.__SCHEDULE_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__SCHEDULE_EVENTVALIDATION,ctl00$LeftCol$Lichhoc1$txtNgaydautuan:this.__SCHEDULE_DATE,ctl00$LeftCol$Lichhoc1$btnXemlich:"Xem lịch"}});}else{response=await this.request({path:"/Lichhoc.aspx",method:"GET"});this.__SCHEDULE_DATE=response.dom.getElementById("LeftCol_Lichhoc1_txtNgaydautuan").value;}
this.__SCHEDULE_VIEWSTATE=this.__VIEWSTATE;this.__SCHEDULE_VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;this.__SCHEDULE_EVENTVALIDATION=this.__EVENTVALIDATION;response.date=null;let dateInput=response.dom.getElementById(`LeftCol_Lichhoc1_txtNgaydautuan`);if(dateInput){dateInput=dateInput.value.split("-");response.date=new Date(dateInput[0],dateInput[1]-1,dateInput[2],0,0,0);}
response.billAlert=!!response.dom.getElementById("LeftCol_pnlMessage");response.info=Array();for(let i=0;i<=8;i++){let table=response.dom.getElementById(`LeftCol_Lichhoc1_rptrLichhoc_grvLichhoc_${i}`);if(!table)
continue;let time=table.parentElement.parentElement.children[0].innerText.replaceAll("\n","").replace(/\s\s+/g," ").trim();let dateString=time.split(" ").pop();let weekDay=time.replace(` ${dateString}`,"");let timeToken=dateString.split("/");let date=new Date(timeToken[2],timeToken[1]-1,timeToken[0]);let item={time,date,dateString,weekDay,rows:[]}
let rows=table.querySelectorAll(`tbody > tr:not(:first-child)`);for(let row of[...rows]){let classCol=row.children[5].innerHTML.trim().split("<br>");let checkInID=undefined;let noteID=null;let note=row.children[6].querySelector(":scope > span > a[href]");let rowTime=row.children[1].innerText.trim().replace(" ->"," -> ").split(" -> ");let timeStartToken=rowTime[0].split(":");let timeEndToken=rowTime[1].split(":");let startDate=new Date(timeToken[2],timeToken[1]-1,timeToken[0],timeStartToken[0],timeStartToken[1]);let endDate=new Date(timeToken[2],timeToken[1]-1,timeToken[0],timeEndToken[0],timeEndToken[1]);if(note&&note.children[0]&&note.children[0].title==="Đã có ghi chú"){let noteRe=/javascript:getNote\((\d+)\);/gm.exec(note.href);if(noteRe)
noteID=parseInt(noteRe[1]);}
let checkInTest=/InDsDiemdanh\.aspx\?loptcID=(\d+)\" title=""\>([^<>]+)\<\/a>/gm.exec(classCol[0]);if(checkInTest){classCol[0]=checkInTest[2];checkInID=parseInt(checkInTest[1]);}
item.rows.push({time:rowTime,date:[startDate,endDate],classroom:row.children[2].innerText.trim(),subject:row.children[3].innerText.trim(),teacher:row.children[4].innerText.trim(),classID:classCol[0],listID:classCol[1],checkInID,status:row.children[6].innerText.trim(),noteID});}
item.rows=item.rows.sort((a,b)=>a.date[0]-b.date[0]);response.info.push(item);}
if(triggerEvents)
await this.__handleResponse("schedule",response);return response;},async getNote(id){if(!this.__SCHEDULE_DATE||!this.__SCHEDULE_EVENTVALIDATION)
throw{code:-1,description:`api.getNote(): a prefetch request to api.schedule() is required to use this api`}
let response=await this.request({path:"/Lichhoc.aspx",method:"POST",form:{__VIEWSTATE:this.__SCHEDULE_VIEWSTATE,__VIEWSTATEGENERATOR:this.__SCHEDULE_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__SCHEDULE_EVENTVALIDATION,__CALLBACKID:"ctl00$LeftCol$Lichhoc1",__CALLBACKPARAM:`get-note$${id}`,ctl00$LeftCol$Lichhoc1$txtNgaydautuan:"2021-07-12"}});let hashLength=parseInt(response.response.split("|")[0]);let cleanRes=response.response.replace(`${hashLength}|`,"").substring(hashLength);response.data={content:cleanRes}
await this.__handleResponse("getNote",response);return response;},async getCheckIn(id,studentID){let response=await this.request({path:`/InDsDiemdanh.aspx?loptcID=${id}`,method:"GET"});let row;let table=response.dom.querySelector("table.CenterElement");if(!table)
throw{code:-1,description:`api.getCheckIn(): could not find target table!`}
if(studentID){let rows=table.querySelectorAll(":scope > tbody > tr");for(let r of rows){if(r.children[1].innerText.trim()===studentID){row=r;break;}}}else{row=table.querySelector(":scope > tbody > tr");}
if(!row)
throw{code:-1,description:`api.getCheckIn(${studentID || ""}): could not find matching row data`}
let checkInLength=row.children.length-7;let checkIn=[]
for(let i=0;i<checkInLength;i++){checkIn.push({status:"unknown",label:"?"});}
response.data={nth:parseInt(row.children[0].innerText),healthDeclared:row.children[6].children[0].checked,checkIn}
return response;},__TESTS_VIEWSTATE:undefined,__TESTS_VIEWSTATEGENERATOR:undefined,__TESTS_EVENTVALIDATION:undefined,async tests(type){let option={all:"rbtnTatca",ended:"rbtnDathi",coming:"rbtnChuathi"}[type]
if(!this.__TESTS_VIEWSTATE){clog("DEBG","api.tests(): Starting prefetch request");await this.request({path:`/Lichthi.aspx`});this.__TESTS_VIEWSTATE=this.__VIEWSTATE;this.__TESTS_VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;this.__TESTS_EVENTVALIDATION=this.__EVENTVALIDATION;}
let response=await this.request({path:`/Lichthi.aspx`,method:"POST",form:{__VIEWSTATE:this.__TESTS_VIEWSTATE,__VIEWSTATEGENERATOR:this.__TESTS_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__TESTS_EVENTVALIDATION,ctl00$LeftCol$Lichthi1$Tuychon:option,ctl00$LeftCol$Lichthi1$btnHien:"   Hiện   "}});let list=[]
let curTime=time();let rows=response.dom.querySelectorAll(`#leftcontent > table > tbody > tr:not(:first-child)`);for(let row of rows){let time=row.children[1].innerText.trim();time=/(\d+)\:(\d+) (\d+)\/(\d+)\/(\d+)/gm.exec(time);time=new Date(time[5],parseInt(time[4])-1,time[3],time[1],time[2]);list.push({status:((time.getTime()/1000)<curTime)?"ended":"coming",time,classroom:row.children[2].innerText.trim(),subject:row.children[3].innerText.trim(),listID:row.children[4].innerText.trim()});}
list=list.sort((a,b)=>b.time-a.time);response.list=list;await this.__handleResponse("tests",response);return response;},__SUBS_VIEWSTATE:undefined,__SUBS_VIEWSTATEGENERATOR:undefined,__SUBS_EVENTVALIDATION:undefined,__SUBS_STUDENTID:undefined,parseSubscribe(node){let rows=node.querySelectorAll(":scope > tbody > tr:not(:first-child)");let items=[]
let checkNoAction=node.querySelector(":scope > tbody > tr:first-child > th:first-child");let isNoAction=false;if(checkNoAction.innerText.trim()==="Tên lớp")
isNoAction=true;for(let row of rows){let item={expired:false,isFull:false,classID:undefined,subject:undefined,teacher:undefined,credits:undefined,tuition:undefined,minimum:undefined,maximum:undefined,subscribed:undefined,schedule:[],classroom:[],action:{command:undefined,data:undefined,classID:undefined},date:{start:undefined,end:undefined,cancel:undefined}}
let cellStart=isNoAction?-1:0;if(!isNoAction){let firstCell=row.children[0];if(firstCell.innerText.includes("Hết hạn ĐK"))
item.expired=true;if(firstCell.innerText.includes("Hết chỉ tiêu"))
item.isFull=true;let actionBtn=firstCell.querySelector(":scope > a[href]");if(actionBtn){let sub=/javascript:subcrible\((\d+)\, (\d+), (\d+)\)/gm.exec(actionBtn.href);if(sub){item.action.command="subscribe";item.action.classID=parseInt(sub[1]);}
let unsub=/javascript:unSubcrible\((\d+)\,(\d+)\)/gm.exec(actionBtn.href);if(unsub){item.action.command="unsubscribe";item.action.classID=parseInt(unsub[1]);}}else{let conditionBtn=firstCell.querySelector(":scope > img[title]");if(conditionBtn){item.action.command="condition";item.action.data=conditionBtn.getAttribute("title");}}}
item.classID=row.children[cellStart+1].innerText.trim();let secondCell=row.children[cellStart+2].innerText.trim();let secondCellLines=secondCell.split("\n").map(i=>i.trim()).filter(i=>i.length>2);let subjectLine=/(.+) \((\d+) tc\)/gm.exec(secondCell);item.subject=subjectLine[1];item.credits=parseInt(subjectLine[2]);let tuitionLine=/Học phí: (\d+)\*1000 \(đ\)/gm.exec(secondCell);if(tuitionLine){item.tuition=parseInt(tuitionLine[1])*1000;if(secondCellLines.length===2){item.teacher="Không Có Giảng Viên";}else{item.teacher=secondCellLines[1];}}else{if(secondCellLines.length>=2){item.teacher=secondCellLines[1];}else{item.teacher="Không Có Giảng Viên";}}
item.minimum=parseInt(row.children[cellStart+3].innerText.trim().replace(" sv",""));item.maximum=parseInt(row.children[cellStart+4].innerText.trim().replace(" sv",""));item.subscribed=parseInt(row.children[cellStart+5].innerText.trim().replace(" sv",""));let timeCell=[...row.children[cellStart+6].innerText.trim().matchAll(/(\d+):(\d+) (\d+)\/(\d+)\/(\d+)/gm)];for(let i=0;i<timeCell.length;i++){let cell=timeCell[i];let parsedTime=new Date("20"+cell[5],parseInt(cell[4])-1,cell[3],cell[1],cell[2]);if(i===0)
item.date.start=parsedTime;else if(i===1)
item.date.end=parsedTime;else if(i===2)
item.date.cancel=parsedTime;}
let scheduleCell=row.children[cellStart+7].querySelectorAll(`:scope > ul > li`);for(let line of scheduleCell){let t=line.innerText.replaceAll("\n","").replace(/\s\s+/g," ").trim();let c=t.split(" - ")[1];if(!item.classroom.includes(c))
item.classroom.push(c);item.schedule.push(t);}
if(isNoAction){if(time(item.date.end)<time())
item.expired=true;if(item.subscribed>=item.maximum)
item.isFull=true;}
items.push(item);}
return items;},async subscribe({action="getmodule",classID}={}){if(!this.__SUBS_VIEWSTATE){clog("DEBG","api.subscribe(): Starting prefetch request");let response=await this.request({path:`/DangkyLoptinchi.aspx`,ignoreAnnouncement:true});this.__SUBS_VIEWSTATE=this.__VIEWSTATE;this.__SUBS_VIEWSTATEGENERATOR=this.__VIEWSTATEGENERATOR;this.__SUBS_EVENTVALIDATION=this.__EVENTVALIDATION;let studentID=/"getmodule:" \+ (\d+)\;/gm.exec(response.response);if(!studentID)
throw{code:-1,description:`api.subscribe(): student id not found`}
this.__SUBS_STUDENTID=parseInt(studentID[1]);clog("INFO",`api.subscribe(): Got student ID: ${this.__SUBS_STUDENTID}`);}
let args;let callID;switch(action){case"getmodule":callID="__Page";args=`getmodule:${this.__SUBS_STUDENTID}`;break;case"subscribe":callID="ctl00$LeftCol$LoptinchiDangky1";args=`subcrible:${classID}:${this.__SUBS_STUDENTID}`;break;case"unsubscribe":callID="ctl00$LeftCol$LoptinchiDangky1";args=`unsubcrible:${classID}:${this.__SUBS_STUDENTID}`;break;case"subscribed":callID="ctl00$LeftCol$LoptinchiDangky1";args=`list:${this.__SUBS_STUDENTID}`;break;default:throw{code:-1,description:`api.subscribe(): undefined command: ${command}`}}
clog("DEBG","api.subscribe(): args",args||"empty");let response=await this.request({path:"/DangkyLoptinchi.aspx",method:"POST",form:{__CALLBACKID:callID,__CALLBACKPARAM:args,__VIEWSTATE:this.__SUBS_VIEWSTATE,__VIEWSTATEGENERATOR:this.__SUBS_VIEWSTATEGENERATOR,__EVENTVALIDATION:this.__SUBS_EVENTVALIDATION,}});let errorRe1=/^e(.+)(\d+)\|$/gm.exec(response.response.trim());if(errorRe1)
throw{code:parseInt(errorRe1[2]),description:`api.subscribe(${args}): ${errorRe1[1]}`}
let errorRe2=/^(\d+)\|(.*)$/g.exec(response.response.trim());if(errorRe2&&errorRe2[2]==="")
throw{code:-1,description:`api.subscribe(${args}): got empty response, maybe subscribing has failed`}
if(errorRe2&&errorRe2[2].includes("Lỗi:"))
throw{code:-1,description:`api.subscribe(${args}): ${errorRe2[2]}`}
let haveCanSubscribe=response.response.includes("có thể đăng ký");let haveSubscribed=response.response.includes("vừa đăng ký");let tables=response.dom.querySelectorAll("table[border]");clog("DEBG","api.subscribe(): data",{haveCanSubscribe,haveSubscribed});if(haveCanSubscribe&&haveSubscribed){response.waiting=this.parseSubscribe(tables[0]);response.subscribed=this.parseSubscribe(tables[1]);}else if(haveCanSubscribe)
response.waiting=this.parseSubscribe(tables[0]);else if(haveSubscribed)
response.subscribed=this.parseSubscribe(tables[0]);await this.__handleResponse("subscribe",response);return response;},reset(){this.__VIEWSTATE=undefined;this.__VIEWSTATEGENERATOR=undefined;this.__EVENTVALIDATION=undefined;this.__LOGOUT_VIEWSTATE=undefined;this.__LOGOUT_VIEWSTATEGENERATOR=undefined;this.__HOME_VIEWSTATE=undefined;this.__HOME_VIEWSTATEGENERATOR=undefined;this.__HOME_EVENTVALIDATION=undefined;this.__HOME_DATE=undefined;this.__SCHEDULE_VIEWSTATE=undefined;this.__SCHEDULE_VIEWSTATEGENERATOR=undefined;this.__SCHEDULE_EVENTVALIDATION=undefined;this.__TESTS_VIEWSTATE=undefined;this.__TESTS_VIEWSTATEGENERATOR=undefined;this.__TESTS_EVENTVALIDATION=undefined;this.__SUBS_VIEWSTATE=undefined;this.__SUBS_VIEWSTATEGENERATOR=undefined;this.__SUBS_EVENTVALIDATION=undefined;this.__SUBS_STUDENTID=undefined;}}
var APPNAME="CTMS+";var VERSION="0.1";var STATE="local";var DEBUG=true;class CoreScreen{constructor({id="sample",icon="circle",title="sample screen",description="this is a sample screen description",subTitle="",applyScrollable=true}={}){this.id=id;this.showing=false;this.overlayShowing=false;this.reloadHandlers=[]
this.showHandlers=[]
this.hideHandlers=[]
this.button=core.navbar.switch.component.button({icon,tooltip:{title,description}});this.view=makeTree("div",["screen",id],{loading:new LoadingOverlay(undefined,{index:12}),overlay:{tag:"div",class:"overlay",child:{icon:{tag:"icon"},oTitle:{tag:"t",class:"title"},description:{tag:"t",class:"description"},buttons:{tag:"div",class:"buttons"}}},header:{tag:"div",class:"header",child:{icon:{tag:"icon",data:{icon}},detail:{tag:"span",class:"detail",child:{sTitle:{tag:"t",class:"title",text:title},subTitle:{tag:"t",class:"subTitle",html:subTitle}}},buttons:{tag:"span",class:"buttons",child:{reload:createButton("TẢI LẠI",{style:"big",icon:"reload",complex:true})}}}},content:{tag:"div",class:"content"}});if(applyScrollable)
new Scrollable(this.view,{content:this.view.content});this.view.header.buttons.reload.style.display="none";this.view.header.buttons.reload.addEventListener("click",async()=>{this.view.header.buttons.reload.loading(true);try{for(let f of this.reloadHandlers)
await f();}catch(error){errorHandler(error);}
this.view.header.buttons.reload.loading(false);});this.view.overlay.style.display="none";this.button.click.setHandler((a)=>a?this.__show():this.__hide());}
show(){this.button.click.active=true;}
async __show(){this.showing=true;if(core.activeScreen)
core.activeScreen.hide();await delayAsync();core.screen.container.appendChild(this.view);this.showHandlers.forEach(f=>f());}
onShow(f){if(typeof f!=="function")
throw{code:-1,description:`CoreScreen(${this.id}).onShow(): not a valid function`}
this.showHandlers.push(f);}
hide(){this.button.click.active=false;}
__hide(){this.showing=false;if(core.screen.container.contains(this.view))
core.screen.container.removeChild(this.view);this.hideHandlers.forEach(f=>f());}
onHide(f){if(typeof f!=="function")
throw{code:-1,description:`CoreScreen(${this.id}).onHide(): not a valid function`}
this.hideHandlers.push(f);}
onReload(f){if(typeof f!=="function")
throw{code:-1,description:`CoreScreen(${this.id}).onReload(): not a valid function`}
this.view.header.buttons.reload.style.display=null;this.reloadHandlers.push(f);}
addButton(button){if(typeof button!=="object"||!button.tagName)
throw{code:-1,description:`CoreScreen(${this.id}).addButton(): not a valid node`}
this.view.header.buttons.insertBefore(button,this.view.header.buttons.firstChild);}
set({icon,title,subTitle}={}){if(typeof icon==="string")
this.view.header.icon.dataset.icon=icon;if(typeof title==="string"){this.view.header.detail.sTitle.innerText=title;this.button.navtip.set({title});}else if(typeof title==="object"&&title.tagName){emptyNode(this.view.header.detail.sTitle);this.view.header.detail.sTitle.appendChild(title);}
if(typeof subTitle==="string")
this.view.header.detail.subTitle.innerHTML=subTitle;}
overlay({show=true,icon="circle",title="Screen Overlay Example",description=" This is an example of screen overlay, which is immortal 😇",buttons={}}={}){if(!show){this.view.overlay.style.display="none";this.overlayShowing=false;return;}
this.overlayShowing=true;this.view.overlay.style.display=null;this.view.overlay.icon.dataset.icon=icon;this.view.overlay.oTitle.innerText=title;this.view.overlay.description.innerHTML=description;emptyNode(this.view.overlay.buttons);for(let key of Object.keys(buttons)){let b=createButton(buttons[key].text,{color:buttons[key].color||"blue",style:"big",icon:buttons[key].icon,complex:true});if(typeof buttons[key].onClick==="function")
b.addEventListener("click",async()=>{b.loading(true);try{await buttons[key].onClick();}catch(e){errorHandler(e);}
b.loading(false);});this.view.overlay.buttons.appendChild(b);}}
handleError(e,onRetry=async()=>{}){let error=parseException(e);if(error.description.includes("Phiên làm việc hết hạn")){this.overlay({icon:"unlink",title:"Không Có Quyền Truy Cập!",description:`Phiên làm việc của bạn đã hết hạn hoặc bạn không có quyền truy cập chức năng này. `,buttons:{retry:{text:"THỬ LẠI",color:"pink",icon:"reload",onClick:async()=>await onRetry()},renew:{text:"Làm Mới Phiên",color:"blue",icon:"signin",onClick:async()=>await core.account.renew()}}});}else{this.overlay({icon:"bomb",title:"Toang Rồi Ông Giáo Ạ!",description:`<pre class="break">[${error.code}] >>> ${error.description}</pre>`,buttons:{retry:{text:"THỬ LẠI",color:"pink",icon:"reload",onClick:async()=>await onRetry()}}});}}
set loading(loading){this.view.loading.loading=loading;}
set content(content){this.view.overlay.style.display="none";emptyNode(this.view.content);if(typeof content==="object"&&content.classList)
this.view.content.appendChild(content);else
this.view.content.innerHTML=content;}}
var core={container:$("#container"),content:$("#content"),activeScreen:null,async init(set=()=>{}){let start=time();ConnectionState.container=this.container;await initGroup(this,"core",({p,m,d})=>{clog("DEBG",{color:oscColor("pink"),text:truncateString(m,34),padding:34,separate:true},d);set({p,m,d});});set({p:100,m:"core",d:"CTMS+ Core Loaded"});this.initialized=true;clog("OKAY",{color:oscColor("pink"),text:"core",padding:34,separate:true},`CTMS+ Core Loaded In ${time() - start}s`);if(typeof gtag==="function")
gtag("event","loaded",{loadtime:time()-start});},serviceWorker:{registration:undefined,async init(){if(!navigator||!navigator.serviceWorker||typeof navigator.serviceWorker.register!=="function")
return false;try{this.registration=await navigator.serviceWorker.register("/service-worker.js",{scope:"/"});this.log("OKAY","Service Worker registered",this.registration);}catch(e){this.log("WARN",e);}},async update(){await this.registration.update();this.log("OKAY","Service Worker updated",this.registration);}},popup:{priority:0,init:()=>popup.init()},toast:{priority:0,init:()=>toast.init(core.container)},metadata:{priority:0,async init(set){try{set({p:0,d:`Fetching Metadata`});let response=await myajax({url:"metadata.json",method:"GET"});set({p:100,d:`Updating Metadata`});window.META=response;window.APPNAME=response.name;window.VERSION=response.version;window.STATE=response.branch;window.REPORT_ERROR=response.link.report;window.SERVER={REPORT_ERROR:window.REPORT_ERROR};window.REPO_ADDRESS=response.link.repo;window.DEBUG=(META.branch==="development");ConnectionState.NAME=window.APPNAME;let lastVersion=localStorage.getItem("version");if(lastVersion&&lastVersion!==window.VERSION){core.serviceWorker.update();toast.show("đã cập nhật",`${window.VERSION} - ${window.STATE}`,{hint:`từ ${lastVersion}`});}
localStorage.setItem("version",window.VERSION);if(DEBUG)
this.log("INFO","Development Mode Enabled. Detailed logs will be printed in verbose level.");}catch(e){throw{code:-1,description:"Cannot fetch metadata files! Commiting sudoku...",data:e}}}},tooltip:{priority:0,init(set){set({p:0,d:`Initializing Tooltip`});tooltip.init();}},https:{priority:0,init(){if(location.protocol!=="https:"){this.log("WARN","Page is not served through https! Anyone can easily alter your data!");return false;}
let upgradeInsecure=document.createElement("meta");upgradeInsecure.httpEquiv="Content-Security-Policy";upgradeInsecure.content="upgrade-insecure-requests";document.head.appendChild(upgradeInsecure);}},darkmode:{priority:4,enabled:false,toggleHandlers:[],metaNode:undefined,init(){this.metaNode=document.createElement("meta");this.metaNode.name="theme-color";document.head.appendChild(this.metaNode);this.update();},set(dark){this.enabled=dark;if(this.initialized)
this.update();},onToggle(f){if(!f||typeof f!=="function")
throw{code:-1,description:`core.Panel().button(${icon}).onClick(): not a valid function`}
this.toggleHandlers.push(f);f(this.enabled);},update(){this.toggleHandlers.forEach(f=>f(this.enabled));document.body.classList[this.enabled?"add":"remove"]("dark");this.metaNode.content=this.enabled?"#212121":"#ffffff";}},sounds:{priority:3,__set:()=>{},__clog:window.clog,handlers:[],async init(set,{clog}={}){if(typeof set==="function")
this.__set=set;if(typeof clog==="function")
this.__clog=clog;await sounds.init(({p,m,d,c}={})=>{this.__set({p,m,d});this.handlers.forEach(f=>f({p,m,d,c}));},{clog:this.__clog});},attach(f){if(typeof f!=="function")
throw{code:-1,description:`core.sounds.attach(): not a valid function`}
return this.handlers.push(f);}},wavec:{priority:1,container:$("#waveContainer"),browser:undefined,iframe:undefined,init(){wavec.init(this.container);this.iframe=document.createElement("iframe");this.iframe.id="browser";this.browser=new WaveContainer(this.iframe,{icon:"globe"});this.iframe.addEventListener("loadstart",()=>this.browser.loading=true);this.iframe.addEventListener("load",()=>this.browser.loading=false);this.browser.onToggle((showing)=>{if(!showing){setTimeout(()=>this.iframe.src="about:blank",1000);}});},browse(url){this.iframe.src=url;this.browser.set({title:url});this.browser.show();}},navbar:{priority:1,container:$("#navbar"),title:navbar.title({icon:"./static/img/icon.png",title:APPNAME}),menu:navbar.menuButton({tooltip:{title:"settings",description:`thay đổi cài đặt của ${APPNAME}`}}),init(set){set({p:0,d:"Setting Up Navigation Bar"});navbar.init(this.container);set({p:20,d:"Adding Default Navigation Bar Modules"});smenu.onShow(()=>{this.menu.click.setActive(true);this.title.click.setActive(true);});smenu.onHide(()=>{this.menu.click.setActive(false);this.title.click.setActive(false);});this.menu.click.setHandler((active)=>(active)?smenu.show():smenu.hide());this.menu.click.onClick((active)=>(active)?smenu.setAlignment("right"):"");navbar.insert(this.title,"left");navbar.insert(this.menu,"right");this.title.click.setHandler((active)=>{if(active)
smenu.setAlignment("left");this.menu.click.active=active});},switch:{component:navbar.switch(),schedule:null,tests:null,results:null,init(){navbar.insert(this.component,"left");core.darkmode.onToggle((dark)=>this.component.set({color:dark?"dark":"whitesmoke"}));}},},userSettings:{priority:2,container:$("#userSettings"),init(set){set({p:0,d:"Setting Up User Settings Panel"});smenu.init(this.container,{title:"cài đặt",description:`thay đổi cách ${APPNAME} hoạt động`});smenu.onShow(()=>{core.content.classList.add("parallax");core.content.dataset.direction=smenu.align;});smenu.onHide(()=>{core.content.classList.remove("parallax");core.content.dataset.direction=smenu.align;});if(["beta","indev","debug","test","development"].includes(STATE)){new smenu.components.Note({level:"warning",message:`
						Đây là bản thử nghiệm không ổn định dùng để kiểm tra tính ổn định trước khi xuất bản!<br>
						Nếu bạn tìm thấy lỗi, hãy báo cáo lỗi tại link ở phần <b>LIÊN KẾT NGOÀI</b> bên dưới!
					`},new smenu.Child({label:"Cảnh Báo"},new smenu.Group({icon:"exclamation",label:"thử nghiệm"})))}},server:{group:smenu.Group.prototype,init(){this.group=new smenu.Group({label:"máy chủ",icon:"server"});}},display:{group:smenu.Group.prototype,animator:null,currentZoom:1,init(){this.group=new smenu.Group({label:"hiển thị",icon:"window"});let ux=new smenu.Child({label:"Giao Diện"},this.group);new smenu.components.Checkbox({label:"Chế độ ban đêm",color:"pink",save:"display.nightmode",defaultValue:false,toast:true,onChange:(v)=>core.darkmode.set(v)},ux);new smenu.components.Checkbox({label:"Hoạt ảnh",color:"blue",save:"display.transition",defaultValue:true,toast:true,onChange:(v)=>document.body.classList[v?"remove":"add"]("disableTransition")},ux);new smenu.components.Checkbox({label:"Bảng cài đặt bên trái",color:"blue",save:"display.leftSmenu",defaultValue:false,onChange:(v)=>{core.navbar.menu.container.style.display=v?"none":null;smenu.setAlignment(v?"left":"right");core.content.dataset.direction=v?"left":"right";}},ux);new smenu.components.Slider({label:"Kích cỡ giao diện",color:"blue",min:0.6,max:1.2,step:0.1,defaultValue:checkAgentMobile()?0.8:1,save:"display.scale",toast:true,onChange:(v)=>this.changeZoom(v)},ux);let other=new smenu.Child({label:"Khác"},this.group);new smenu.components.Checkbox({label:"Thông báo",color:"pink",save:"display.notification",defaultValue:false,disabled:true},other);new smenu.components.Checkbox({label:"super triangles! (mobile)",color:"blue",save:"display.supertriangles",defaultValue:false},other);},changeZoom(zoom){if(this.animator)
this.animator.cancel();let begin=this.currentZoom;let delta=zoom-this.currentZoom;this.animator=new Animator(1,Easing.OutQuart,(v)=>{this.currentZoom=begin+(delta*v);core.container.style.zoom=this.currentZoom;});this.animator.onComplete(()=>this.animator=null);}},sounds:{group:smenu.Group.prototype,init(){this.group=new smenu.Group({label:"âm thanh",icon:"volume"});let status=new smenu.Child({label:"Trạng Thái"},this.group);let loadDetail=new smenu.components.Text({content:"Chưa khởi tạo âm thanh"});status.insert(loadDetail,-3);core.sounds.attach(({c}={})=>{if(typeof c==="string")
loadDetail.content=c});let volume=new smenu.components.Slider({label:"Âm lượng",color:"blue",save:"sounds.volume",min:0,max:100,unit:"%",defaultValue:60});status.insert(volume,-1);volume.onInput((v)=>{sounds.volume=(v/100);volume.set({color:(v>=80)?"red":"blue"})});let cat=new smenu.Child({label:"Loại"},this.group);let mouseOver=new smenu.components.Checkbox({label:"Mouse Over",color:"blue",save:"sounds.mouseOver",defaultValue:true,onChange:(v)=>sounds.enable.mouseOver=v},cat);let btnClick=new smenu.components.Checkbox({label:"Button Click/Toggle",color:"blue",save:"sounds.btnClick",defaultValue:true,onChange:(v)=>sounds.enable.btnClick=v},cat);let panelToggle=new smenu.components.Checkbox({label:"Panel Show/Hide",color:"blue",save:"sounds.panelToggle",defaultValue:true,onChange:(v)=>sounds.enable.panelToggle=v},cat);let others=new smenu.components.Checkbox({label:"Others",color:"blue",save:"sounds.others",defaultValue:true,onChange:(v)=>sounds.enable.others=v},cat);let notification=new smenu.components.Checkbox({label:"Notification",color:"blue",save:"sounds.notification",defaultValue:true,onChange:(v)=>sounds.enable.notification=v},cat);let master=new smenu.components.Checkbox({label:"Bật âm thanh",color:"pink",save:"sounds.master",defaultValue:false,onChange:async(v)=>{sounds.enable.master=v;mouseOver.set({disabled:!v});btnClick.set({disabled:!v});panelToggle.set({disabled:!v});others.set({disabled:!v});notification.set({disabled:!v});if(v)
sounds.soundToggle(sounds.sounds.checkOn);if(core.initialized&&!sounds.initialized)
await core.sounds.init();}});status.insert(master,-2);}},projectInfo:{group:smenu.Group.prototype,licensePanel:smenu.Panel.prototype,async init(){this.group=new smenu.Group({label:"thông tin",icon:"info"});let links=new smenu.Child({label:"Liên Kết Ngoài"},this.group);let projectInfo=makeTree("div","projectInfo",{header:{tag:"div",class:"header",child:{icon:new lazyload({source:"./static/img/icon.png",classes:"icon"})}},pTitle:{tag:"t",class:"title",text:APPNAME},description:{tag:"t",class:"description",text:"The Next Generation Of CTMS"},note:createNote({level:"info",message:"CTMS+ không được hỗ trợ bởi OTSC hoặc các bên liên quan"}),authorLabel:{tag:"t",class:"label",text:"Tác Giả"},author:{tag:"span",class:"author"},contributorLabel:{tag:"t",class:"label",child:{content:{tag:"span",text:"Người Đóng Góp"},tip:{tag:"tip",title:`Tên của bạn sẽ xuất hiện trong danh sách này nếu bạn có đóng góp cho dự án (bằng cách tạo commit hoặc pull request)`}}},contributors:{tag:"span",class:"contributor"},});for(let username of Object.keys(META.author))
projectInfo.author.appendChild(makeTree("span","item",{avatar:new lazyload({source:`https://github.com/${username}.png?size=80`,classes:"avatar"}),aName:{tag:"a",target:"_blank",href:META.author[username].link,class:"name",text:META.author[username].name},department:{tag:"t",class:"department",text:META.author[username].department},aRole:{tag:"t",class:"role",text:META.author[username].role}}));for(let username of Object.keys(META.contributors))
projectInfo.contributors.appendChild(makeTree("div","item",{avatar:new lazyload({source:`https://github.com/${username}.png?size=40`,classes:"avatar"}),username:{tag:"a",target:"_blank",href:`https://github.com/${username}`,class:"username",text:username},contributions:{tag:"t",class:"contributions",text:META.contributors[username].contributions}}));new smenu.components.Button({label:"báo lỗi",color:"pink",icon:"externalLink",complex:true,onClick:()=>window.open(REPORT_ERROR,"_blank")},links);new smenu.components.Button({label:"mã nguồn",color:"pink",icon:"externalLink",complex:true,onClick:()=>window.open(REPO_ADDRESS,"_blank")},links);new smenu.components.Button({label:"metronome?",color:"darkBlue",icon:"stopwatch",complex:true,onClick:()=>location.href=`https://belikhun.github.io/metronome`},links);let project=new smenu.Child({label:"Dự Án"},this.group);let detailsButton=new smenu.components.Button({label:"thông tin",color:"blue",icon:"arrowLeft",complex:true},project);(new smenu.Panel(projectInfo)).setToggler(detailsButton);let licenseButton=new smenu.components.Button({label:"LICENSE",color:"blue",icon:"arrowLeft",complex:true},project);this.licensePanel=new smenu.Panel(undefined,{size:"large"});this.licensePanel.setToggler(licenseButton);await this.licensePanel.content("iframe:./license.html");core.darkmode.onToggle((enabled)=>{if(this.licensePanel.iframe.contentDocument)
this.licensePanel.iframe.contentDocument.body.classList[enabled?"add":"remove"]("dark");});new smenu.components.Footer({icon:"./static/img/icon.png",appName:APPNAME,version:`${VERSION} - ${STATE}`},project);}}},server:{priority:2,toast:undefined,options:{},current:undefined,select:smenu.components.Select.prototype,loginSelect:undefined,init(){if(!META.servers)
return false;let defaultHost=null;for(let[key,value]of Object.entries(META.servers)){this.options[key]=value.name;if(value.default)
defaultHost=key;}
let general=new smenu.Child({label:"CTMS"},core.userSettings.server.group);this.select=new smenu.components.Select({label:"Máy chủ sử dụng",icon:"hive",options:this.options,defaultValue:defaultHost,onChange:(v)=>this.switch(v)},general);onInitGroup("core.account",(group)=>{this.loginSelect=group.loginView.servers;this.loginSelect.set({options:this.options});this.loginSelect.onChange((value)=>this.switch(value));if(this.current)
this.loginSelect.value=this.current;});this.toast=new ToastInstance("Máy Chủ","none");let current=localStorage.getItem(`server.host.${VERSION}`);if(!current){if(defaultHost)
this.switch(defaultHost,true);return;}
this.switch(current,true);},async switch(key,initial=false){if(!META.servers||!META.servers[key]||key===this.current)
return;let server=META.servers[key];this.current=key;this.log("INFO",`switching to server "${key}"`,server);localStorage.setItem(`server.host.${VERSION}`,key);api.HOST=server.host;api.HOST_NAME=key;if(this.loginSelect)
this.loginSelect.value=key;this.select.set({value:key});if(!initial){this.toast.value=server.name;this.toast.hint=server.host;this.toast.show();core.account.subWindow.loading=true;await api.request();core.account.subWindow.loading=false;}}},middleware:{priority:2,list:{},select:smenu.components.Select.prototype,init(){if(typeof META==="undefined"||!META.middleware)
return false;this.list=META.middleware;let general=new smenu.Child({label:"Middleware"},core.userSettings.server.group);let mwOptions={}
let mwDefault;for(let key of Object.keys(META.middleware)){mwOptions[key]=META.middleware[key].name;if(META.middleware[key].default)
mwDefault=key;}
this.select=new smenu.components.Select({label:"Máy chủ sử dụng",icon:"hive",color:"pink",options:mwOptions,defaultValue:mwDefault,save:`server.middleware.${VERSION}`,onChange:(v)=>this.set(META.middleware[v].host)},general);new smenu.components.Button({label:"chọn máy chủ tốt nhất",color:"pink",complex:true,onClick:async()=>await this.check()},general);},set(host){this.log("DEBG","Set middleware to",host);api.MIDDLEWARE=host;},async check({message="Đang tìm middleware phù hợp",description="CTMS+ sẽ tự động chọn máy chủ nhanh nhất, quá trình này sẽ mất vài giây."}={}){let promises=[]
let checkData={}
let cancelled=false;let checkStatus=makeTree("table",["generalTable","middlewareStatus"],{thead:{tag:"thead",child:{row:{tag:"tr",child:{mw:{tag:"th",text:"middleware"},ping:{tag:"th",class:"right",text:"ping"},status:{tag:"th",class:"center",text:"status"}}}}},tbody:{tag:"tbody"}});for(let key of Object.keys(this.list)){let item=this.list[key];let row=makeTree("tr","row",{mw:{tag:"td",class:"middleware",child:{mwName:{tag:"t",class:"name",text:item.name},mwHost:{tag:"t",class:"host",text:item.host}}},ping:{tag:"td",class:["right","ping"]},status:{tag:"td",class:["center","status"],data:{status:"loading"},child:{spinner:{tag:"div",class:"simpleSpinner"},icon:{tag:"icon"}}}});checkStatus.tbody.appendChild(row);checkData[key]={status:"loading",ping:null}
promises.push(new Promise(async(resolve)=>{let start=performance.now();try{await myajax({url:`${item.host}/api/ping`});}catch(e){checkData[key].status="error";row.status.dataset.status="error";resolve(key);return;}
checkData[key].status="good";checkData[key].ping=performance.now()-start;row.status.dataset.status="good";row.ping.innerText=`${round(checkData[key].ping, 2)}ms`;resolve(key);}));}
let showTimeout=setTimeout(()=>{popup.show({windowTitle:`Middleware Status Check`,title:"Middleware",icon:"server",message,description,customNode:checkStatus,buttonList:{cancel:{color:"red",text:"HỦY"}}}).then((value)=>{if(value==="cancel")
cancelled=true;});},100);let target=await new Promise((resolve)=>{for(let promise of promises){promise.then((key)=>{if(checkData[key].status!=="good")
return;resolve(key);});}});if(cancelled)
return;if(popup.showing){popup.popup.body.top.message.innerText="Kiểm Tra Hoàn Thành!";popup.popup.body.button.children[0].dataset.color="blue";popup.popup.body.button.children[0].children[0].innerText="ĐÓNG";}
if(target){this.log("OKAY",`Switched to middleware`,{text:target,color:oscColor("blue")},`(${this.list[target].host})`);popup.background.color="green";popup.popup.body.top.description.innerHTML=`Đã chuyển sang middleware <b>${this.list[target].name}</b>!`;this.select.set({value:target});}else{if(!await ConnectionState.check()){clearTimeout(showTimeout);popup.hide();this.log("WARN","We are offline, waiting until we are online... (keep current middleware)");await ConnectionState.backOnline();return;}
this.log("WARN",`No suitable middleware found!`);popup.background.color="red";popup.popup.body.top.description.innerHTML=`Không tìm thấy middleware phù hợp!
					Bạn có thể <a target="_blank" href="${REPORT_ERROR}">báo cáo sự cố này</a> để được khắc phục sớm nhất!`;}}},account:{priority:4,loggedIn:false,email:undefined,password:undefined,background:null,userInfo:undefined,nameNode:null,avatarNode:null,navtip:navbar.Tooltip.prototype,clickable:navbar.Clickable.prototype,subWindow:navbar.SubWindow.prototype,loginView:null,detailView:null,loginHandlers:[],logoutHandlers:[],async init(set){set({p:0,d:`Setting Up Account Panel`});let container=document.createElement("span");container.classList.add("component","account");this.background=triBg(container,{color:"darkBlue",scale:1,triangleCount:8,speed:6});this.avatarNode=new lazyload({source:"./static/img/guest.png",classes:["avatar","light"]});this.nameNode=document.createElement("t");this.nameNode.classList.add("name");this.nameNode.innerText="đang khởi tạo...";container.append(this.avatarNode.container,this.nameNode);this.navtip=new navbar.Tooltip(container,{title:"account",description:"nhấn để đăng nhập!"});this.clickable=new navbar.Clickable(container);this.subWindow=new navbar.SubWindow(container);this.clickable.setHandler(()=>this.subWindow.toggle());this.subWindow.color="blue";this.loginView=makeTree("form","loginView",{label:{tag:"div",class:"label",child:{content:{tag:"t",class:"content",text:"Đăng Nhập CTMS"},tip:{tag:"tip",title:`Chúng tôi không lưu lại dữ liệu của bạn khi gửi và nhận tới CTMS.\nMã nguồn của API và Middleware có thể tìm thấy ở trong repository của dự án!`}}},note:createNote({level:"warning",message:"This is a sample warning",style:"big"}),username:createInput({type:"text",id:"account.login.username",label:"Tên Truy Cập",required:true}),password:createInput({type:"password",id:"account.login.password",label:"Mật Khẩu",required:true}),autoLogin:createCheckbox({label:"tự động đăng nhập",value:false}),servers:createSelectInput({icon:"server"}),submitBtn:createButton("ĐĂNG NHẬP",{color:"blue",type:"submit",classes:"submit",style:"big",icon:"signin",triangleStyle:"border",complex:true}),forgotBtn:createButton("Quên Mật Khẩu",{color:"pink",classes:"forgot",style:"big",icon:"key",complex:true,triangleStyle:"border",disabled:true})});this.loginView.addEventListener("submit",()=>{});this.loginView.action="javascript:void(0);";this.loginView.dataset.active="main";this.loginView.note.group.style.display="none";this.loginView.addEventListener("submit",()=>{this.login({username:this.loginView.username.input.value,password:this.loginView.password.input.value});});this.loginView.autoLogin.input.addEventListener("input",(e)=>{localStorage.setItem("autoLogin.enabled",e.target.checked);});let autoLogin=localStorage.getItem("autoLogin.enabled");if(autoLogin==="true")
this.loginView.autoLogin.input.checked=true;this.detailView=makeTree("div","userDetailView",{label:{tag:"t",class:"label",text:"Đã Đăng Nhập"},userCard:{tag:"div",class:"userCard",child:{top:{tag:"div",class:"top",child:{avatar:new lazyload({source:"./static/img/guest.png",classes:"avatar"}),info:{tag:"span",class:"info",child:{name:{tag:"t",class:"name",text:"Họ Tên"},studentID:{tag:"t",class:"id",text:"00A00000000"},email:{tag:"t",class:"email"}}}}},bottom:{tag:"span",class:"bottom",child:{birthday:{tag:"t",class:"birthday",title:"ngày sinh",text:"00/00/0000"},classroom:{tag:"t",class:"classroom",title:"lớp hành chính",text:"0000A00"}}}}},department:{tag:"div",class:["infoCard","department"],child:{label:{tag:"t",class:"label",text:"Ngành Học"},content:{tag:"t",class:["value","small"],text:"Không rõ"}}},tForm:{tag:"div",class:["infoCard","tForm"],child:{label:{tag:"t",class:"label",text:"Hình Thức Đào Tạo"},content:{tag:"t",class:["value","small"],text:"Không rõ"}}},renewBtn:createButton("Làm Mới Phiên",{color:"orange",classes:"logout",style:"big",icon:"reload",triangleStyle:"border",complex:true}),signoutBtn:createButton("ĐĂNG XUẤT",{color:"blue",classes:"logout",style:"big",icon:"signout",triangleStyle:"border",complex:true})});let userCardBG=triBg(this.detailView.userCard,{color:"whitesmoke",scale:5,speed:64});this.subWindow.content=this.loginView;this.subWindow.loading=true;set({p:30,d:`Attaching Listeners`});core.darkmode.onToggle((dark)=>userCardBG.color=dark?"dark":"whitesmoke");navbar.insert({container},"right");this.detailView.renewBtn.addEventListener("click",()=>this.renew());this.detailView.signoutBtn.addEventListener("click",()=>this.logout());api.onResponse("global",(response)=>this.check(response));api.onResponse("results",(response)=>this.updateInfo(response));api.onResponse("services",(response)=>this.updateEmail(response.info.email));set({p:50,d:`Đang Kiểm Tra Phiên Làm Việc`});try{await api.request();}catch(error){let check=(error.code<100&&error.code!=0)||(error.data&&(error.data.code===106||(error.data.code>0&&error.data.code<100)))
if(check){this.log("ERRR","Session check request failed! Error indicate middleware failue!");this.log("ERRR","We will perform a auto middleware change to resolve this problem and try again.");set({p:60,d:`Đang Chọn Middleware Khác`});await core.middleware.check({message:"Middleware hiện tại đã bị lỗi!",description:"CTMS+ đang tìm kiếm middleware phù hợp để sử dụng, quá trình này sẽ mất vài giây!"});set({p:70,d:`Đang Kiểm Tra Phiên Làm Việc (LẦN 2)`});await api.request();}}
if(!this.loggedIn){let username=localStorage.getItem("session.username");let password=localStorage.getItem("session.password");let enabled=localStorage.getItem("autoLogin.enabled");if(enabled==="true"&&username&&password){this.log("DEBG",`Auto login enabled. Logging in to ${username}`);set({p:80,d:`Đang Tự Động Đăng Nhập Vào CTMS`});await this.login({username,password});}}},onLogin(f){if(typeof f!=="function")
throw{code:-1,description:`core.account.onLogin(): not a valid function`}
this.loginHandlers.push(f);},onLogout(f){if(typeof f!=="function")
throw{code:-1,description:`core.account.onLogout(): not a valid function`}
this.logoutHandlers.push(f);},async check(response){if(response.path.includes("index.aspx"))
return;if(response.dom.getElementById("LeftCol_UserLogin1_pnlLogin")){this.loggedIn=false;this.email=undefined;this.userInfo=undefined;this.nameNode.innerText="Khách";this.background.color="darkRed";this.avatarNode.src=this.detailView.userCard.top.avatar.src="./static/img/guest.png";this.detailView.userCard.top.info.email.innerText="";this.navtip.set({description:`nhấn để đăng nhập!`});if(!this.subWindow.content||!this.subWindow.content.isSameNode(this.loginView)){this.log("OKAY","User Signed Out");this.subWindow.content=this.loginView;this.logoutHandlers.forEach(f=>f());}
let errMsg=response.dom.getElementById("LeftCol_UserLogin1_lblMess");if(errMsg&&errMsg.innerText!==""){this.loginView.note.group.style.display=null;this.loginView.note.set({message:errMsg.innerText});this.nameNode.innerHTML=`<icon style="font-size: 14px; margin-right: 4px;" data-icon="exclamation"></icon> lỗi đăng nhập!`;this.background.color="red";}else
this.loginView.note.group.style.display="none";this.subWindow.loading=false;}else if(this.loggedIn===false){this.log("OKAY","User Signed In");this.loggedIn=true;let username=localStorage.getItem("session.username");if(username)
this.updateEmail(username);this.subWindow.loading=true;this.subWindow.content=this.detailView;this.nameNode.innerText="đang tải dữ liệu...";this.background.color="navyBlue";let promises=[]
this.loginHandlers.forEach(f=>promises.push(f()));try{await Promise.all(promises);}catch(e){errorHandler(e);}
this.subWindow.loading=false;}},updateInfo(response){this.userInfo={name:response.info.name,birthday:response.info.birthday,tForm:response.info.tForm,studentID:response.info.studentID,faculty:response.info.faculty,department:response.info.department,course:response.info.course,classroom:response.info.classroom,mode:response.info.mode};this.nameNode.innerText=response.info.name;this.detailView.userCard.top.info.name.innerText=response.info.name;this.detailView.userCard.top.info.studentID.innerText=response.info.studentID;this.detailView.userCard.bottom.birthday.innerText=response.info.birthday;this.detailView.userCard.bottom.classroom.innerText=response.info.classroom;this.detailView.department.content.innerText=response.info.department;this.detailView.tForm.content.innerText=response.info.tForm;if(typeof gtag==="function")
gtag("event","loggedin",{class:this.userInfo.classroom});},updateEmail(email){if(email===this.email)
return;this.avatarNode.src=this.detailView.userCard.top.avatar.src=`https://www.gravatar.com/avatar/${md5(email)}?s=160&d=identicon`;this.detailView.userCard.top.info.email.innerText=email;this.email=email;},async login({username,password}={}){if(!username||!password)
throw{code:-1,description:`Cannot login with an empty username or password`}
this.subWindow.loading=true;let autoLogin=this.loginView.autoLogin.input.checked;localStorage.setItem("autoLogin.enabled",autoLogin);localStorage.removeItem("session.username");localStorage.removeItem("session.password");this.nameNode.innerText="đang đăng nhập...";this.background.color="purple";try{await api.login({username,password});this.updateEmail(username);localStorage.setItem("session.username",username);localStorage.setItem("session.password",password);}catch(e){let error=parseException(e);this.loginView.note.group.style.display=null;this.loginView.note.set({level:"error",message:`<pre class="break">${error.code} >>> ${error.description}</pre>`});if(autoLogin)
errorHandler(e);this.subWindow.loading=false;}},async logout(){this.detailView.signoutBtn.disabled=true;this.subWindow.loading=true;try{await api.logout();await api.request();}catch(error){errorHandler(error);}
this.password=undefined;this.detailView.signoutBtn.disabled=false;this.subWindow.loading=false;},async renew({showAccountPanel=true}={}){let username=localStorage.getItem("session.username");let password=localStorage.getItem("session.password");if(!username||!password)
throw{code:33,description:`core.account.renew(): cannot renew session without active username or password`}
if(showAccountPanel){this.subWindow.loading=true;this.subWindow.show();}
this.log("INFO",`Renewing Current Session`);localStorage.removeItem("session");await api.request();await this.login({username,password});}},screen:{container:$("#content"),priority:3,init(){}}}
if(localStorage.getItem("display.supertriangles")!=="true"){if(window&&typeof window.createButton==="function"){window.__createButton=window.createButton;window.createButton=(text,options={})=>{if(checkAgentMobile()&&options.complex)
options.triangleCount=3;return window.__createButton(text,options);}}}
core.userSettings.ctms={priority:-1,group:undefined,init(){this.group=new smenu.Group({icon:"circle",label:"CTMS"});},status:{child:undefined,view:undefined,requests:0,online:0,c2m:{total:0,count:0},m2s:{total:0,count:0},server:{success:0,failed:0},middleware:{success:0,failed:0},init(){this.child=new smenu.Child({label:"Tình Trạng"},this.super.group);this.view=makeTree("div",["component","ctmsStatus"],{basic:{tag:"div",class:"row",child:{online:{tag:"span",class:["item","infoCard"],child:{label:{tag:"t",class:"label",text:"Số Truy Cập"},value:{tag:"t",class:"value",text:"---"}}},request:{tag:"span",class:["item","infoCard"],child:{label:{tag:"t",class:"label",text:"Số Yêu Cầu"},value:{tag:"t",class:"value",text:"0"}}}}},network:{tag:"div",class:["item","infoCard","network"],child:{label:{tag:"t",class:"label",text:"Mạng"},nodes:{tag:"div",class:"nodes",child:{server:{tag:"span",class:"node",child:{label:{tag:"t",class:"label",text:"CTMS"},icon:{tag:"icon",data:{icon:"server"}},status:{tag:"div",class:"status",child:{success:{tag:"t",class:"success",text:"0"},failed:{tag:"t",class:"failed",text:"0"}}}}},m2s:{tag:"t",class:["value","m2s"],text:"--- ms"},middleware:{tag:"span",class:"node",child:{label:{tag:"t",class:"label",text:"Middleware"},icon:{tag:"icon",data:{icon:"hive"}},status:{tag:"div",class:"status",child:{success:{tag:"t",class:"success",text:"0"},failed:{tag:"t",class:"failed",text:"0"}}}}},c2m:{tag:"t",class:["value","c2m"],text:"--- ms"},client:{tag:"span",class:"node",child:{label:{tag:"t",class:"label",text:"Client"},icon:{tag:"icon",data:{icon:"laptop"}}}}}}}}});this.child.insert(this.view);api.onResponse("global",(data)=>{this.requests++;this.server.success++;this.middleware.success++;this.m2s.count++;this.m2s.total+=data.time;this.c2m.count++;this.c2m.total+=data.c2m;let onlineNode=data.dom.getElementById("menubottom");if(onlineNode)
this.online=parseInt(onlineNode.innerText.match(/\d+/)[0]);this.update();});api.onResponse("error",(error)=>{this.requests++;this.c2m.count++;this.c2m.total+=error.c2m;if(!error.data||error.data.code>0&&error.data.code<100){this.middleware.failed++;}else{this.middleware.success++;if(error.data.status>=400)
this.server.failed++;else
this.server.success++;}
this.update();});},update(){this.view.basic.online.value.innerText=this.online;this.view.basic.request.value.innerText=this.requests;this.view.network.nodes.server.status.success.innerText=this.server.success;this.view.network.nodes.server.status.failed.innerText=this.server.failed;this.view.network.nodes.middleware.status.success.innerText=this.middleware.success;this.view.network.nodes.middleware.status.failed.innerText=this.middleware.failed;this.view.network.nodes.m2s.innerText=`${this.m2s.count > 0 ? round((this.m2s.total / this.m2s.count) * 1000, 2) : "X"} ms`;this.view.network.nodes.c2m.innerText=`${this.c2m.count > 0 ? round((this.c2m.total / this.c2m.count) * 1000, 2) : "X"} ms`;if(this.middleware.success===0&&this.middleware.failed>0)
this.view.network.nodes.middleware.classList.add("failed");else
this.view.network.nodes.middleware.classList.remove("failed");if(this.server.success===0&&this.server.failed>0)
this.view.network.nodes.server.classList.add("failed");else
this.view.network.nodes.server.classList.remove("failed");}},services:{child:undefined,view:undefined,panel:undefined,serviceInfo:undefined,name:{basicAccess:"Truy Cập CTMS",unverifiedScore:"Xem Điểm Không Chờ Xác Nhận",payAsk:"Vấn Đáp Có Trả Phí PayAsk",coupleCheckIn:"Couple Check-In",shortAccess:"Truy Cập CTMS Ngắn Hạn"},price:{basicAccess:"? occ ? ngày",unverifiedScore:"16500 occ 150 ngày",payAsk:"0 occ 30 ngày",coupleCheckIn:"13419 occ 7 ngày",shortAccess:"5968 occ 3 ngày"},Service:class{constructor({id="sample",name="Sample Service",price="0 occ 0 ngày",time:timeData,panel}={}){if(timeData&&timeData.from&&timeData.to){this.container=makeTree("div","infoCard",{label:{tag:"t",class:"label",text:name},time:{tag:"t",class:"text",html:`${timeData.from.toLocaleString()}<arr></arr>${timeData.to.toLocaleString()}`},value:{tag:"div",class:"value"}});liveTime(this.container.value,time(timeData.to),{type:"minimal",count:"down",ended:"ĐÃ HẾT HẠN!"});}else{this.container=makeTree("div","infoCard",{label:{tag:"t",class:"label",text:name},buttons:{tag:"div",class:"buttons",child:{serviceInfo:createButton(undefined,{color:"blue",icon:"infoCircle"}),buyService:createButton(price.toUpperCase(),{color:"pink",icon:"shoppingCart",disabled:true})}}});if(panel)
this.container.buttons.serviceInfo.addEventListener("click",()=>{panel.content(`iframe:./static/services/${id.toLowerCase()}.html`);panel.show();});}}},init(){this.child=new smenu.Child({label:"Dịch Vụ"},this.super.group);let autoload=new smenu.components.Checkbox({label:"Tự động tải thông tin",color:"pink",save:"ctms.services.autoload",defaultValue:false},this.child);let reload=new smenu.components.Button({label:"tải thông tin dịch vụ",color:"red",complex:true,disabled:true,onClick:async()=>await api.services()},this.child);this.panel=new smenu.Panel(undefined,{size:"large"});this.view=makeTree("div",["component","ctmsServices"],{occCard:{tag:"div",class:"infoCard",child:{label:{tag:"t",class:"label",text:"OCC"},value:{tag:"t",class:"value",text:"X occ"}}},list:{tag:"div",class:"list"}});this.child.insert(this.view);core.account.onLogout(()=>{reload.set({label:"tải thông tin dịch vụ",color:"red",disabled:true});this.view.occCard.value.innerText="X occ";emptyNode(this.view.list);});core.account.onLogin(async()=>{if(autoload.checkbox.input.checked){reload.button.loading(true);await api.services();reload.button.loading(false);}else{reload.set({disabled:false});}});api.onResponse("services",(data)=>{reload.set({label:"làm mới",color:"blue"});this.view.occCard.value.innerText=data.info.occ;emptyNode(this.view.list);for(let key of Object.keys(data.info.services)){let s=new this.Service({id:key,name:this.name[key]||key,price:this.price[key]||"MUA",time:data.info.services[key],panel:this.panel});this.view.list.appendChild(s.container);}});},buy(id){}},}
core.news={priority:2,HOST:"http://fithou.edu.vn",categories:{"c3":{id:3,name:"Tin đào tạo",color:"green",icon:"personChalkboard"},"c4":{id:4,name:"Tin hoạt động",color:"blue",icon:"shapes"},"c14":{id:14,name:"Kế hoạch",color:"pink",icon:"bell"},"c5":{id:5,name:"Tuyển sinh",color:"yellow",icon:"userGraduate"},"c7":{id:7,name:"Tuyển dụng",color:"gray",icon:"laptopCode"},"c9":{id:9,name:"Bản tin OTSC",color:"gray",icon:"bookReader"},"c12":{id:12,name:"Quy định, Biểu mẫu",color:"gray",icon:"paragraph"},"c13":{id:13,name:"Nghiên cứu khoa học",color:"gray",icon:"microscope"}},button:navbar.iconButton({icon:"news",tooltip:{title:"tin tức",description:"các bài viết mới từ fithou"}}),loaded:false,activeCID:undefined,activePage:0,activeMaxPage:0,catLoading:false,prevScroll:0,container:undefined,content:undefined,loadIndicator:undefined,articles:[],init(){navbar.insert(this.button,"right",2);core.darkmode.onToggle((dark)=>this.button.set({color:dark?"dark":"whitesmoke"}));this.content=makeTree("div","news",{listing:{tag:"div",class:"listing",child:{cats:{tag:"div",class:"cats"},articles:{tag:"div",class:"articles"}}},viewer:{tag:"div",class:"viewer",child:{header:{tag:"div",class:"header",child:{top:{tag:"div",class:"top",child:{back:{tag:"icon",data:{icon:"left"}},articleName:{tag:"span",class:"title",text:"Sample title"}}},metas:{tag:"div",class:"metas",child:{cat:{tag:"span",class:["generalTag","cat"],text:"X"},views:{tag:"icon",class:"views",data:{icon:"eye"}},time:{tag:"icon",class:"time",data:{icon:"clock"}},original:{tag:"a",class:["text-btn","original"],target:"_blank",child:{label:{tag:"span",text:"mở link gốc"},icon:{tag:"icon",data:{icon:"externalLink"}}}}}},}},abstract:{tag:"div",class:"abstract",text:"hi abstract"},content:{tag:"div",class:"content"},nav:{tag:"div",class:"nav",child:{newer:{tag:"div",class:["item","newer"],child:{label:{tag:"span",class:"label",child:{subtitle:{tag:"div",class:"subtitle",text:"Bài đăng mới hơn"},articleName:{tag:"div",class:"title",text:"Sample text"}}},icon:{tag:"icon",data:{icon:"arrowRight"}}}},older:{tag:"div",class:["item","older"],child:{icon:{tag:"icon",data:{icon:"arrowLeft"}},label:{tag:"span",class:"label",child:{subtitle:{tag:"div",class:"subtitle",text:"Bài đăng cũ hơn"},articleName:{tag:"div",class:"title",text:"Sample text"}}}}}}}}}});new Scrollable(this.content.listing,{content:this.content.listing.cats,horizontal:true,scrollbar:false});this.content.id="news";this.layout="listing";this.content.viewer.header.top.back.addEventListener("click",async()=>{this.layout="listing";emptyNode(this.content.viewer.content);this.container.content.scrollTop=this.prevScroll;});this.loadIndicator=document.createElement("div");this.loadIndicator.classList.add("loading");this.loadIndicator.innerHTML=`<div class="simpleSpinner"></div>`;for(let[id,value]of Object.entries(this.categories)){let item=makeTree("span","item",{line:{tag:"div",class:"line"},icon:{tag:"icon",data:{icon:value.icon}},titleNode:{tag:"div",class:"title",text:value.name},lastDate:{tag:"div",class:"last"},counts:{tag:"div",class:"counts"}});let lastDate=this.get(value.id,"lastDate");if(lastDate)
item.lastDate.innerText=lastDate;let counts=this.get(value.id,"counts");if(counts)
item.counts.innerText=`${counts} trang`;item.dataset.id=value.id;item.dataset.color=value.color;item.addEventListener("click",()=>this.category(value.id));this.content.listing.cats.appendChild(item);this.categories[id].node=item;}
this.container=new WaveContainer(this.content,{title:"tin tức",icon:"news",color:"purple"});this.container.setToggler(this.button);this.container.onScroll((e)=>this.check(e));this.container.onToggle(async(active)=>{if(active){if(!this.loaded)
this.category(3);}else{this.loaded=false;this.activeCID=undefined;await delayAsync(1000);emptyNode(this.content.listing.articles);emptyNode(this.content.viewer.content);}});},save(id,key,value){localStorage.setItem(`news.${id}.${key}`,value);},get(id,key){return localStorage.getItem(`news.${id}.${key}`);},ctmsRelativeLink(url){url=encodeURIComponent(`${this.HOST}${url}`);return`${api.MIDDLEWARE}/api/middleware?url=${url}&raw=1`;},async fetch({path,method="GET",query={},targetQuery={},header={},form,json}){let start=new StopClock();let response;let tQs=[]
for(let[key,value]of Object.entries(targetQuery))
tQs.push(`${key}=${value}`);try{response=await myajax({url:`${api.MIDDLEWARE}/api/middleware`,method,header:{"Set-Host":"fithou.edu.vn","Set-Origin":this.HOST,"Set-Referer":`${this.HOST}${path}`,...header},query:{url:`${this.HOST}${path}`+((tQs.length>0)?"?"+tQs.join("&"):""),...query},form,json,withCredentials:true,formEncodeURL:true});}catch(error){error.c2m=start.tick();await api.__handleResponse("error",error);throw{code:-1,description:`news.fetch(${path}): invalid middleware response (middleware: ${api.MIDDLEWARE})`,data:error}}
let dom=document.createElement("template");dom.innerHTML=response.data.response;return{path,dom:dom.content,c2m:start.tick()-response.runtime,...response.data}},__c(id){return this.categories["c"+id];},async check(e){if(!this.loaded||this.catLoading||this.activePage>=this.activeMaxPage)
return;if(this.layout!=="listing")
return;let rect=this.content.listing.articles.getBoundingClientRect();if(window.outerHeight-rect.bottom>20){this.content.listing.appendChild(this.loadIndicator);await this.fetchCategory(this.activeCID,this.activePage+1);this.content.listing.removeChild(this.loadIndicator);}},async category(id){if(this.activeCID===id)
return;if(this.activeCID){this.__c(this.activeCID).node.classList.remove("active");}
this.__c(id).node.classList.add("active");this.activeCID=id;this.layout="listing";this.container.loading=true;await this.fetchCategory(id,1);this.container.loading=false;this.loaded=true;},async fetchCategory(id,page=1){this.log("DEBG",`fetching category ${id} page ${page}`);this.catLoading=true;let response=await this.fetch({path:"/Category.aspx",targetQuery:{"cid":id,"pi":page-1}});let articles=response.dom.querySelectorAll("#LeftCol_pnlCategory > .article");let lists=[]
for(let article of articles){let title=article.querySelector(":scope > a");lists.push({id:parseInt(/aid=(\d+)/gm.exec(title.href)[1]),title:title.innerText.trim(),abstract:article.children[5].innerText.trim(),date:article.children[3].innerText.trim()});}
let pager=response.dom.getElementById("pager");this.activeMaxPage=pager.children.length;this.activePage=page;if(page===1){this.__c(id).node.lastDate.innerText=lists[0].date;this.__c(id).node.counts.innerText=this.activeMaxPage+" trang";this.save(id,"lastDate",lists[0].date);this.save(id,"counts",this.activeMaxPage);}
if(page===1){emptyNode(this.content.listing.articles);this.articles=[]}
for(let item of lists){let dateParts=item.date.split("/");let postDate=new Date(dateParts[2],parseInt(dateParts[1])-1,dateParts[0]);let node=makeTree("div","article",{content:{tag:"span",class:"content",child:{left:{tag:"span",class:"left",child:{top:{tag:"div",class:"top",child:{articleTitle:{tag:"a",class:"title",text:item.title},tag:{tag:"span",class:"generalTag",text:this.__c(id).name,data:{color:this.__c(id).color}}}},abstract:(item.abstract.length>0)?{tag:"div",class:"abstract",text:item.abstract}:null}},right:{tag:"span",class:"right",child:{date:{tag:"div",class:"date",child:{value:{tag:"span",class:"value",text:relativeTime(postDate.getTime()/1000),title:humanReadableTime(postDate,{onlyDate:true})},icon:{tag:"icon",data:{icon:"calendar"}}}},readTime:{tag:"div",class:"readTime"}}}}},actions:{tag:"span",class:"actions",child:{view:{tag:"icon",data:{icon:"eye"},title:"xem bài viết"},markRead:{tag:"icon",data:{icon:"check"},title:"đánh dẫu đã đọc"}}}});let readTime=this.get(item.id,"readTime");if(readTime){readTime=parseInt(readTime);node.content.right.readTime.innerText=`đã đọc ${relativeTime(readTime)}`;node.dataset.color="green";node.actions.markRead.style.display="none";}else{let color=this.get(item.id,"color");if(!color){color=randItem(["blue","yellow","red","pink","orange","purple"]);this.save(item.id,"color",color);}
node.dataset.color=color;}
item={...item,cid:id,node}
node.content.left.top.articleTitle.addEventListener("click",()=>this.article(item));node.actions.view.addEventListener("click",()=>this.article(item));node.actions.markRead.addEventListener("click",()=>this.markRead(item));this.content.listing.articles.appendChild(node);this.articles.push(item);}
this.catLoading=false;},markRead(article){if(typeof article==="number"){for(let item of this.articles){if(item.id===article){article=item;break;}}}
let readTime=time();article.node.content.right.readTime.innerText=`đã đọc`;article.node.dataset.color="green";article.node.actions.markRead.style.display="none";this.save(article.id,"readTime",readTime);},async article(article){this.prevScroll=this.container.scrollable.scrollTop;this.container.loading=true;let cat=this.__c(article.cid);this.content.viewer.header.top.articleName.innerText=article.title;this.content.viewer.header.metas.cat.innerText=cat.name;this.content.viewer.header.metas.cat.dataset.color=cat.color;this.content.viewer.header.metas.views.innerText="";this.content.viewer.header.metas.time.innerText="";this.content.viewer.header.metas.original.href=`${this.HOST}/Article.aspx?aid=${article.id}`;this.content.viewer.abstract.innerText=article.abstract;this.layout="viewer";let index=this.articles.indexOf(article);if(this.articles[index-1]){let newer=this.articles[index-1];this.content.viewer.nav.newer.label.articleName.innerText=newer.title;this.content.viewer.nav.newer.onclick=()=>this.article(newer);this.content.viewer.nav.newer.style.display=null;}else{this.content.viewer.nav.newer.style.display="none";}
if(this.articles[index+1]){let older=this.articles[index+1];this.content.viewer.nav.older.label.articleName.innerText=older.title;this.content.viewer.nav.older.onclick=()=>this.article(older);this.content.viewer.nav.older.style.display=null;}else{this.content.viewer.nav.older.style.display="none";}
let response=await this.fetch({path:"/Article.aspx",targetQuery:{"aid":article.id}});let publishTime=response.dom.getElementById("LeftCol_lblThoigianDang").innerText;this.content.viewer.header.metas.time.innerText=publishTime.trim();let views=response.dom.querySelector("#leftcontent > div > .lanxem").innerText;views=/(\d+)/gm.exec(views);this.content.viewer.header.metas.views.innerText=(views)?views[1]:"";let content=response.dom.querySelector("#leftcontent > div > div.articleContent");let links=[...content.querySelectorAll("[href]"),...content.querySelectorAll("[src]")]
for(let link of links){let value;if(link.href){value=link.getAttribute("href");}else if(link.src){value=link.getAttribute("src");}
if(!value)
continue;if(value[0]==="/"){value=this.ctmsRelativeLink(value);}
if(link.href){link.href=value;link.target="_blank";}else if(link.src){link.src=value;}}
let styleNodes=content.querySelectorAll("[style]");for(let n of styleNodes){if(n.style.color==="rgb(0, 0, 0)")
n.style.color=null;}
let tables=content.getElementsByTagName("table");for(let table of tables){table.classList.add("generalTable");table.removeAttribute("border");table.removeAttribute("cellpadding");table.removeAttribute("cellspacing");table.removeAttribute("style");let cleans=[...table.getElementsByTagName("th"),...table.getElementsByTagName("td")]
for(let i of cleans){while(i.attributes.length>0)
i.removeAttribute(i.attributes[0].name);}}
let images=content.getElementsByTagName("img");for(let image of images){let newImage=new lazyload({source:image.src,spinner:"spinner"});image.parentElement.replaceChild(newImage.container,image);}
emptyNode(this.content.viewer.content);this.content.viewer.content.append(...content.children);this.markRead(article);this.container.loading=false;},set layout(layout){this.content.dataset.layout=layout;},get layout(){return this.content.dataset.layout;}}
const debug={priority:0,isEnabled:false,loggerOn:false,loggerView:undefined,logDuration:5000,init(){this.loggerView=document.createElement("div");this.loggerView.classList.add("debugLogger");this.loggerView.setAttribute("tooltip-excluded","");onCLOG((level,args)=>{if(!this.loggerOn)
return;this.makeLog(level,args,this.logDuration);});let enabled=localStorage.getItem("debug.enabled")==="true";if(window.DEBUG||enabled){localStorage.setItem("debug.enabled",true);this.enabled=true;}},makeLog(level,args,duration){let instance=new DebugLoggerInstance(level,args,duration);instance.show();},set enabled(enabled){this.isEnabled=enabled;window.DEBUG=enabled;},set logger(logger){this.loggerOn=logger;if(this.loggerOn)
core.container.appendChild(this.loggerView);else{if(core.container.contains(this.loggerView))
core.container.removeChild(this.loggerView);}},settings:{group:smenu.Group.prototype,async init(){onInitGroup("core.userSettings.sounds",(group)=>{this.group=new smenu.Group({label:"debug",icon:"wrench",after:group.group});let tools=new smenu.Child({label:"tools"},this.group);new smenu.components.Checkbox({label:"enable debug",color:"pink",save:"debug.enabled",defaultValue:false,toast:true,onChange:(value)=>debug.enabled=value},tools);new smenu.components.Checkbox({label:"show debug logger",color:"blue",save:"debug.logger",defaultValue:false,toast:true,onChange:(value)=>debug.logger=value},tools);new smenu.components.Button({label:"clear caches",color:"darkRed",icon:"hardDrive",complex:true,onClick:()=>{let count=0;for(let key of Object.keys(localStorage)){if(key.startsWith("cache")){localStorage.removeItem(key);count+=1;}}
this.log("DEBG",`removed ${count} caches`);}},tools);new smenu.components.Button({label:"clear localStorage",color:"darkRed",icon:"database",complex:true,onClick:()=>localStorage.clear()},tools);let fw=new smenu.Child({label:"framework"},this.group);new smenu.components.Button({label:"open testing framework",color:"brown",icon:"flaskVial",complex:true,onClick:()=>window.open("/tests")},fw);});}}}
class DebugLoggerInstance{constructor(level,args,duration=500){this.level=level;this.args=args;this.duration=duration;this.timeout=null;this.showing=false;this.view=document.createElement("div");this.view.classList.add("line");this.args.unshift({color:oscColor({DEBG:"blue",OKAY:"green",INFO:"whitesmoke",WARN:"yellow",ERRR:"red",CRIT:"purple",LCNT:"pink"}[level]),text:level,padding:6,separate:true});for(let item of this.args){let node=document.createElement("span");node.classList.add("item");if(typeof item==="object"){if(typeof item.text!=="undefined"){if(item.separate){node.classList.add("generalTag","separate");if(item.color)
node.style.backgroundColor=item.color;}else{if(item.color)
node.style.color=item.color;}
if(item.padding)
node.style.minWidth=`${item.padding * 7}px`;node.innerText=item.text;}else{if(item&&item.code&&item.description)
node.innerText=`[${item.code}] ${item.description}`;else if(item&&item.name&&item.message)
node.innerText=`${item.name} >>> ${item.message}`;else if(typeof item.toString==="function")
node.innerText=item.toString();else
node.innerText=JSON.stringify(item);}}else{if(typeof item==="boolean")
item=item?"true":"false";if(typeof item==="undefined")
item="undefined";node.innerText=item;}
this.view.appendChild(node);}}
async show(){debug.loggerView.appendChild(this.view);await nextFrameAsync();this.view.style.height=`${this.view.scrollHeight}px`;this.timeout=setTimeout(()=>this.hide(),this.duration);}
async hide(){this.view.classList.add("fade");await delayAsync(500);debug.loggerView.removeChild(this.view);}}
core={...core,debug}
const HomeScreen={screen:undefined,view:null,title:null,emptyClassIDsNotice:null,loaded:false,loading:false,activeScreen:null,currentScreen:null,activeWeekday:null,currentWeekday:null,autoChangeRenderer:true,defaultRenderMode:"table",currentRenderer:"table",listRenderTrigger:700,currentData:[],async init(){this.view=makeTree("div","homeScreen",{control:{tag:"div",class:"control",child:{dateInput:createInput({type:"date",id:"schedule.date",label:"Ngày Bắt Đầu"}),confirm:createButton("XEM",{icon:"calendarWeek",color:"orange",style:"big",complex:true,disabled:true}),separatorLine1:{tag:"div",class:"separator"},homeDate:createSelectInput({icon:"table",color:"blue",fixed:true}),separatorLine2:{tag:"div",class:"separator"},edit:createButton(undefined,{icon:"pencil",color:"blue",style:"big",complex:true})}},list:{tag:"div",class:["list","showEmpty"]}});this.title=makeTree("div","homeScreenTitle",{my:{tag:"span",class:"my",text:"của bạn"},home:{tag:"span",class:"home",text:"trang chủ"}});this.emptyClassIDsNotice=makeTree("div","emptyClassIDsNotice",{icon:{tag:"icon",data:{icon:"pencil"}},titleNode:{tag:"t",class:"title",text:`Danh Sách Lớp Của Bạn Trống!`},description:{tag:"t",class:"description",html:`Hãy nhập danh sách mã lớp mà bạn đã đăng kí,
					lịch học của bạn sẽ được hiển thị tại đây.
					Lưu ý rằng lịch học này được lấy từ lịch học chung của khoa được hiển thị tại trang chủ của CTMS
					dựa trên danh sách mã lớp mà bạn đã nhập, vì vậy hãy đảm bảo chắc chắn rằng danh sách
					này là <b>CHÍNH XÁC</b>. Danh sách mã lớp cũng sẽ được cập nhật tự động khi bạn vào trang <b>Đăng Kí</b> của CTMS+`},buttons:{tag:"div",class:"buttons",child:{edit:createButton("CHỈNH SỬA",{color:"blue",style:"big",icon:"pencil",complex:true}),help:createButton("Video Hướng Dẫn",{color:"purple",style:"big",icon:"question",complex:true})}}});onInitGroup("core.screen.schedule.settings",(group)=>{let settingsChild=new smenu.Child({label:"Trang Chủ"},group.group);new smenu.components.Button({label:"Chỉnh Sửa Danh Sách Mã Lớp",color:"orange",icon:"pencil",complex:true,onClick:()=>this.showClassIDEditor()},settingsChild);});api.onResponse("subscribe",(data)=>{if(!data.subscribed||data.subscribed.length<=0)
return;let classIDs=this.getClassID();let item;for(item of data.subscribed)
if(!classIDs.includes(item.classID)){this.log("DEBG",`updateClassID: new class ID from subscribe: ${item.classID}`);classIDs.push(item.classID);}
this.saveClassID(classIDs);});this.screen=new CoreScreen({id:"home",icon:"home",title:"trang chủ",description:"trang chủ của CTMS",applyScrollable:false});this.setScreen("my");this.setLoading(true);this.screen.onShow(()=>this.load());new Scrollable(this.view,{content:this.view.list});this.screen.set({title:this.title});this.screen.content=this.view;this.title.my.addEventListener("click",()=>this.setScreen("my"));this.title.home.addEventListener("click",()=>this.setScreen("home"));this.view.control.edit.addEventListener("click",()=>this.showClassIDEditor());this.view.control.confirm.addEventListener("click",()=>this.load(this.getInputDate()));this.emptyClassIDsNotice.buttons.edit.addEventListener("click",()=>this.showClassIDEditor());this.emptyClassIDsNotice.buttons.help.addEventListener("click",()=>{core.wavec.browse(META.link.classIDHelp);});this.view.control.homeDate.onChange((value)=>{this.currentWeekday=value;this.log("DEBG","Change Weekday:",value,`(loading: ${this.loading})`);if(!this.loading)
this.render();});api.onResponse("home",(response)=>{if(response.date)
this.setInputNow(response.date);let options={all:"Toàn Bộ"}
let defaultValue=null;for(let item of response.info){options[item.weekDay]=item.weekDay;if(!defaultValue||isToday(item.date))
defaultValue=item.weekDay;}
this.view.control.homeDate.set({options,value:defaultValue});this.loaded=true;this.render(response.info);});window.addEventListener("resize",()=>{if(!this.autoChangeRenderer)
return;this.render();});this.setInputNow();this.screen.show();},getClassID(){let storage=localStorage.getItem("home.classID");if(!storage)
return[]
else
return storage.split("||");},saveClassID(ids){localStorage.setItem("home.classID",ids.join("||"));if(this.activeScreen==="my")
this.render(undefined,{force:true});},async showClassIDEditor(){let editor=document.createElement("textarea");editor.classList.add("classIDInput","flatInput");editor.value=this.getClassID().join("\n");let command=await popup.show({windowTitle:`Trang Chủ`,title:"Sửa Danh Sách Mã Lớp",message:"Nhập các mã lớp mà bạn đang theo học, mỗi mã nằm trên một dòng",description:`Danh sách mã lớp cũng sẽ được tự động cập nhật nếu bạn vào trang <b>Đăng Kí</b> của CTMS+`,icon:"pencil",bgColor:"blue",customNode:editor,buttonList:{save:{icon:"save",text:"LƯU",color:"blue"},cancel:{icon:"close",text:"HỦY",color:"red"},}});if(command==="save"){let values=editor.value.toUpperCase().split("\n").filter((i)=>i.length>0);this.saveClassID(values);this.log("DEBG","showClassIDEditor(): manually saved class ID list");}},setScreen(screen){if(screen===this.currentScreen)
return;if(screen==="home"){this.title.home.classList.add("active");this.title.my.classList.remove("active");this.currentScreen="home";this.screen.set({icon:"home"});}else{this.title.my.classList.add("active");this.title.home.classList.remove("active");this.currentScreen="my";this.screen.set({icon:"userPortrait"});}
this.render();},reset(){this.loaded=false;emptyNode(this.view.list);this.setInputNow();},setLoading(loading=false){this.loading=loading;if(this.screen.overlayShowing){this.screen.loading=loading;this.view.control.confirm.loading(false);}else{this.screen.loading=false;this.view.control.confirm.loading(loading);}},async load(date){try{if(!this.loaded){this.setLoading(true);this.screen.overlay({show:false});await api.home();this.view.control.confirm.disabled=false;this.setLoading(false);}else{if(date){this.setLoading(true);await api.home(date);this.setLoading(false);}}}catch(e){this.reset();this.view.control.confirm.disabled=true;this.screen.handleError(e,async()=>await this.load());this.setLoading(false);}},setInputNow(date=new Date()){setDateTimeValue(this.view.control.dateInput.input,null,time(date));},getInputDate(){return new Date(this.view.control.dateInput.input.value);},setAutoChangeRenderer(enabled){this.autoChangeRenderer=enabled;if(this.initialized)
this.render();},setDefaultRenderMode(mode){this.defaultRenderMode=mode;if(this.initialized&&!this.autoChangeRenderer)
this.render();},render(data,{force=false}={}){if(!this.loaded)
return;let renderer=this.defaultRenderMode;let newData=false;if(typeof data==="object"&&typeof data.length==="number"){newData=true;this.currentData=data;}else
data=this.currentData;if(this.autoChangeRenderer){if(window.innerWidth<=this.listRenderTrigger)
renderer="list";else
renderer="table";}
let needUpdate=force||this.currentRenderer!==renderer||newData||this.activeScreen!==this.currentScreen||this.activeWeekday!==this.currentWeekday;if(needUpdate){this.log("DEBG",`render(${renderer}): re-rendering`,`(force: ${force})`);emptyNode(this.view.list);let renderData=Array();if(this.currentScreen==="my"){let classIDs=this.getClassID();if(classIDs.length>0){for(let item of data){let rows=Array();for(let row of item.rows){if(typeof row.classID!=="object"||!row.classID.length)
continue;let match=false;for(let id of row.classID){if(classIDs.includes(id)){match=true;break;}}
if(match)
rows.push(row);}
if(rows.length>0){renderData.push({time:item.time,date:item.date,dateString:item.dateString,weekDay:item.weekDay,rows});}}}else{this.view.list.appendChild(this.emptyClassIDsNotice);this.activeScreen=this.currentScreen;return;}}else{renderData=data;}
if(this.currentScreen==="home"&&this.currentWeekday!=="all")
renderData=renderData.filter((i)=>i.weekDay===this.currentWeekday);if(renderer==="table")
this.view.list.appendChild(core.screen.schedule.renderTable(renderData));else
this.view.list.appendChild(core.screen.schedule.renderList(renderData));this.currentRenderer=renderer;this.activeScreen=this.currentScreen;this.activeWeekday=this.currentWeekday;this.view.control.dataset.render=renderer;this.view.control.dataset.screen=this.currentScreen;}}}
core.screen={...core.screen,home:HomeScreen}
const ScheduleScreen={screen:undefined,view:null,loaded:false,autoChangeRenderer:true,defaultRenderMode:"table",listRenderTrigger:700,haveCacheData:false,currentRenderer:"table",currentData:[],note:undefined,async init(){this.note=createNote({level:"warning",message:"",style:"flat"});this.view=makeTree("div","scheduleScreen",{control:{tag:"div",class:"control",child:{dateInput:createInput({type:"date",id:"schedule.date",label:"Ngày Bắt Đầu"}),confirm:createButton("XEM LỊCH",{icon:"calendarWeek",color:"brown",style:"big",complex:true,disabled:true}),prev:createButton(undefined,{icon:"backward",color:"blue",classes:"controlWeekLeft",style:"big",complex:true,disabled:true,}),next:createButton(undefined,{icon:"forward",color:"blue",align:"right",classes:"controlWeekRight",style:"big",complex:true,disabled:true})}},list:{tag:"div",class:["list","showEmpty"],child:{note:this.note,table:{tag:"table"}}}});this.screen=new CoreScreen({id:"schedule",icon:"calendarWeek",title:"lịch học",description:"xem lịch học trong tuần!",applyScrollable:false});if(typeof oapi!=="object"){this.screen.overlay({show:true,icon:"seedling",title:"Tính năng tạm thời bị vô hiệu hóa!",description:"Tính năng này hiện đã tạm dừng hoạt động do thay đổi hệ thống mới. CTMS+ sẽ tạm dừng hoạt động cho tới khi có thông báo mới."});return false;}
this.note.group.style.display="none";this.loading=true;this.screen.content=this.view;this.screen.onShow(()=>this.load());new Scrollable(this.view,{content:this.view.list});this.view.control.confirm.addEventListener("click",()=>this.load(this.getInputDate()));this.view.control.next.addEventListener("click",()=>this.load(this.getNextWeek()));this.view.control.prev.addEventListener("click",()=>this.load(this.getLastWeek()));core.account.onLogin(async()=>{if(this.screen.showing)
this.load();});core.account.onLogout(()=>{this.view.control.confirm.loading(false);this.view.control.confirm.disabled=true;if(!this.haveCacheData)
this.onLogout()});api.onResponse("schedule",(response)=>{if(response.date)
this.setInputNow(response.date);let today=new Date();let currentOrNext=(response.date.setDate(response.date.getDate()+6)>today)&&(response.date.setDate(response.date.getDate()-7)<today);this.log("DEBG","currentOrNext =",currentOrNext);if(!this.loaded&&currentOrNext){(async()=>{if(!core.account.userInfo){this.log("DEBG","userInfo is not available! waiting for it...");await waitFor(()=>(typeof core.account.userInfo==="object"),()=>{},120,1000);}
this.log("INFO",`Updating schedule cache for`,{text:core.account.userInfo.name,color:oscColor("blue")});localStorage.setItem("cache.schedule",JSON.stringify({name:core.account.userInfo.name,date:response.date,stored:new Date(),info:response.info}));})()}
this.note.group.style.display="none";this.loaded=true;this.loading=false;this.render(response);});window.addEventListener("resize",()=>{if(!this.autoChangeRenderer)
return;this.render();});let cacheRaw=localStorage.getItem("cache.schedule");if(cacheRaw){try{let cache=JSON.parse(cacheRaw);this.haveCacheData=true;cache.stored=new Date(cache.stored);cache.date=new Date(cache.date);if(time(cache.date)>=time()-604800){for(let item of cache.info){item.date=new Date(item.date);for(let row of item.rows){row.date[0]=new Date(row.date[0]);row.date[1]=new Date(row.date[1]);}}
this.render({info:cache.info});this.note.set({level:"info",message:`
							Đang hiển thị lịch học đã lưu của <b>${cache.name}</b> vào ${humanReadableTime(cache.stored)}.<br>
							<a href="javascript:core.account.subWindow.show()">Đăng nhập</a> để cập nhật lịch học mới nhất!
						`});this.note.group.style.display=null;let autoLogin=localStorage.getItem("autoLogin.enabled");if(autoLogin==="true"){this.loading=true;}else{this.loading=false;this.view.control.confirm.disabled=true;}}}catch(e){this.log("WARN","Loading cache data failed! Ignoring cache for now...",e);}}
this.setInputNow();this.screen.show();},reset(){this.loaded=false;emptyNode(this.view.list.table);this.setInputNow();},set loading(loading=false){if(this.screen.overlayShowing){this.screen.loading=loading;this.view.control.confirm.loading(false);this.view.control.next.loading(false);this.view.control.prev.loading(false);}else{this.screen.loading=false;this.view.control.confirm.loading(loading);this.view.control.next.disabled=loading;this.view.control.prev.disabled=loading;}},onLogout(){this.reset();this.view.control.confirm.disabled=true;this.screen.overlay({icon:"signout",title:"Bạn Chưa Đăng Nhập",description:`Hãy đăng nhập vào CTMS để xem nội dung này! Hoặc bạn <b>có thể</b> xem lịch học của khoa mà không cần đăng nhập.`,buttons:{login:{text:"ĐĂNG NHẬP",icon:"signin",onClick:()=>core.account.clickable.active=true},viewHome:{text:"Xem Lịch Học",icon:"table",color:"purple",onClick:()=>core.screen.home.screen.show()}}});this.loading=false;},async load(date){if(!core.account.loggedIn){if(!this.haveCacheData)
this.onLogout();return;}
try{if(!this.loaded){this.haveCacheData=false;this.loading=true;this.screen.overlay({show:false});await api.schedule();this.view.control.confirm.disabled=false;}else{if(date){this.loading=true;await api.schedule(date);}}}catch(e){this.reset();this.view.control.confirm.disabled=true;this.screen.handleError(e,async()=>await this.load());this.loading=false;}},setInputNow(date=new Date()){setDateTimeValue(this.view.control.dateInput.input,null,time(date));},getInputDate(){return new Date(this.view.control.dateInput.input.value);},getNextWeek(){let date=this.getInputDate();date.setDate(date.getDate()+7);return date;},getLastWeek(){let date=this.getInputDate();date.setDate(date.getDate()-7);return date;},setAutoChangeRenderer(enabled){this.autoChangeRenderer=enabled;if(this.initialized)
this.render();},setDefaultRenderMode(mode){this.defaultRenderMode=mode;if(this.initialized&&!this.autoChangeRenderer)
this.render();},render({info,billAlert=false}={},force=false){let renderer=this.defaultRenderMode;let data=info;let newData=false;if(typeof data==="object"&&typeof data.length==="number"){newData=true;this.currentData=data;}else
data=this.currentData;if(this.autoChangeRenderer){if(window.innerWidth<=this.listRenderTrigger)
renderer="list";else
renderer="table";}
if(this.currentRenderer!==renderer||newData||force){this.log("DEBG",`render(${renderer}): re-rendering`);this.screen.overlay({show:false});if(billAlert){this.note.set({level:"error",message:`
						<h3>Cảnh báo</h3>
						Bạn còn hóa đơn học phí chưa thanh toán!`});this.note.group.style.display=null;}
let node=(renderer==="table")?this.renderTable(data):this.renderList(data);this.view.list.replaceChild(node,this.view.list.table);this.view.list.table=node;this.currentRenderer=renderer;}},renderTable(data,{removeListID=true}={}){let today=new Date();let foundNextDay=false;let table=makeTree("table",["generalTable","scheduleTable","noBackground"],{thead:{tag:"thead",child:{row:{tag:"tr",child:{state:{tag:"th"},stt:{tag:"th",class:"right",text:"Thứ Tự"},status:{tag:"th"},subject:{tag:"th",text:"Môn Học"},classroom:{tag:"th",text:"Lớp Học"},time:{tag:"th",class:"bold",text:"Giờ"},teacher:{tag:"th",text:"Giảng Viên"},classID:{tag:"th",class:"right",text:"Mã Lớp"},...((!removeListID)?{listID:{tag:"th",class:"right",text:"Mã DS Thi"}}:{})}}}},tbody:{tag:"tbody"}});for(let{time,date,dateString,weekDay,rows=[]}of data){let isItemToday=false;let tags={}
if(isToday(date,today)){tags.today={tag:"span",class:["generalTag","today"],text:"Hôm Nay"}
isItemToday=true;}else if(!foundNextDay&&date>today){tags.next={tag:"span",class:["generalTag","next"],text:"Sắp Tới"}
foundNextDay=true;}
let header=makeTree("tr","header",{state:{tag:"td",class:"state"},label:{tag:"td",class:"label",colSpan:8,child:{wrapper:{tag:"span",class:"wrapper",child:{inner:{tag:"t",class:"inner",html:`<b>${weekDay}</b> ${dateString}`},tags:{tag:"span",class:"tags",child:tags}}}}},});if(isItemToday)
header.classList.add("today");else if(date<today)
header.classList.add("passed");table.tbody.appendChild(header);let nth=0;for(let row of rows){nth++;let tableRow=makeTree("tr",["row",(nth%2===0)?"even":"odd"],{state:{tag:"td",class:"state"},stt:{tag:"td",class:["right","bold"],text:nth},status:{tag:"td",class:"status",child:{inner:{tag:"span",class:"generalTag",data:{status:row.status},text:row.status}}},subject:{tag:"td",text:row.subject},classroom:{tag:"td",text:row.classroom},time:{tag:"td",class:"bold",html:`${row.time[0]}<arr></arr>${row.time[1]}`},teacher:{tag:"td",text:row.teacher},classID:{tag:"td",class:["bold","right"],html:(typeof row.classID==="object")?row.classID.join("<br>"):row.classID},...((!removeListID)?{listID:{tag:"td",class:["bold","right"],text:row.listID}}:{})});if(today>row.date[1]){tableRow.classList.add("passed");tableRow.state.dataset.tip="đã học xong";}else if(today>row.date[0]){tableRow.classList.add("inProgress");tableRow.state.dataset.tip="đang học";}
if(typeof row.noteID==="number"){let note=document.createElement("icon");note.classList.add("openNote");note.dataset.icon="note";note.dataset.id=row.noteID;note.title=`Xem Ghi Chú ${row.noteID}`;note.addEventListener("click",()=>this.viewNote(row.noteID));tableRow.subject.appendChild(note);}
if(row.checkInID){tableRow.classID.classList.add("clickable");tableRow.classID.addEventListener("click",()=>this.viewCheckIn(row.checkInID,row.subject));let checkInData=localStorage.getItem(`cache.checkin.${row.checkInID}`);if(checkInData){checkInData=JSON.parse(checkInData);tableRow.classID.innerText+=` (STT ${checkInData.nth})`;}}
table.tbody.appendChild(tableRow);}}
return table;},renderList(data){let today=new Date();let foundNextDay=false;let container=document.createElement("div");container.classList.add("scheduleList");for(let{time,date,dateString,weekDay,rows=[]}of data){let isItemToday=false;let tags={}
if(isToday(date,today)){tags.today={tag:"span",class:["generalTag","today"],text:"Hôm Nay"}
isItemToday=true;}else if(!foundNextDay&&date>today){tags.next={tag:"span",class:["generalTag","next"],text:"Sắp Tới"}
foundNextDay=true;}
let group=makeTree("div","listItem",{label:{tag:"div",class:"label",child:{inner:{tag:"t",class:"inner",html:`<b>${weekDay}</b> ${dateString}`},tags:{tag:"span",class:"tags",child:tags}}},items:{tag:"div",class:"items"}});if(isItemToday)
group.classList.add("today");else if(date<today)
group.classList.add("passed");for(let row of rows){let item=makeTree("div","item",{gradient:{tag:"div",class:"gradient",data:{status:row.status}},top:{tag:"div",class:"top",child:{tag:{tag:"span",class:["generalTag","status"],data:{status:row.status},text:row.status},classroom:{tag:"t",class:"classroom",text:row.classroom},time:{tag:"t",class:"time",html:`${row.time[0]}<arr></arr>${row.time[1]}`},collapse:{tag:"icon",icon:"arrowUp"}}},subject:{tag:"span",class:"subject",child:{inner:{tag:"t",class:"inner",text:row.subject}}},teacher:{tag:"t",class:"teacher",text:row.teacher},bottom:{tag:"div",class:"bottom",child:{classID:{tag:"t",class:"classID",html:(typeof row.classID==="object")?row.classID.join("<br>"):row.classID},separator:{tag:"span"},listID:{tag:"t",class:"listID",text:row.listID}}}});item.top.collapse.addEventListener("click",()=>{item.classList.toggle("collapse");});if(today>row.date[1]){item.classList.add("passed");item.classList.add("collapse");}else if(today>row.date[0])
item.classList.add("inProgress");if(typeof row.noteID==="number"){let note=document.createElement("icon");note.classList.add("openNote");note.dataset.icon="note";note.dataset.id=row.noteID;note.title=`Xem Ghi Chú ${row.noteID}`;note.addEventListener("click",()=>this.viewNote(row.noteID));item.subject.appendChild(note);}
if(row.checkInID){item.bottom.classID.classList.add("clickable");item.bottom.classID.addEventListener("click",()=>this.viewCheckIn(row.checkInID,row.subject));let checkInData=localStorage.getItem(`cache.checkin.${row.checkInID}`);if(checkInData){checkInData=JSON.parse(checkInData);item.bottom.classID.innerText+=` (STT ${checkInData.nth})`;}}
group.items.appendChild(item);}
container.appendChild(group);}
return container;},async viewNote(id){this.screen.loading=true;let response;try{response=await api.getNote(id);}catch(e){errorHandler(e);this.screen.loading=false;return;}
this.screen.loading=false;let noteContent=document.createElement("div");noteContent.classList.add("scheduleNoteContent");noteContent.innerHTML=response.data.content;await popup.show({windowTitle:`Note ${id}`,title:"Ghi Chú",icon:"note",message:"",description:"",customNode:noteContent,buttonList:{close:{text:"Đóng"}}});},async viewCheckIn(id,title){this.screen.loading=true;let response;try{response=await api.getCheckIn(id);localStorage.setItem(`cache.checkin.${id}`,JSON.stringify(response.data));this.render(undefined,true);}catch(e){errorHandler(e);this.screen.loading=false;return;}
this.screen.loading=false;let view=makeTree("div","checkInView",{header:{tag:"div",class:"header",child:{nth:{tag:"span",class:"item",child:{label:{tag:"t",class:"label",text:"MÃ DANH SÁCH"},value:{tag:"span",class:"value",text:response.data.nth}}},healthDeclared:{tag:"span",class:"item",child:{label:{tag:"t",class:"label",text:"KHAI Y TẾ"},value:{tag:"span",class:["value","check"],data:{checked:response.data.healthDeclared}}}}}},checkIn:{tag:"div",class:"checkIn"}},"view");for(let check of response.data.checkIn){let item=makeTree("span","item",{label:{tag:"t",class:"label",text:check.label},check:{tag:"div",class:"check",data:{status:check.status}}});view.checkIn.appendChild(item);}
await popup.show({windowTitle:`Danh Sách Điểm Danh ${id}`,title,icon:"table",level:"offline",message:"",description:"",customNode:view,buttonList:{close:{text:"Đóng"}}});},clearCheckInData(){for(let key of Object.keys(localStorage)){if(!key.startsWith("cache.checkin"))
continue;this.log("DEBG",`Clearing ${key}`);localStorage.removeItem(key);}
this.render(undefined,true);},settings:{initialized:false,group:smenu.Group.prototype,init(){if(this.initialized||!smenu.initialized)
return;this.group=new smenu.Group({label:"lịch học",icon:"calendarWeek",after:core.userSettings.display.group});let ux=new smenu.Child({label:"Giao Diện"},this.group);new smenu.components.Checkbox({label:"Tự động thay đổi kiểu hiển thị",color:"pink",save:"schedule.autoChangeRenderer",defaultValue:true,onChange:(v)=>{if(typeof HomeScreen==="object")
HomeScreen.setAutoChangeRenderer(v);ScheduleScreen.setAutoChangeRenderer(v);}},ux);new smenu.components.Choice({label:"Kiểu hiển thị mặc định",color:"blue",choice:{table:{title:"Bảng",icon:"table"},list:{title:"Danh Sách",icon:"list"}},save:"schedule.renderMode",defaultValue:"table",onChange:(v)=>{if(typeof HomeScreen==="object")
HomeScreen.setDefaultRenderMode(v);ScheduleScreen.setDefaultRenderMode(v);},toast:true},ux);let data=new smenu.Child({label:"Dữ Liệu"},this.group);new smenu.components.Button({label:"xóa dữ liệu điểm danh",color:"red",complex:true,onClick:()=>ScheduleScreen.clearCheckInData()},data);this.initialized=true;}}}
core.screen={...core.screen,schedule:ScheduleScreen}
core.screen={...core.screen,tests:{screen:null,view:null,loaded:false,loading:false,init(){this.view=makeTree("div","testsScreen",{table:{tag:"table",class:"generalTable",child:{thead:{tag:"thead",child:{row:{tag:"tr",child:{status:{tag:"th",class:"right"},time:{tag:"th",class:"right",text:"Thời Gian"},date:{tag:"th",text:"Ngày"},classroom:{tag:"th",class:"right",text:"Phòng"},subject:{tag:"th",text:"Môn Thi"},listID:{tag:"th",class:"right",text:"Mã DS"}}}}},tbody:{tag:"tbody"}}}});this.screen=new CoreScreen({id:"tests",icon:"pencil",title:"lịch thi",description:"theo dõi lịch thi của bạn!",subTitle:`Lịch thi có thể bị thay đổi, bạn nên kiểm tra lại trước ngày thi`,applyScrollable:false});if(typeof oapi!=="object"){this.screen.overlay({show:true,icon:"seedling",title:"Tính năng tạm thời bị vô hiệu hóa!",description:"Tính năng này hiện đã tạm dừng hoạt động do thay đổi hệ thống mới. CTMS+ sẽ tạm dừng hoạt động cho tới khi có thông báo mới."});return false;}
this.screen.content=this.view;new Scrollable(this.view,{content:this.view.table});this.onLogout();this.screen.loading=true;core.account.onLogout(()=>this.onLogout());this.screen.onReload(async()=>await this.load());core.account.onLogin(async()=>{if(this.loaded||!this.screen.showing)
return;await this.load();});this.screen.onShow(async()=>{if(this.loaded)
return;await this.load();});api.onResponse("tests",(response)=>{if(!this.loaded)
this.screen.overlay({show:false});this.loaded=true;emptyNode(this.view.table.tbody);for(let item of response.list)
this.addListItem(item);this.screen.loading=false;});},reset(){this.loading=false;this.loaded=false;emptyNode(this.view.table.tbody);},onLogout(){this.reset();this.screen.overlay({icon:"signout",title:"Bạn Chưa Đăng Nhập",description:`Hãy đăng nhập vào CTMS để xem nội dung này!`,buttons:{login:{text:"ĐĂNG NHẬP",icon:"signin",onClick:()=>core.account.clickable.active=true}}});this.screen.loading=false;},async load(){if(!core.account.loggedIn){this.onLogout();return false;}
if(this.loading)
return false;try{this.loading=true;this.screen.loading=true;await api.tests();this.loading=false;this.screen.loading=false;}catch(e){this.reset();this.screen.handleError(e,async()=>await this.load());this.screen.loading=false;}},addListItem({status,time,classroom,subject,listID}={}){let hours=time.getHours();let dDays=daysBetween(time,new Date());let dow=time.getDay()+1;dow=(dow===1)?"CN":`T${dow}`;let row=makeTree("tr","item",{status:{tag:"td",class:"right",child:{inner:{tag:"span",class:["generalTag","status"],data:{status},text:{ended:"Đã Thi",coming:"Chưa Thi"}[status]}}},time:{tag:"td",class:["right","bold"],child:{value:{tag:"span",class:"value",text:`${pleft((hours > 12) ? (hours - 12) : hours, 2)}:${pleft(time.getMinutes(), 2)}`},phase:{tag:"span",class:["generalTag","phase"],data:{phase:(hours>=12)?"pm":"am"}}}},date:{tag:"td",html:`<b>${dow}</b> ${pleft(time.getDate(), 2)}/${pleft(time.getMonth() + 1, 2)}/${time.getFullYear()} <b>(${dDays > 0 ? "+" : ""}${round(dDays, 1)})</b>`},classroom:{tag:"td",class:["right","bold"],text:classroom},subject:{tag:"td",text:subject},listID:{tag:"td",class:"right",text:listID}});this.view.table.tbody.appendChild(row);}}}
const SubscribeScreen={screen:null,view:null,loaded:false,loading:false,itemList:{},init(){this.view=makeTree("div","subscribeScreen",{waitingLabel:{tag:"t",class:["label","waiting"],text:"Có Thể Đăng Kí"},waiting:{tag:"div",class:["content","showEmpty","waiting"]},subscribedLabel:{tag:"t",class:["label","subscribed"],text:"Đã Đăng Kí"},subscribed:{tag:"div",class:["content","showEmpty","subscribed"]}});this.screen=new CoreScreen({id:"subscribe",icon:"play",title:"đăng kí lớp",description:"đăng kí lớp tín chỉ!"});if(typeof oapi!=="object"){this.screen.overlay({show:true,icon:"seedling",title:"Tính năng tạm thời bị vô hiệu hóa!",description:"Tính năng này hiện đã tạm dừng hoạt động do thay đổi hệ thống mới. CTMS+ sẽ tạm dừng hoạt động cho tới khi có thông báo mới."});return false;}
this.screen.content=this.view;this.onLogout();this.screen.loading=true;core.account.onLogout(()=>this.onLogout());this.screen.onReload(async()=>await this.load());core.account.onLogin(async()=>{if(this.loaded||!this.screen.showing)
return;await this.load();});this.screen.onShow(async()=>{if(this.loaded)
return;await this.load();});api.onResponse("subscribe",(response)=>{if(!this.loaded)
this.screen.overlay({show:false});this.loaded=true;if(typeof response.waiting==="object"&&response.waiting){emptyNode(this.view.waiting);for(let item of response.waiting)
this.processListItem({type:"waiting",...item});}
if(typeof response.subscribed==="object"&&response.subscribed){emptyNode(this.view.subscribed);for(let item of response.subscribed)
this.processListItem({type:"subscribed",...item});}
this.screen.loading=false;});},reset(){this.loading=false;this.loaded=false;this.itemList={};emptyNode(this.view.waiting);emptyNode(this.view.subscribed);},onLogout(){this.reset();this.screen.overlay({icon:"signout",title:"Bạn Chưa Đăng Nhập",description:`Hãy đăng nhập vào CTMS để xem nội dung này!`,buttons:{login:{text:"ĐĂNG NHẬP",icon:"signin",onClick:()=>core.account.clickable.active=true}}});this.screen.loading=false;},async load(){if(!core.account.loggedIn){this.onLogout();return false;}
if(this.loading)
return false;try{this.loading=true;this.screen.loading=true;await api.subscribe();this.loading=false;this.screen.loading=false;}catch(e){this.reset();this.screen.handleError(e,async()=>await this.load());this.screen.loading=false;}},processListItem({type="waiting",expired,isFull,classID,subject,teacher,credits,tuition,minimum,maximum,subscribed,schedule=[],classroom=[],action={command:undefined,data:undefined,classID:undefined,},date={start:undefined,end:undefined,cancel:undefined}}={}){if(!this.itemList[classID]){this.itemList[classID]=makeTree("div","item",{details:{tag:"div",class:"details",child:{left:{tag:"span",class:"left",child:{subject:{tag:"t",class:"subject",text:subject},teacher:{tag:"t",class:"teacher",text:teacher},status:{tag:"div",class:"status",child:{expired:{tag:"span",class:["generalTag","expired"],text:"Hết Hạn ĐK"},noCancel:{tag:"span",class:["generalTag","noCancel"],text:"Hết Hạn Hủy"},full:{tag:"span",class:["generalTag","full"],text:"Hết Chỉ Tiêu"},notEnough:{tag:"span",class:["generalTag","notEnough"],text:"Chưa Đạt Chỉ Tiêu"}}}}},right:{tag:"span",class:"right",child:{top:{tag:"div",class:"top",child:{progress:{tag:"span",class:["subProgress","progressBar"],child:{label:{tag:"div",class:"label",text:"Đã Đăng Kí"},bar:{tag:"div",class:"bar",child:{minimum:{tag:"div",class:"minimum"},inner:{tag:"div",class:"inner"}}},min:{tag:"div",class:"min",text:"0"},subs:{tag:"div",class:"subs",text:"0"},max:{tag:"div",class:"max",text:"0"}}},classroom:{tag:"span",class:"minimum",child:{label:{tag:"t",class:"label",text:"Lớp Học"},value:{tag:"t",class:"value",text:"---"}}},credits:{tag:"span",class:"credits",child:{label:{tag:"t",class:"label",text:"Số Tín Chỉ"},value:{tag:"t",class:"value",text:"---"}}},}},bottom:{tag:"div",class:"bottom",child:{startDate:{tag:"span",class:"startDate",child:{label:{tag:"t",class:"label",text:"Mở Đăng Kí"},value:{tag:"t",class:"value",text:"---"},sub:{tag:"t",class:"sub",text:"---"}}},endDate:{tag:"span",class:"endDate",child:{label:{tag:"t",class:"label",text:"Đóng Đăng Kí"},value:{tag:"t",class:"value",text:"---"},sub:{tag:"t",class:"sub",text:"---"}}},cancel:{tag:"span",class:"cancel",child:{label:{tag:"t",class:"label",text:"Hủy Trước"},value:{tag:"t",class:"value",text:"---"},sub:{tag:"t",class:"sub",text:"---"}}}}}}}}},actions:{tag:"div",class:"actions",child:{left:{tag:"span",class:"left",child:{tuition:{tag:"span",class:"tuition",child:{label:{tag:"t",class:"label",text:"Học Phí"},value:{tag:"t",class:"value",text:"---"}}}}},right:{tag:"span",class:"right",child:{toggle:createButton("TOGGLE BUTTON",{style:"big",icon:"circle",complex:true,triangleCount:2}),schedule:createButton(undefined,{style:"big",icon:"table",complex:true,triangleCount:2}),}}}}});this.itemList[classID].actions.right.schedule.addEventListener("click",()=>{popup.show({windowTitle:`Lịch Học ${classID}`,title:"Lịch Học",message:subject,description:"<ul>"+schedule.map(i=>`<li>${i}</li>`).join("")+"</ul>",icon:"table"});});if(action.command!=="condition"){this.itemList[classID].actions.right.toggle.addEventListener("click",async()=>{let action=this.itemList[classID].action;if(!action.command||!action.classID){clog("WARN","core.screen.subscribe(): undefined command or classID");return;}
let response;switch(action.command){case"subscribe":response=await popup.show({windowTitle:`Đăng Kí ${classID}`,title:"Đăng Kí",message:subject,icon:"signin",bgColor:"darkBlue",description:`Bạn có chắc muốn đăng kí lớp tín chỉ này không?`,buttonList:{confirm:{text:"XÁC NHẬN",color:"green"},cancel:{text:"Hủy",color:"red"}}});break;case"unsubscribe":response=await popup.show({windowTitle:`Hủy Đăng Kí ${classID}`,title:"Hủy Đăng Kí",message:subject,icon:"signout",bgColor:"red",description:`Bạn có chắc muốn hủy đăng kí lớp tín chỉ này không?`,buttonList:{confirm:{text:"XÁC NHẬN",color:"red"},cancel:{text:"Hủy",color:"blue"}}});break;default:break;}
if(response!=="confirm"){clog("DEBG",`core.screen.subscribe(): user cancelled ${action.command}:${action.classID}`);return;}
this.itemList[classID].actions.right.toggle.loading(true);try{await api.subscribe({action:action.command,classID:action.classID});if(action.command==="subscribe"){this.itemList[classID].actions.right.toggle.background.color="orange";this.view.subscribed.appendChild(this.itemList[classID]);}}catch(e){errorHandler(e);}
try{await api.subscribe({action:"subscribed"});}catch(e){errorHandler(e);}
this.itemList[classID].actions.right.toggle.loading(false);});}}
this.itemList[classID].action=action;let item=this.itemList[classID];item.details.right.top.classroom.value.innerText=classroom.join(", ");item.details.right.top.credits.value.innerText=credits;item.details.right.bottom.startDate.value.innerText=humanReadableTime(date.start);item.details.right.bottom.startDate.sub.innerText=relativeTime(time(date.start));item.details.right.bottom.endDate.value.innerText=humanReadableTime(date.end);item.details.right.bottom.endDate.sub.innerText=relativeTime(time(date.end));requestAnimationFrame(()=>{let progress=(subscribed/maximum)*100;let minProg=(minimum/maximum)*100;let color=(subscribed>=minimum)?(subscribed===maximum?"green":"blue"):"red";item.details.right.top.progress.bar.minimum.style.width=`${minProg}%`;item.details.right.top.progress.bar.inner.dataset.color=color;item.details.right.top.progress.bar.inner.style.width=`${progress}%`;item.details.right.top.progress.subs.style.left=`${progress}%`;item.details.right.top.progress.subs.innerText=subscribed;item.details.right.top.progress.min.style.left=`${(minimum / maximum) * 100}%`;item.details.right.top.progress.min.innerText=minimum;item.details.right.top.progress.max.innerText=maximum;});if(date.cancel){item.details.right.bottom.cancel.style.display=null;item.details.right.bottom.cancel.value.innerText=humanReadableTime(date.cancel);item.details.right.bottom.cancel.sub.innerText=relativeTime(time(date.cancel));}else{item.details.right.bottom.cancel.style.display="none";}
if(typeof tuition==="number"){item.actions.left.tuition.style.display=null;item.actions.left.tuition.value.innerText=Intl.NumberFormat("vi-VN").format(tuition*credits);}else{item.actions.left.tuition.style.display="none";}
item.details.left.status.expired.style.display=expired?null:"none";item.details.left.status.full.style.display=isFull?null:"none";item.details.left.status.notEnough.style.display=(subscribed<minimum)?null:"none";if(date.cancel&&time()>(date.cancel.getTime()/1000))
item.details.left.status.noCancel.style.display=null;else
item.details.left.status.noCancel.style.display="none";if(action.command==="condition"){item.actions.right.toggle.disabled=true;item.actions.right.toggle.changeText(action.data);item.actions.right.toggle.background.color="orange";item.actions.right.toggle.querySelector(":scope > icon").dataset.icon="exclamation";}else{switch(type){case"waiting":item.actions.right.toggle.changeText("ĐĂNG KÍ");item.actions.right.toggle.background.color="green";item.actions.right.toggle.querySelector(":scope > icon").dataset.icon="signin";break;case"subscribed":item.actions.right.toggle.changeText("HỦY ĐĂNG KÍ");item.actions.right.toggle.background.color="red";item.actions.right.toggle.querySelector(":scope > icon").dataset.icon="signout";break;}
item.actions.right.toggle.disabled=!(action&&action.command&&action.classID);}
if(type==="waiting"&&!this.view.waiting.contains(item))
this.view.waiting.appendChild(item);if(type==="subscribed"&&!this.view.subscribed.contains(item))
this.view.subscribed.appendChild(item);}}
core.screen={...core.screen,subscribe:SubscribeScreen}
const ResultScreen={screen:null,currentData:null,animator:undefined,currentCPA:0,timing:(t)=>(1-Math.pow(2,-14*t)),scanPerSemester:2,view:null,loaded:false,async init(){this.view=makeTree("div","resultsScreen",{info:{tag:"div",class:"info",child:{points:{tag:"span",class:"points",child:{ruler:{tag:"div",class:"ruler",child:{gradeF:{tag:"span",class:["bar","D"],child:{tag:{tag:"span",class:"generalTag",text:"YẾU"}}},gradeD:{tag:"span",class:["bar","C"],child:{tag:{tag:"span",class:"generalTag",text:"TB"}}},gradeC:{tag:"span",class:["bar","B"],child:{tag:{tag:"span",class:"generalTag",text:"KHÁ"}}},gradeB:{tag:"span",class:["bar","A"],child:{tag:{tag:"span",class:"generalTag",text:"GIỎI"}}},gradeA:{tag:"span",class:["bar","S"],child:{tag:{tag:"span",class:"generalTag",text:"XS"}}}}},progress:{tag:"div",class:"progress",child:{bar:{tag:"div",class:"bar",child:{value:{tag:"span",class:"value",child:{grade:{tag:"span",class:"generalTag",data:{grade:"TB"},text:"OK"},point:{tag:"t",class:"point",text:"0.000"}}}}}}}}},stats:{tag:"span",class:"stats",child:{grades:{tag:"div",class:"grades",child:{gradeA:{tag:"span",class:["item","A"],child:{tag:{tag:"div",class:"generalTag",data:{color:"green"},text:"A/A+"},value:{tag:"t",class:"value",text:"0"}}},gradeB:{tag:"span",class:["item","B"],child:{tag:{tag:"div",class:"generalTag",data:{color:"blue"},text:"B/B+"},value:{tag:"t",class:"value",text:"0"}}},gradeC:{tag:"span",class:["item","C"],child:{tag:{tag:"div",class:"generalTag",data:{color:"yellow"},text:"C/C+"},value:{tag:"t",class:"value",text:"0"}}},gradeD:{tag:"span",class:["item","D"],child:{tag:{tag:"div",class:"generalTag",data:{color:"orange"},text:"D/D+"},value:{tag:"t",class:"value",text:"0"}}},gradeF:{tag:"span",class:["item","F"],child:{tag:{tag:"div",class:"generalTag",data:{color:"red"},text:"F"},value:{tag:"t",class:"value",text:"0"}}},gradeU:{tag:"span",class:["item","U"],child:{tag:{tag:"div",class:"generalTag",text:"?"},value:{tag:"t",class:"value",text:"0"}}}}},other:{tag:"div",class:"other",child:{avg10:{tag:"span",class:"item",child:{tag:{tag:"div",class:"generalTag",data:{color:"light"},text:"ĐIỂM TB HỆ 10"},value:{tag:"t",class:"value",text:"0.00"}}},credits:{tag:"span",class:"item",child:{tag:{tag:"div",class:"generalTag",data:{color:"light"},text:"TÍN CHỈ ĐÃ TÍCH LŨY"},value:{tag:"t",class:"value",text:"100"}}},}}}}}},table:{tag:"table",class:["generalTable","noBackground"],child:{thead:{tag:"thead",child:{row:{tag:"tr",child:{stt:{tag:"th",class:"right",text:"Thứ Tự"},subject:{tag:"th",text:"Môn Học"},credits:{tag:"th",class:"right",text:"Số Tín Chỉ"},classroom:{tag:"th",class:"right",text:"Mã Lớp"},teacher:{tag:"th",text:"Giảng Viên"},diemCC:{tag:"th",class:"right",child:{content:{tag:"span",text:"Điểm CC"},tip:{tag:"tip",title:"Điểm Chuyên Cần (weighted 10%)"}}},diemDK:{tag:"th",class:"right",child:{content:{tag:"span",text:"Điểm ĐK"},tip:{tag:"tip",title:"Điểm Điều Kiện (weighted 20%)"}}},diemHK:{tag:"th",class:"right",child:{content:{tag:"span",text:"Điểm HK"},tip:{tag:"tip",title:"Điểm Học Kì (weighted 70%)"}}},average:{tag:"th",class:"right",child:{content:{tag:"span",text:"TB10"},tip:{tag:"tip",title:"Điểm Trung Bình Hệ Số 10"}}},gradePoint:{tag:"th",class:"right",child:{content:{tag:"span",text:"TB4"},tip:{tag:"tip",title:"Điểm Trung Bình Hệ Số 4"}}},gradeLetter:{tag:"th",class:"right"}}}}},tbody:{tag:"tbody"}}}});this.screen=new CoreScreen({id:"results",icon:"poll",title:"kết quả học tập",description:"xem toàn bộ kết quả học tập của các môn!"});if(typeof oapi!=="object"){this.screen.overlay({show:true,icon:"seedling",title:"Tính năng tạm thời bị vô hiệu hóa!",description:"Tính năng này hiện đã tạm dừng hoạt động do thay đổi hệ thống mới. CTMS+ sẽ tạm dừng hoạt động cho tới khi có thông báo mới."});return false;}
let scanButton=createButton("XẾP NHÓM",{icon:"search",color:"orange",style:"big",complex:true});this.screen.addButton(scanButton);scanButton.addEventListener("click",async()=>{scanButton.loading(true);try{await this.scan();}catch(e){errorHandler(e);}
scanButton.loading(false);});this.screen.content=this.view;this.onLogout();this.screen.loading=true;core.account.onLogout(()=>this.onLogout());this.screen.onReload(async()=>await this.load());this.screen.onShow(async()=>{if(this.loaded){if(this.currentData){this.currentCPA=0;this.updateCPA(this.currentData.info.cpa);}
return;}
await this.load();});core.account.onLogin(async()=>{let resultCache=localStorage.getItem("cache.account");let needUpdate=true;if(resultCache){resultCache=JSON.parse(resultCache);if(resultCache.email===core.account.email){this.log("INFO","Account data has been cached, we don't need to fetch it again.");core.account.updateInfo({info:resultCache});this.screen.loading=false;needUpdate=false;}}
if(needUpdate||this.screen.showing)
await this.load();});api.onResponse("results",(response)=>{if(!this.loaded)
this.screen.overlay({show:false});localStorage.setItem("cache.account",JSON.stringify({email:core.account.email,name:response.info.name,birthday:response.info.birthday,tForm:response.info.tForm,studentID:response.info.studentID,faculty:response.info.faculty,department:response.info.department,course:response.info.course,classroom:response.info.classroom,mode:response.info.mode}));this.loaded=true;this.render(response);this.screen.loading=false;});api.onResponse("schedule",(response)=>{let groupingData=localStorage.getItem("results.grouping");groupingData=(groupingData)?JSON.parse(groupingData):[];let year=response.date.getFullYear();let month=response.date.getMonth()+1;let semester;if(month<=4)
semester=2;else if(month<=8)
semester=3;else
semester=1;this.log("DEBG",`schedule handler: updating entries for year ${year} semester ${semester}`);let index;for(let i=0;i<groupingData.length;i++)
if(groupingData[i].year===year&&groupingData[i].semester===semester){index=i;break;}
if(typeof index!=="number"){index=groupingData.push({year,semester,classID:[]})-1;}
for(let day of response.info)
for(let subject of day.rows)
if(!groupingData[index].classID.includes(subject.classID)){this.log("DEBG","schedule handler: adding",subject.classID);groupingData[index].classID.push(subject.classID);}
localStorage.setItem("results.grouping",JSON.stringify(groupingData));if(this.currentData)
this.render(undefined,true);});},async updateCPA(cpa){cpa=Math.min(cpa,4);if(cpa===this.currentCPA)
return;if(this.animator){this.animator.cancel();this.animator=null;}
let start=this.currentCPA;let delta=cpa-start;let grade,color,pColor;let duration=(this.screen.showing)?Math.sqrt(3.2*Math.abs(delta)):-1;this.log("DEBG",`updateCPA(): changing to ${cpa} in ${duration}s`);this.animator=new Animator(duration,this.timing,(t)=>{this.currentCPA=start+(delta*t);this.view.info.points.progress.bar.style.width=`${(this.currentCPA / 4) * 100}%`;this.view.info.points.progress.bar.value.point.innerText=this.currentCPA.toFixed(3);if(this.currentCPA>=3.6){grade="Xuất Xắc";color="yellow";}else if(this.currentCPA>=3.2){grade="Giỏi";color="green";}else if(this.currentCPA>=2.5){grade="Khá";color="blue";}else if(this.currentCPA>=2){grade="Trung Bình";color="orange";}else{grade="Yếu";color="red";}
let transform=0.5;if(this.currentCPA<0.7)
transform=1-scaleValue(this.currentCPA,[0,0.7],[0,0.5]);else if(this.currentCPA>3.5)
transform=4-this.currentCPA;this.view.info.points.progress.bar.value.style.transform=`translateX(${transform * 100}%)`;if(color!==pColor){this.view.info.points.progress.bar.value.grade.innerText=grade;this.view.info.points.progress.bar.value.grade.dataset.color=color;pColor=color;}});},reset(){this.loaded=false;emptyNode(this.view.table.tbody);this.view.info.stats.other.avg10.value.innerText="---";this.view.info.stats.other.credits.value.innerText="---";this.view.info.stats.grades.gradeA.value.innerText="0";this.view.info.stats.grades.gradeB.value.innerText="0";this.view.info.stats.grades.gradeC.value.innerText="0";this.view.info.stats.grades.gradeD.value.innerText="0";this.view.info.stats.grades.gradeF.value.innerText="0";this.view.info.stats.grades.gradeU.value.innerText="0";this.updateCPA(0);this.screen.set({subTitle:""});},onLogout(){this.reset();this.screen.overlay({icon:"signout",title:"Bạn Chưa Đăng Nhập",description:`Hãy đăng nhập vào CTMS để xem nội dung này!`,buttons:{login:{text:"ĐĂNG NHẬP",icon:"signin",onClick:()=>core.account.clickable.active=true}}});this.screen.loading=false;},async load(){if(!core.account.loggedIn){this.onLogout();return;}
try{this.screen.loading=true;await api.results();this.screen.loading=false;}catch(e){this.reset();this.screen.handleError(e,async()=>await this.load());this.screen.loading=false;}},getScanDates({year,semester,isK20=false,count=2}={}){let dates=[];if(semester===1){let dateDefault=(isK20&&year===2020)?new Date(`November 1, ${year}`):new Date(`September 12, ${year}`);dateDefault=new Date(dateDefault.setDate(dateDefault.getDate()-dateDefault.getDay()+1));for(let i=0;i<count;++i){dates.push(dateDefault);dateDefault=new Date(dateDefault.setDate(dateDefault.getDate()+7));}}else if(semester===2){let dateDefault1=new Date(`January 12, ${year}`);let dateDefault2=new Date(`March 3, ${year}`);dateDefault1=new Date(dateDefault1.setDate(dateDefault1.getDate()-dateDefault1.getDay()+1));dateDefault2=new Date(dateDefault2.setDate(dateDefault2.getDate()-dateDefault2.getDay()+1));if(count<3){dates.push(dateDefault1);dates.push(dateDefault2);}else if(count===3){for(let i=0;i<count-2;++i){dateDefault2=new Date(dateDefault2.setDate(dateDefault2.getDate()+7));dates.push(dateDefault2);}}else{let count2=Math.floor((count-2)/2);for(let i=0;i<count2;++i){dateDefault1=new Date(dateDefault1.setDate(dateDefault1.getDate()+7));dates.push(dateDefault1);}
for(let i=0;i<count-count2;++i){dateDefault2=new Date(dateDefault2.setDate(dateDefault2.getDate()+7));dates.push(dateDefault2);}}}else{let dateDefault=new Date(`July 7, ${year}`);dateDefault=new Date(dateDefault.setDate(dateDefault.getDate()-dateDefault.getDay()+1));for(let i=0;i<count;++i){dates.push(dateDefault);dateDefault=new Date(dateDefault.setDate(dateDefault.getDate()+7));}}
return dates;},async scan(){if(!this.currentData)
throw{code:22,description:`core.screen.results.scan(): no data available`}
if(api.HOST_NAME==="kinhte"){popup.show({windowTitle:"Kết Quả Học Tập",title:"Trình Quét Học Kì",icon:"search",message:"Quét Bị Hủy",description:"Trang của khoa Kinh Tế không cần xếp nhóm học kì nữa =))",headerTheme:"light",bgColor:"darkBlue",buttonList:{close:{text:"FIN 😥",color:"blue"}}});return;}
let groupingData=localStorage.getItem("results.grouping");groupingData=(groupingData)?JSON.parse(groupingData):[];let progress=createProgressBar({blink:"fade",progress:100});let cancelled=false;popup.show({windowTitle:"Kết Quả Học Tập",title:"Trình Quét Học Kì",icon:"search",message:"Đang khởi tạo...",description:"Trình quét hiện đang quét lịch học của bạn để xác định thời gian học cho các môn. Quá trình này có thể mất 1-2 phút.",customNode:progress.group,buttonList:{close:{text:"HỦY",color:"red"}}}).then((action)=>{if(action==="close")
cancelled=true;});if(!api.__SCHEDULE_VIEWSTATE){popup.message=`Đang lấy state của trang lịch học...`;await api.schedule();}
progress.set({progress:0,blink:"none"});let now=new Date();let startYear=parseInt("20"+core.account.userInfo.course.substring(0,2));let currentYear=now.getFullYear();this.log("DEBG","scan(): scanning year from ",startYear,"to",currentYear);let steps=0;let step=0;let list=[]
if(startYear===currentYear){list.push({year:startYear,semester:[1]});steps+=1;}else{for(let year=startYear;year<=currentYear;year++){let pos=list.push({year,semester:[]})-1;if(year===startYear)
list[pos].semester=[1]
else if(year===currentYear){if(now.getMonth()>-1)
list[pos].semester.push(2);if(now.getMonth()>3)
list[pos].semester.push(3);if(now.getMonth()>7)
list[pos].semester.push(1);}else
list[pos].semester=[2,3,1]
steps+=list[pos].semester.length;}}
steps*=this.scanPerSemester;this.log("DEBG",`scan(): scanning list (${steps} steps):`,list);for(let item of list){for(let semester of item.semester){let year=item.year;this.log("INFO",`scan(): scanning subjects of year ${year} semester ${semester}`);let isK20=startYear===2020;let dates=this.getScanDates({year,semester,isK20,count:this.scanPerSemester});for(let date of dates){if(cancelled)
return;step++;let dateString=humanReadableTime(date,{onlyDate:true});this.log("DEBG",`scan(): fetching ${dateString}`);popup.message=`Đang Quét ${year} HK${semester} (${dateString})`;progress.set({right:`${step}/${steps}`,progress:(step/steps)*100});let response=await api.schedule(date,{triggerEvents:false});let index;for(let i=0;i<groupingData.length;i++){if(groupingData[i].year===year&&groupingData[i].semester===semester){index=i;break;}}
if(typeof index!=="number"){index=groupingData.push({year,semester,classID:[]})-1;}
for(let day of response.info){for(let subject of day.rows){if(!groupingData[index].classID.includes(subject.classID))
groupingData[index].classID.push(subject.classID);}}
if(cancelled)
return;}}}
localStorage.setItem("results.grouping",JSON.stringify(groupingData));popup.hide();this.render(undefined,true);},clearGroupingData(){localStorage.removeItem("results.grouping");this.render(undefined,true);},group(list){list=[...list]
let groupingData=localStorage.getItem("results.grouping");groupingData=(groupingData)?JSON.parse(groupingData):[];let data={groups:[],other:undefined}
groupingData.push({classID:undefined});for(let groupData of groupingData){let results=[]
if(groupData.classID){for(let i=0;i<list.length;i++)
if(groupData.classID.includes(list[i].classID))
results.push(list.splice(i--,1)[0]);}else
results=list;let resultsData=api.processResults(results);if(groupData.classID){data.groups.push({year:groupData.year,semester:groupData.semester,average:resultsData.average,cpa:resultsData.cpa,grade:resultsData.grade,results});}else{data.other={year:undefined,semester:undefined,average:resultsData.average,cpa:resultsData.cpa,grade:resultsData.grade,results}}}
data.groups=data.groups.sort((a,b)=>{return((b.year*10)+[3,1,2][b.semester-1])
-((a.year*10)+[3,1,2][a.semester-1]);});return data;},render(data,force=false){if(!this.loaded)
return;let newData=false;if(typeof data==="object"&&data!==null){newData=true;this.currentData=data;}else
data=this.currentData;if(newData||force){this.log("DEBG",`render(): re-rendering`);emptyNode(this.view.table.tbody);this.screen.set({subTitle:data.info.mode});let groups=this.group(data.info.results);let count={A:0,B:0,C:0,D:0,F:0,U:0}
this.view.info.stats.other.avg10.value.innerText=data.info.average.toFixed(2);this.view.info.stats.other.credits.value.innerText=data.info.credits;this.updateCPA(data.info.cpa);for(let group of[...groups.groups,groups.other]){let headerLabel;if(group.year&&group.semester){let yearString=(group.semester===1)?`${group.year} - ${group.year + 1}`:`${group.year - 1} - ${group.year}`;headerLabel=`<b>HK${group.semester}</b> ${yearString}`;}else
headerLabel=`Chưa Phân Loại`;let header=makeTree("tr","header",{label:{tag:"td",class:"label",colSpan:11,child:{wrapper:{tag:"span",class:"wrapper",child:{inner:{tag:"t",class:"inner",html:headerLabel},...(group.cpa?{tags:{tag:"span",class:"tags",child:{cpa:{tag:"span",class:["item","parallelogram"],child:{label:{tag:"t",class:"label",text:"GPA"},value:{tag:"span",class:["parallelogram","value"],text:group.cpa.toFixed(2)}}},grade:{tag:"span",class:["item","parallelogram"],child:{label:{tag:"t",class:"label",text:"Xếp Loại"},value:{tag:"span",class:["parallelogram","value"],data:{grade:group.grade},text:group.grade}}}}}}:{})}}}},});this.view.table.tbody.appendChild(header);let nth=0;for(let result of group.results){this.addListItem(++nth,result);if(typeof result.average!=="number"||result.average==NaN){count.U++;continue;}
if(result.average>=8.5)count.A++;else if(result.average>=7.0)count.B++;else if(result.average>=5.5)count.C++;else if(result.average>=4.0)count.D++;else count.F++;}}
this.view.info.stats.grades.gradeA.value.innerText=count.A;this.view.info.stats.grades.gradeB.value.innerText=count.B;this.view.info.stats.grades.gradeC.value.innerText=count.C;this.view.info.stats.grades.gradeD.value.innerText=count.D;this.view.info.stats.grades.gradeF.value.innerText=count.F;this.view.info.stats.grades.gradeU.value.innerText=count.U;}},addListItem(stt,{subject,credits,classID,teacher,diemCC,diemDK,diemHK,rawAverage,average,grade,ignored,relearned}={}){let row=makeTree("tr",["item",(stt%2===0)?"even":"odd"],{stt:{tag:"td",class:["bold","right"],text:stt},subject:{tag:"td",text:subject},credits:{tag:"td",class:"right",text:credits},classID:{tag:"td",class:["bold","right"],text:classID},teacher:{tag:"td",text:teacher},diemCC:{tag:"td",class:"right",html:(typeof diemCC==="number")?diemCC.toFixed(2):((diemCC==="?")?`<span title="Chưa Xác Nhận">?</span>`:"")},diemDK:{tag:"td",class:"right",html:(typeof diemDK==="number")?diemDK.toFixed(2):((diemDK==="?")?`<span title="Chưa Xác Nhận">?</span>`:"")},diemHK:{tag:"td",class:"right",html:(typeof diemHK==="number")?diemHK.toFixed(2):((diemHK==="?")?`<span title="Chưa Xác Nhận">?</span>`:"")},average:{tag:"td",class:["right","bold"],...(average)?{text:average?average.toFixed(1):"",title:`raw score: ${rawAverage}`}:{text:""}},gradePoint:{tag:"td",class:["right","bold"],text:grade?grade.point.toFixed(1):""},gradeLetter:{tag:"td",class:"right",child:{inner:{tag:"span",class:"generalTag",data:{color:grade?grade.color:"none"},text:grade?grade.letter:"?"}}},});if(ignored||relearned){if(relearned){let relearnedBadge=document.createElement("span");relearnedBadge.classList.add("generalTag");relearnedBadge.dataset.color="orange";relearnedBadge.style.marginLeft="8px";relearnedBadge.innerText="Đã Học Lại";let tip=document.createElement("tip");tip.title="điểm của môn này không được tính do bạn đã học lại môn này";tip.style.marginLeft="8px";row.subject.append(relearnedBadge,tip);}else{let ignoredBadge=document.createElement("span");ignoredBadge.classList.add("generalTag");ignoredBadge.dataset.color="red";ignoredBadge.style.marginLeft="8px";ignoredBadge.innerText="Không Tính";row.subject.append(ignoredBadge);}}
this.view.table.tbody.appendChild(row);},settings:{initialized:false,group:smenu.Group.prototype,init(){if(this.initialized||!smenu.initialized)
return false;this.group=new smenu.Group({label:"kết quả học",icon:"poll",after:ScheduleScreen.settings.group});let grouping=new smenu.Child({label:"Sắp Xếp Nhóm"},this.group);new smenu.components.Slider({label:`Số tuần quét mỗi kì`,min:2,max:6,defaultValue:2,unit:"tuần",save:"results.scanPerSemester",toast:true,onChange:(v)=>ResultScreen.scanPerSemester=v},grouping);let data=new smenu.Child({label:"Dữ Liệu"},this.group);new smenu.components.Button({label:"xóa dữ liệu nhóm",color:"red",complex:true,onClick:()=>ResultScreen.clearGroupingData()},data);this.initialized=true;}},}
core.screen={...core.screen,results:ResultScreen}